<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBill - Professional Billing Software</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            /* Professional Color Palette */
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Gray Scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-xs: 0.75rem;    /* 12px */
            --font-size-sm: 0.875rem;   /* 14px */
            --font-size-base: 1rem;     /* 16px */
            --font-size-lg: 1.125rem;   /* 18px */
            --font-size-xl: 1.25rem;    /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 1.875rem; /* 30px */
            --font-size-4xl: 2.25rem;  /* 36px */
            --font-size-5xl: 3rem;     /* 48px */
            
            /* Spacing */
            --spacing-xs: 0.25rem;   /* 4px */
            --spacing-sm: 0.5rem;    /* 8px */
            --spacing-md: 1rem;      /* 16px */
            --spacing-lg: 1.5rem;    /* 24px */
            --spacing-xl: 2rem;      /* 32px */
            --spacing-2xl: 3rem;     /* 48px */
            --spacing-3xl: 4rem;     /* 64px */
            
            /* Border Radius */
            --radius-sm: 0.375rem;   /* 6px */
            --radius-md: 0.5rem;     /* 8px */
            --radius-lg: 0.75rem;    /* 12px */
            --radius-xl: 1rem;       /* 16px */
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            font-family: var(--font-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }

        body {
            background: var(--gray-50);
            color: var(--gray-900);
            font-size: var(--font-size-base);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* Typography Scale */
        h1 {
            font-size: var(--font-size-4xl);
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
            color: var(--gray-900);
            margin: 0;
        }

        h2 {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.01em;
            color: var(--gray-900);
            margin: 0;
        }

        h3 {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            line-height: 1.4;
            color: var(--gray-800);
            margin: 0;
        }

        h4 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            line-height: 1.4;
            color: var(--gray-800);
            margin: 0;
        }

        p {
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--gray-700);
            margin: 0;
        }

        /* Professional Gradient */
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, #1e3a8a 100%);
        }

        /* Card Styles */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        /* Sidebar Active State */
        .sidebar-active {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        /* Professional Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: var(--font-size-base);
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Professional Payment Options */
        .payment-option-btn {
            min-height: 70px;
        }

        .payment-option-btn.selected {
            background: #10b981 !important;
            border-color: #10b981 !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
        }

        .payment-option-btn.selected div {
            color: white !important;
        }

        .payment-option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .payment-option-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
            border-color: var(--gray-300) !important;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Input Fields */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: all 0.2s ease;
            background: white;
            font-family: var(--font-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg);
            transition: all 0.3s ease;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
            }
        }

        /* Animations */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Table Styles */
        .table-header {
            background: var(--gray-50);
            font-weight: 600;
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-700);
            padding: var(--spacing-md);
        }

        .table-cell {
            padding: var(--spacing-md);
            font-size: var(--font-size-base);
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Navigation */
        .nav-link {
            color: var(--gray-600);
            font-weight: 500;
            font-size: var(--font-size-base);
            transition: color 0.2s ease;
            text-decoration: none;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        /* Logo */
        .logo-text {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.02em;
        }

        /* Text Utilities */
        .text-muted {
            color: var(--gray-600);
            font-size: var(--font-size-base);
        }

        .text-small {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }

        /* Price Display */
        .price-display {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        class Store {
            constructor() {
                this.state = {
                    currentPage: 'home',
                    isLoggedIn: false,
                    cart: [],
                    selectedCustomer: null,
                    selectedCustomerForView: null, // For viewing customer invoices
                    discount: 0,
                    discountType: 'percentage', // 'percentage' or 'fixed'
                    heldOrders: JSON.parse(localStorage.getItem('heldOrders') || '[]'),
                    reportFilters: JSON.parse(localStorage.getItem('reportFilters') || 'null') || {
                        dateFrom: '',
                        dateTo: '',
                        paymentMethod: '',
                        customer: '',
                        orderType: 'all',
                        quickFilter: 'all'
                    },
                    customerFilters: JSON.parse(localStorage.getItem('customerFilters') || 'null') || {
                        status: '',
                        dateFrom: '',
                        dateTo: '',
                        purchaseAmountMin: '',
                        purchaseAmountMax: ''
                    },
                    customerSort: JSON.parse(localStorage.getItem('customerSort') || 'null') || {
                        field: 'totalSpent',
                        order: 'desc'
                    },
                    posFilters: JSON.parse(localStorage.getItem('posFilters') || 'null') || {
                        category: '',
                        stockStatus: '',
                        priceMin: '',
                        priceMax: '',
                        sortBy: 'name'
                    },
                    inventoryFilters: JSON.parse(localStorage.getItem('inventoryFilters') || 'null') || {
                        poStatus: '',
                        poDateFrom: '',
                        poDateTo: '',
                        poSupplier: '',
                        poAmountMin: '',
                        poAmountMax: '',
                        poSearch: '',
                        returnStatus: '',
                        returnType: '',
                        returnDateFrom: '',
                        returnDateTo: '',
                        returnCustomer: '',
                        returnAmountMin: '',
                        returnAmountMax: '',
                        returnSearch: ''
                    },
                    settings: JSON.parse(localStorage.getItem('settings')) || {
                        businessName: 'QuickBill',
                        logo: '',
                        taxRate: 10,
                        currency: 'INR'
                    }
                };
                this.listeners = [];
                this.initData();
            }

            initData() {
                if (!localStorage.getItem('products')) {
                    localStorage.setItem('products', JSON.stringify([
                        { id: 1, name: 'Laptop Pro 15"', sku: 'LAP001', category: 'Electronics', price: 1299.99, stock: 15, barcode: '1234567890123', image: 'ðŸ’»' },
                        { id: 2, name: 'Wireless Mouse', sku: 'MOU001', category: 'Accessories', price: 29.99, stock: 50, barcode: '1234567890124', image: 'ðŸ–±ï¸' },
                        { id: 3, name: 'Mechanical Keyboard', sku: 'KEY001', category: 'Accessories', price: 89.99, stock: 8, barcode: '1234567890125', image: 'âŒ¨ï¸' },
                        { id: 4, name: 'USB-C Hub', sku: 'HUB001', category: 'Accessories', price: 49.99, stock: 25, barcode: '1234567890126', image: 'ðŸ”Œ' },
                        { id: 5, name: 'Smartphone X', sku: 'PHO001', category: 'Electronics', price: 899.99, stock: 20, barcode: '1234567890127', image: 'ðŸ“±' },
                        { id: 6, name: 'Tablet Air', sku: 'TAB001', category: 'Electronics', price: 599.99, stock: 12, barcode: '1234567890128', image: 'ðŸ“±' },
                        { id: 7, name: 'Wireless Headphones', sku: 'HEAD001', category: 'Audio', price: 199.99, stock: 30, barcode: '1234567890129', image: 'ðŸŽ§' },
                        { id: 8, name: 'Smart Watch', sku: 'WAT001', category: 'Wearables', price: 349.99, stock: 18, barcode: '1234567890130', image: 'âŒš' },
                        { id: 9, name: 'External SSD 1TB', sku: 'SSD001', category: 'Storage', price: 149.99, stock: 5, barcode: '1234567890131', image: 'ðŸ’¾' },
                        { id: 10, name: 'Webcam HD', sku: 'CAM001', category: 'Accessories', price: 79.99, stock: 22, barcode: '1234567890132', image: 'ðŸ“·' }
                    ]));
                }

                if (!localStorage.getItem('customers')) {
                    localStorage.setItem('customers', JSON.stringify([
                        { id: 1, name: 'John Smith', email: 'john@email.com', phone: '555-0101', totalPurchases: 2450.50, lastPurchase: '2024-01-15' },
                        { id: 2, name: 'Sarah Johnson', email: 'sarah@email.com', phone: '555-0102', totalPurchases: 1230.00, lastPurchase: '2024-01-14' },
                        { id: 3, name: 'Mike Davis', email: 'mike@email.com', phone: '555-0103', totalPurchases: 3450.75, lastPurchase: '2024-01-13' },
                        { id: 4, name: 'Emily Brown', email: 'emily@email.com', phone: '555-0104', totalPurchases: 890.25, lastPurchase: '2024-01-12' },
                        { id: 5, name: 'David Wilson', email: 'david@email.com', phone: '555-0105', totalPurchases: 5230.00, lastPurchase: '2024-01-11' }
                    ]));
                }

                if (!localStorage.getItem('invoices')) {
                    localStorage.setItem('invoices', JSON.stringify([
                        { id: 'INV-001', date: '2024-01-15', customer: 'John Smith', items: [{ name: 'Laptop Pro 15"', qty: 1, price: 1299.99 }], subtotal: 1299.99, tax: 129.99, discount: 0, total: 1429.98, payment: 'Card', status: 'completed' },
                        { id: 'INV-002', date: '2024-01-14', customer: 'Sarah Johnson', items: [{ name: 'Wireless Mouse', qty: 2, price: 29.99 }, { name: 'USB-C Hub', qty: 1, price: 49.99 }], subtotal: 109.97, tax: 10.99, discount: 0, total: 120.96, payment: 'Cash', status: 'completed' },
                        { id: 'INV-003', date: '2024-01-13', customer: 'Mike Davis', items: [{ name: 'Smartphone X', qty: 1, price: 899.99 }], subtotal: 899.99, tax: 89.99, discount: 0, total: 989.98, payment: 'Card', status: 'completed' }
                    ]));
                }
                
                if (!localStorage.getItem('coupons')) {
                    localStorage.setItem('coupons', JSON.stringify([
                        { code: 'WELCOME10', discount: 10, type: 'percentage', valid: true },
                        { code: 'SAVE50', discount: 50, type: 'fixed', valid: true },
                        { code: 'SUMMER20', discount: 20, type: 'percentage', valid: true }
                    ]));
                }
                
                if (!localStorage.getItem('purchaseOrders')) {
                    localStorage.setItem('purchaseOrders', JSON.stringify([
                        { id: 'PO-001', date: '2024-01-10', supplier: 'Tech Supplies Inc', items: [{ name: 'Laptop Pro 15"', qty: 10, cost: 1000 }], total: 10000, status: 'completed' },
                        { id: 'PO-002', date: '2024-01-12', supplier: 'Accessories Co', items: [{ name: 'Wireless Mouse', qty: 50, cost: 20 }], total: 1000, status: 'pending' }
                    ]));
                }
                
                if (!localStorage.getItem('returns')) {
                    localStorage.setItem('returns', JSON.stringify([
                        { id: 'RET-001', invoiceId: 'INV-001', date: '2024-01-16', customer: 'John Smith', items: [{ name: 'Laptop Pro 15"', qty: 1, price: 1299.99, reason: 'Defective' }], total: 1299.99, status: 'completed', type: 'return' }
                    ]));
                }
            }

            subscribe(listener) { this.listeners.push(listener); }
            setState(newState) { this.state = { ...this.state, ...newState }; this.listeners.forEach(listener => listener(this.state)); }
            getState() { return this.state; }
            navigate(page) { this.setState({ currentPage: page }); window.scrollTo(0, 0); }
            login() { this.setState({ isLoggedIn: true, currentPage: 'dashboard' }); }
            logout() { this.setState({ isLoggedIn: false, currentPage: 'home' }); }
        }

        const store = new Store();

        function getCurrencySymbol() {
            const currency = store.getState().settings.currency;
            const symbols = { INR: 'â‚¹', USD: '$', EUR: 'â‚¬', GBP: 'Â£' };
            return symbols[currency] || currency + ' ';
        }

        function formatCurrency(amount) {
            return getCurrencySymbol() + amount.toFixed(2);
        }

        function MarketingHeader() {
            return `
                <header class="bg-white shadow-sm sticky top-0 z-50 no-print">
                    <nav class="container mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-receipt" style="font-size: 28px; color: var(--primary);"></i>
                                <span class="logo-text">QuickBill</span>
                            </div>
                            <div class="hidden md:flex space-x-8">
                                <a href="#" onclick="store.navigate('home')" class="nav-link">Home</a>
                                <a href="#" onclick="store.navigate('features')" class="nav-link">Features</a>
                                <a href="#" onclick="store.navigate('pricing')" class="nav-link">Pricing</a>
                                <a href="#" onclick="store.navigate('about')" class="nav-link">About</a>
                                <a href="#" onclick="store.navigate('contact')" class="nav-link">Contact</a>
                            </div>
                            <button onclick="store.login()" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login to POS
                            </button>
                        </div>
                    </nav>
                </header>
            `;
        }

        function HomePage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="gradient-bg text-white py-20">
                        <div class="container mx-auto px-6 text-center">
                            <h1 style="font-size: 3.5rem; font-weight: 800; color: white; margin-bottom: 1.5rem;">Professional Billing Software</h1>
                            <p style="font-size: 1.5rem; font-weight: 400; margin-bottom: 2.5rem; opacity: 0.95;">Streamline your business with our powerful, easy-to-use billing solution</p>
                            <div class="flex justify-center space-x-4">
                                <button onclick="store.login()" class="bg-white text-indigo-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition">
                                    Get Started Free
                                </button>
                                <button onclick="store.navigate('features')" class="border-2 border-white text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-white hover:text-indigo-600 transition">
                                    Learn More
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h2 class="text-4xl font-bold text-center mb-16 text-gray-800" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 4rem;">Why Choose QuickBill?</h2>
                            <div class="grid md:grid-cols-3 gap-8">
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-bolt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Lightning Fast</h3>
                                    <p class="text-gray-600">Process transactions in seconds with our optimized interface</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-chart-line text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Real-time Analytics</h3>
                                    <p class="text-gray-600">Track sales, inventory, and customer insights instantly</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-mobile-alt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Fully Responsive</h3>
                                    <p class="text-gray-600">Works seamlessly on desktop, tablet, and mobile devices</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-users text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Customer Management</h3>
                                    <p class="text-gray-600">Build lasting relationships with comprehensive customer profiles</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-boxes text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Inventory Control</h3>
                                    <p class="text-gray-600">Never run out of stock with automated alerts and tracking</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-shield-alt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Secure & Reliable</h3>
                                    <p class="text-gray-600">Your data is protected with industry-leading security</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-gray-100">
                        <div class="container mx-auto px-6">
                            <div class="grid md:grid-cols-4 gap-8 text-center">
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">10,000+</div>
                                    <div class="text-gray-600">Active Users</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">â‚¹400Cr+</div>
                                    <div class="text-gray-600">Processed Sales</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">99.9%</div>
                                    <div class="text-gray-600">Uptime</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">24/7</div>
                                    <div class="text-gray-600">Support</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h2 class="text-4xl font-bold text-center mb-16 text-gray-800">What Our Customers Say</h2>
                            <div class="grid md:grid-cols-3 gap-8">
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">JS</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Jane Smith</div>
                                            <div class="text-sm text-gray-600">Retail Store Owner</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700" style="font-size: 15px; line-height: 1.7;">"QuickBill transformed our business! The interface is intuitive and our checkout time has been cut in half."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">RC</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Robert Chen</div>
                                            <div class="text-sm text-gray-600">Restaurant Manager</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700">"The inventory management features are outstanding. We always know what's in stock and what needs to be ordered."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">ML</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Maria Lopez</div>
                                            <div class="text-sm text-gray-600">Boutique Owner</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700">"Best POS system I've used. The customer management features help us build better relationships with our clients."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="gradient-bg text-white py-20">
                        <div class="container mx-auto px-6 text-center">
                            <h2 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem; color: white;">Ready to Get Started?</h2>
                            <p style="font-size: 1.25rem; margin-bottom: 2rem; opacity: 0.95; color: white;">Join thousands of businesses using QuickBill</p>
                            <button onclick="store.login()" class="bg-white text-indigo-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition">
                                Start Your Free Trial
                            </button>
                        </div>
                    </section>

                    ${Footer()}
                </main>
            `;
        }

        function FeaturesPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Powerful Features</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">Everything you need to run your business efficiently</p>
                            <div class="space-y-16">
                                <div class="flex flex-col md:flex-row items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-shopping-cart text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Fast Checkout</h2>
                                        <p class="text-gray-600 mb-4">Process sales quickly with our intuitive checkout interface. Add items with a click, apply discounts, and accept multiple payment methods.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Quick product search</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Barcode scanning support</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Multiple payment methods</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Automatic tax calculation</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-receipt text-9xl text-indigo-600"></i>
                                    </div>
                                </div>

                                <div class="flex flex-col md:flex-row-reverse items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-chart-bar text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Analytics Dashboard</h2>
                                        <p class="text-gray-600 mb-4">Get real-time insights into your business performance with comprehensive analytics and beautiful charts.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Sales trends and forecasting</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Top-selling products</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Customer insights</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Inventory analytics</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-chart-line text-9xl text-indigo-600"></i>
                                    </div>
                                </div>

                                <div class="flex flex-col md:flex-row items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-warehouse text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Inventory Management</h2>
                                        <p class="text-gray-600 mb-4">Keep track of your stock levels, get low-stock alerts, and manage products effortlessly.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Real-time stock tracking</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Low-stock notifications</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Category management</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Bulk import/export</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-boxes text-9xl text-indigo-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function PricingPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Simple, Transparent Pricing</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">Choose the plan that fits your business</p>
                            <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                                <div class="border-2 border-gray-200 rounded-lg p-8 card-hover">
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Starter</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹2,499<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Up to 100 products</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>1 user account</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Basic reports</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Email support</li>
                                    </ul>
                                    <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Get Started</button>
                                </div>

                                <div class="border-2 border-indigo-600 rounded-lg p-8 card-hover relative">
                                    <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-4 py-1 rounded-full text-sm">Popular</div>
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Professional</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹6,499<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Unlimited products</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>5 user accounts</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Advanced analytics</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Priority support</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Custom branding</li>
                                    </ul>
                                    <button class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Get Started</button>
                                </div>

                                <div class="border-2 border-gray-200 rounded-lg p-8 card-hover">
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Enterprise</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹15,999<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Everything in Pro</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Unlimited users</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Multi-location</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>API access</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>24/7 phone support</li>
                                    </ul>
                                    <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Contact Sales</button>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function AboutPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800" style="font-size: 3rem; font-weight: 700;">About QuickBill</h1>
                            <p class="text-xl text-center text-gray-600 mb-16 max-w-3xl mx-auto" style="font-size: 1.125rem;">We're on a mission to make billing systems accessible, powerful, and easy to use for businesses of all sizes.</p>
                            <div class="max-w-4xl mx-auto space-y-12">
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Our Story</h2>
                                    <p class="text-gray-600 leading-relaxed" style="font-size: 16px; line-height: 1.8;">Founded in 2020, QuickBill was born from the frustration of using outdated, complicated billing systems. We believed there had to be a better way â€“ something modern, intuitive, and built for today's businesses.</p>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Our Mission</h2>
                                    <p class="text-gray-600 leading-relaxed" style="font-size: 16px; line-height: 1.8;">To empower businesses with technology that simplifies operations, provides actionable insights, and helps them grow. We believe every business deserves access to enterprise-level tools without the enterprise-level complexity.</p>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Our Values</h2>
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800">Simplicity</h3>
                                            <p class="text-gray-600">We design for clarity and ease of use</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800">Innovation</h3>
                                            <p class="text-gray-600">We're always improving and evolving</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800">Reliability</h3>
                                            <p class="text-gray-600">Your business can count on us</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800">Support</h3>
                                            <p class="text-gray-600">We're here when you need us</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function ContactPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Contact Us</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">We'd love to hear from you</p>
                            <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-12">
                                <div>
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Get in Touch</h2>
                                    <div class="space-y-6">
                                        <div class="flex items-start">
                                            <i class="fas fa-map-marker-alt text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Address</div>
                                                <div class="text-gray-600">123 Business Street<br>San Francisco, CA 94105</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-phone text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Phone</div>
                                                <div class="text-gray-600">+1 (555) 123-4567</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-envelope text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Email</div>
                                                <div class="text-gray-600">support@smartpos.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-clock text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Hours</div>
                                                <div class="text-gray-600">Mon-Fri: 9AM - 6PM PST<br>Sat-Sun: Closed</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <form class="space-y-4" onsubmit="event.preventDefault(); alert('Thank you for your message! (Demo only)');">
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Name</label>
                                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Email</label>
                                            <input type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Subject</label>
                                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Message</label>
                                            <textarea rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required></textarea>
                                        </div>
                                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                            Send Message
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function Footer() {
            return `
                <footer class="bg-gray-900 text-white py-12">
                    <div class="container mx-auto px-6">
                        <div class="grid md:grid-cols-4 gap-8">
                            <div>
                                <div class="flex items-center space-x-3 mb-4">
                                    <i class="fas fa-receipt" style="font-size: 24px;"></i>
                                    <span class="logo-text" style="color: white;">QuickBill</span>
                                </div>
                                <p class="text-gray-400" style="font-size: 15px;">Modern billing system for modern businesses.</p>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Product</h3>
                                <ul class="space-y-2 text-gray-400">
                                    <li><a href="#" onclick="store.navigate('features')" class="hover:text-white transition">Features</a></li>
                                    <li><a href="#" onclick="store.navigate('pricing')" class="hover:text-white transition">Pricing</a></li>
                                    <li><a href="#" class="hover:text-white transition">Security</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Company</h3>
                                <ul class="space-y-2 text-gray-400">
                                    <li><a href="#" onclick="store.navigate('about')" class="hover:text-white transition">About</a></li>
                                    <li><a href="#" onclick="store.navigate('contact')" class="hover:text-white transition">Contact</a></li>
                                    <li><a href="#" class="hover:text-white transition">Careers</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Connect</h3>
                                <div class="flex space-x-4 text-2xl">
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-linkedin"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                            <p>&copy; 2024 SmartPOS. All rights reserved.</p>
                        </div>
                    </div>
                </footer>
            `;
        }

        function POSSidebar() {
            const currentPage = store.getState().currentPage;
            return `
                <aside class="w-64 bg-white border-r border-gray-200 h-screen sticky top-0 no-print">
                    <div class="p-6">
                                <div class="flex items-center space-x-3 mb-8">
                            <i class="fas fa-receipt" style="font-size: 32px; color: var(--primary);"></i>
                            <span class="logo-text">QuickBill</span>
                        </div>
                        <nav class="space-y-2">
                            <a href="#" onclick="store.navigate('dashboard')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'dashboard' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                            <a href="#" onclick="store.navigate('pos')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'pos' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-shopping-cart"></i>
                                <span>POS / Checkout</span>
                            </a>
                            <a href="#" onclick="store.navigate('products')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'products' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-box"></i>
                                <span>Products</span>
                            </a>
                            <a href="#" onclick="store.navigate('inventory')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'inventory' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-warehouse"></i>
                                <span>Inventory</span>
                            </a>
                            <a href="#" onclick="store.navigate('customers')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'customers' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-users"></i>
                                <span>Customers</span>
                            </a>
                            <a href="#" onclick="store.navigate('invoices')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'invoices' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-file-invoice"></i>
                                <span>Invoices</span>
                            </a>
                            <a href="#" onclick="store.navigate('reports')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'reports' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                            <a href="#" onclick="store.navigate('settings')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'settings' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <a href="#" onclick="store.logout()" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 transition">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </nav>
                    </div>
                </aside>
            `;
        }

        function Dashboard() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate today's sales
            const todaySales = invoices
                .filter(inv => inv.date === today)
                .reduce((sum, inv) => sum + inv.total, 0);
            
            // Count today's invoices
            const todayInvoices = invoices.filter(inv => inv.date === today).length;
            
            // Total customers
            const totalCustomers = customers.length;
            
            const totalSales = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const lowStock = products.filter(p => p.stock < 10).length;
            const topProducts = [...products].sort((a, b) => b.stock - a.stock).slice(0, 5);
            const lowStockProducts = products.filter(p => p.stock < 10);

            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-gray-800" id="dashboardDate"></div>
                                <div class="text-sm text-gray-600" id="dashboardTime"></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Today's Sales</p>
                                        <p class="text-2xl font-bold text-gray-800">${formatCurrency(todaySales)}</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl text-green-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Total Customers</p>
                                        <p class="text-2xl font-bold text-gray-800">${totalCustomers}</p>
                                    </div>
                                    <i class="fas fa-users text-3xl text-blue-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Today's Invoices</p>
                                        <p class="text-2xl font-bold text-gray-800">${todayInvoices}</p>
                                    </div>
                                    <i class="fas fa-file-invoice text-3xl text-purple-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Low Stock Items</p>
                                        <p class="text-2xl font-bold text-gray-800">${lowStock}</p>
                                    </div>
                                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                            <div class="relative">
                                <input type="text" id="dashboardProductSearch" placeholder="Search products or scan barcode..." class="input-field" onkeypress="handleDashboardSearch(event)" style="padding-right: 45px;">
                                <button type="button" onclick="handleDashboardSearchClick()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                    <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Top Products</h2>
                                <div class="space-y-3">
                                    ${topProducts.map(p => `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">${p.image}</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">${p.name}</div>
                                                    <div class="text-sm text-gray-600">${p.category}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold text-gray-800">${formatCurrency(p.price)}</div>
                                                <div class="text-sm text-gray-600">Stock: ${p.stock}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                    Low Stock Alert
                                </h2>
                                <div class="space-y-3">
                                    ${lowStockProducts.length > 0 ? lowStockProducts.map(p => `
                                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">${p.image}</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">${p.name}</div>
                                                    <div class="text-sm text-gray-600">${p.category}</div>
                                                </div>
                                            </div>
                                            <div class="text-red-600 font-bold">
                                                ${p.stock} left
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-600 text-center py-8">All products are well stocked! ðŸŽ‰</p>'}
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm mt-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Recent Invoices</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Invoice ID</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Customer</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Total</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${invoices.slice(-5).reverse().map(inv => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-gray-800">${inv.id}</td>
                                                <td class="px-4 py-3 text-gray-800">${inv.customer}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.date}</td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(inv.total)}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">${inv.payment}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function POSPage() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const cart = store.getState().cart;
            const settings = store.getState().settings;
            const selectedCustomer = store.getState().selectedCustomer;
            const discount = store.getState().discount || 0;
            const discountType = store.getState().discountType || 'percentage';
            const heldOrders = store.getState().heldOrders || [];
            const categories = [...new Set(products.map(p => p.category))];
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = (subtotal * discount) / 100;
            } else {
                discountAmount = discount;
            }
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const tax = afterDiscount * (settings.taxRate / 100);
            const total = afterDiscount + tax;

            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">POS / Checkout</h1>
                            <div class="flex gap-2">
                                <button onclick="showHeldOrders()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-bookmark mr-2"></i>Held Orders (${heldOrders.length})
                                </button>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2">
                                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                                    <div class="mb-4 relative">
                                        <input type="text" id="productSearch" placeholder="Search products or scan barcode..." class="input-field" oninput="filterProducts(this.value)" style="padding-right: 45px;">
                                        <button type="button" onclick="scanBarcode()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                            <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                        </button>
                                </div>
                                </div>
                                <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-[600px] overflow-y-auto">
                                    ${products.map(p => `
                                        <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                                            <div style="font-size: 48px; margin-bottom: 12px; text-align: center;">${p.image}</div>
                                            <div style="font-weight: 600; font-size: 15px; color: var(--gray-900); margin-bottom: 4px;">${p.name}</div>
                                            <div class="text-small" style="margin-bottom: 8px;">${p.category}</div>
                                            <div class="price-display" style="font-size: 1.25rem;">${formatCurrency(p.price)}</div>
                                            <div class="text-small" style="margin-top: 4px;">Stock: ${p.stock}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm h-fit sticky top-8">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Current Order</h2>
                                
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Discount / Coupon</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="couponCode" placeholder="Enter coupon code" class="input-field flex-1" style="padding: 8px;">
                                        <button onclick="applyCoupon()" class="btn btn-primary" style="padding: 8px 16px;">
                                            <i class="fas fa-tag"></i>
                                        </button>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <input type="number" id="discountValue" placeholder="Discount" value="${discount}" class="input-field" style="padding: 8px; width: 60%;" onchange="setDiscount(this.value)">
                                        <select id="discountType" class="input-field" style="padding: 8px; width: 40%;" onchange="setDiscountType(this.value)">
                                            <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>%</option>
                                            <option value="fixed" ${discountType === 'fixed' ? 'selected' : ''}>Fixed</option>
                                        </select>
                                    </div>
                                    ${discount > 0 ? `<button onclick="removeDiscount()" class="mt-2 text-sm text-red-600 hover:text-red-800"><i class="fas fa-times mr-1"></i>Remove Discount</button>` : ''}
                                </div>

                                <div class="space-y-3 mb-6 max-h-[300px] overflow-y-auto">
                                    ${cart.length === 0 ? '<p class="text-muted text-center py-8" style="font-size: 15px;">Cart is empty</p>' : ''}
                                    ${cart.map((item, index) => `
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div class="flex-1">
                                                <div style="font-weight: 600; font-size: 15px; color: var(--gray-900);">${item.name}</div>
                                                <div class="text-small">${formatCurrency(item.price)} x ${item.qty}</div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="updateCartQty(${index}, -1)" style="width: 32px; height: 32px; background: var(--gray-200); border-radius: 6px; border: none; cursor: pointer; font-weight: 600;" onmouseover="this.style.background='var(--gray-300)';" onmouseout="this.style.background='var(--gray-200)';">-</button>
                                                <span style="width: 40px; text-align: center; font-weight: 600; font-size: 15px;">${item.qty}</span>
                                                <button onclick="updateCartQty(${index}, 1)" style="width: 32px; height: 32px; background: var(--gray-200); border-radius: 6px; border: none; cursor: pointer; font-weight: 600;" onmouseover="this.style.background='var(--gray-300)';" onmouseout="this.style.background='var(--gray-200)';">+</button>
                                                <button onclick="removeFromCart(${index})" style="width: 32px; height: 32px; background: var(--danger); color: white; border-radius: 6px; border: none; cursor: pointer; margin-left: 8px; font-weight: 600;" onmouseover="this.style.background='#dc2626';" onmouseout="this.style.background='var(--danger)';">Ã—</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="border-top: 1.5px solid var(--gray-200); padding-top: 1.5rem;">
                                    <div class="flex justify-between text-muted mb-2" style="font-size: 15px;">
                                        <span>Subtotal</span>
                                        <span>${formatCurrency(subtotal)}</span>
                                    </div>
                                    ${discountAmount > 0 ? `
                                        <div class="flex justify-between text-green-600 mb-2" style="font-size: 15px; font-weight: 600;">
                                            <span>Discount ${discountType === 'percentage' ? `(${discount}%)` : ''}</span>
                                            <span>-${formatCurrency(discountAmount)}</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex justify-between text-muted mb-4" style="font-size: 15px;">
                                        <span>Tax (${settings.taxRate}%)</span>
                                        <span>${formatCurrency(tax)}</span>
                                    </div>
                                    <div class="flex justify-between pt-4 border-t-2" style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">
                                        <span>Total</span>
                                        <span>${formatCurrency(total)}</span>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem;">Payment Methods</h3>
                                    <div class="grid grid-cols-2 gap-2 mb-4">
                                        <button onclick="selectPaymentMethod('Cash', this)" class="payment-option-btn" data-payment="Cash" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-money-bill-wave"></i></div>
                                            <div>Cash</div>
                                    </button>
                                        <button onclick="selectPaymentMethod('Card', this)" class="payment-option-btn" data-payment="Card" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-credit-card"></i></div>
                                            <div>Card</div>
                                    </button>
                                        <button onclick="selectPaymentMethod('UPI', this)" class="payment-option-btn" data-payment="UPI" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-qrcode"></i></div>
                                            <div>UPI</div>
                                        </button>
                                        <button onclick="selectPaymentMethod('Credit Note', this)" class="payment-option-btn" data-payment="Credit Note" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-file-invoice"></i></div>
                                            <div>Credit Note</div>
                                    </button>
                                    </div>
                                    <div class="space-y-2 mt-4">
                                        <button onclick="showReturnExchangeModal()" class="w-full" style="background: white; border: 2px solid var(--info); color: var(--info); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='var(--info)'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='var(--info)';">
                                            <i class="fas fa-exchange-alt"></i>Return / Exchange
                                        </button>
                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="holdOrder()" class="w-full" style="background: white; border: 2px solid var(--warning); color: var(--warning); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;" ${cart.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onmouseover="if(!this.disabled) {this.style.background='var(--warning)'; this.style.color='white';}" onmouseout="if(!this.disabled) {this.style.background='white'; this.style.color='var(--warning)';}">
                                                <i class="fas fa-bookmark"></i>Hold
                                            </button>
                                            <button onclick="clearCart()" class="w-full" style="background: white; border: 2px solid var(--gray-400); color: var(--gray-600); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;" ${cart.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onmouseover="if(!this.disabled) {this.style.background='var(--gray-200)'; this.style.borderColor='var(--gray-500)';}" onmouseout="if(!this.disabled) {this.style.background='white'; this.style.borderColor='var(--gray-400)';}">
                                                <i class="fas fa-trash"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function ProductsPage() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Products</h1>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="mb-4 relative">
                                <input type="text" id="searchProducts" placeholder="Search products or scan barcode..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterProductsList(this.value)" style="padding-right: 45px;">
                                <button type="button" onclick="scanBarcodeForProducts()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                    <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="productsTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Product</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">SKU</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Category</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Price</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Stock</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Barcode</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${products.map(p => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center space-x-3">
                                                        <span class="text-2xl">${p.image}</span>
                                                        <span class="font-semibold text-gray-800">${p.name}</span>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-gray-600">${p.sku}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${p.category}</span></td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(p.price)}</td>
                                                <td class="px-4 py-3">
                                                    <span class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-800'}">${p.stock}</span>
                                                    ${p.stock < 10 ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>' : ''}
                                                </td>
                                                <td class="px-4 py-3 text-gray-600 text-sm">${p.barcode}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function CustomersPage() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const selectedCustomerId = store.getState().selectedCustomerForView || null;
            const selectedCustomer = selectedCustomerId ? customers.find(c => c.id === selectedCustomerId) : null;
            const customerInvoices = selectedCustomer ? invoices.filter(inv => {
                // Match by customer name or phone
                return inv.customer === selectedCustomer.name || inv.customerPhone === selectedCustomer.phone;
            }) : [];
            const selectedCustomerStatus = selectedCustomer ? getCustomerStatus(selectedCustomer.totalPurchases) : null;
            
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            // Calculate orders, avg order value, last purchase date for each customer
            let customersWithStats = customers.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Customers</h1>
                            ${selectedCustomer ? `
                                <button onclick="clearCustomerSelection()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-times mr-2"></i>Clear Selection
                            </button>
                            ` : ''}
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div class="mb-4">
                                <input type="text" id="customerSearch" placeholder="Search customers..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterCustomersList(this.value)">
                            </div>
                            
                            <!-- Filters and Sort Section -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-bold text-gray-800">Filters & Sort</h3>
                                    <div class="flex gap-3">
                                        <button onclick="clearCustomerFilters()" class="text-sm text-gray-600 hover:text-gray-800 font-medium">
                                            <i class="fas fa-times mr-1"></i>Clear All
                                        </button>
                                        <button onclick="exportCustomersToCSV()" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">
                                            <i class="fas fa-download mr-1"></i>Export CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-end gap-3">
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Status</label>
                                        <select id="filterStatus" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerFilter('status', this.value)">
                                            <option value="">All Status</option>
                                            <option value="New Customer" ${filters.status === 'New Customer' ? 'selected' : ''}>New Customer</option>
                                            <option value="Regular Customer" ${filters.status === 'Regular Customer' ? 'selected' : ''}>Regular Customer</option>
                                            <option value="VIP Customer" ${filters.status === 'VIP Customer' ? 'selected' : ''}>VIP Customer</option>
                                        </select>
                                    </div>
                                    <div class="flex-1 min-w-[140px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Date From</label>
                                        <input type="date" id="filterDateFrom" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.dateFrom}" onchange="setCustomerFilter('dateFrom', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[140px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Date To</label>
                                        <input type="date" id="filterDateTo" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.dateTo}" onchange="setCustomerFilter('dateTo', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Min Amount</label>
                                        <input type="number" id="filterAmountMin" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Min" value="${filters.purchaseAmountMin}" onchange="setCustomerFilter('purchaseAmountMin', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Max Amount</label>
                                        <input type="number" id="filterAmountMax" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Max" value="${filters.purchaseAmountMax}" onchange="setCustomerFilter('purchaseAmountMax', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[130px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Sort By</label>
                                        <select id="sortField" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerSort('field', this.value)">
                                            <option value="totalSpent" ${sort.field === 'totalSpent' ? 'selected' : ''}>Total Spent</option>
                                            <option value="lastPurchase" ${sort.field === 'lastPurchase' ? 'selected' : ''}>Last Purchase</option>
                                            <option value="invoiceCount" ${sort.field === 'invoiceCount' ? 'selected' : ''}>Invoice Count</option>
                                            <option value="ltv" ${sort.field === 'ltv' ? 'selected' : ''}>Lifetime Value</option>
                                        </select>
                                    </div>
                                    <div class="flex-1 min-w-[130px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Order</label>
                                        <select id="sortOrder" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerSort('order', this.value)">
                                            <option value="desc" ${sort.order === 'desc' ? 'selected' : ''}>Descending</option>
                                            <option value="asc" ${sort.order === 'asc' ? 'selected' : ''}>Ascending</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3 flex justify-between items-center">
                                    <div class="text-xs text-gray-600">
                                        Showing ${customersWithStats.length} of ${customers.length} customers
                                    </div>
                                    <button onclick="applyCustomerFilters()" class="btn btn-primary" style="padding: 8px 20px; font-size: 14px;">
                                        <i class="fas fa-check mr-2"></i>Apply
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="customersTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">CUSTOMER</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">CONTACT</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">INVOICES</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">TOTAL SPENT</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">AVG ORDER VALUE</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">STATUS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200" id="customersList">
                                        ${customersWithStats.map(c => {
                                            const status = getCustomerStatus(c.totalPurchases);
                                            const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase();
                                            return `
                                            <tr class="hover:bg-gray-50 transition cursor-pointer ${selectedCustomerId === c.id ? 'bg-indigo-50' : ''}" onclick="selectCustomerForView(${c.id})">
                                                <td class="px-4 py-4">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-sm">
                                                            ${initials}
                                                </div>
                                                <div>
                                                            <div class="font-semibold text-gray-800">${c.name}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm text-gray-600">${c.email}</div>
                                                    <div class="text-sm text-gray-600">${c.phone}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${c.ordersCount}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.totalPurchases)}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.avgOrderValue)}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <span class="px-3 py-1 ${status.color} rounded-full text-xs font-semibold">
                                                        ${status.label}
                                                    </span>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ${selectedCustomer ? (() => {
                            // Calculate analytics
                            const sortedInvoices = [...customerInvoices].sort((a, b) => new Date(a.date) - new Date(b.date));
                            const ltv = selectedCustomer.totalPurchases;
                            
                            // Last purchase date and days since
                            const lastPurchaseDate = sortedInvoices.length > 0 ? sortedInvoices[sortedInvoices.length - 1].date : selectedCustomer.lastPurchase;
                            const daysSinceLastPurchase = lastPurchaseDate ? Math.floor((new Date() - new Date(lastPurchaseDate)) / (1000 * 60 * 60 * 24)) : null;
                            
                            // Purchase frequency (average days between orders)
                            let avgDaysBetweenOrders = null;
                            if (sortedInvoices.length > 1) {
                                const daysBetween = [];
                                for (let i = 1; i < sortedInvoices.length; i++) {
                                    const days = Math.floor((new Date(sortedInvoices[i].date) - new Date(sortedInvoices[i-1].date)) / (1000 * 60 * 60 * 24));
                                    daysBetween.push(days);
                                }
                                avgDaysBetweenOrders = Math.round(daysBetween.reduce((a, b) => a + b, 0) / daysBetween.length);
                            }
                            
                            // Growth trend
                            let growthTrend = 'stable';
                            let growthPercentage = 0;
                            if (sortedInvoices.length >= 2) {
                                const firstHalf = sortedInvoices.slice(0, Math.floor(sortedInvoices.length / 2));
                                const secondHalf = sortedInvoices.slice(Math.floor(sortedInvoices.length / 2));
                                const firstHalfAvg = firstHalf.reduce((sum, inv) => sum + inv.total, 0) / firstHalf.length;
                                const secondHalfAvg = secondHalf.reduce((sum, inv) => sum + inv.total, 0) / secondHalf.length;
                                if (firstHalfAvg > 0) {
                                    growthPercentage = ((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100;
                                    growthTrend = growthPercentage > 5 ? 'increasing' : growthPercentage < -5 ? 'decreasing' : 'stable';
                                }
                            }
                            
                            // Preferred payment method
                            const paymentMethods = {};
                            customerInvoices.forEach(inv => {
                                paymentMethods[inv.payment] = (paymentMethods[inv.payment] || 0) + 1;
                            });
                            const preferredPayment = Object.keys(paymentMethods).length > 0 
                                ? Object.keys(paymentMethods).reduce((a, b) => paymentMethods[a] > paymentMethods[b] ? a : b)
                                : 'N/A';
                            
                            return `
                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Customer Analytics</h2>
                                <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4">
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Lifetime Value</div>
                                            <i class="fas fa-chart-line text-blue-600"></i>
                                        </div>
                                        <div class="text-2xl font-bold text-blue-900">${formatCurrency(ltv)}</div>
                                        <div class="text-xs text-blue-600 mt-1">Total revenue</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-green-700 uppercase tracking-wide">Purchase Frequency</div>
                                            <i class="fas fa-calendar-alt text-green-600"></i>
                                        </div>
                                        <div class="text-2xl font-bold text-green-900">
                                            ${avgDaysBetweenOrders !== null ? avgDaysBetweenOrders + ' days' : 'N/A'}
                                        </div>
                                        <div class="text-xs text-green-600 mt-1">Avg between orders</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-purple-700 uppercase tracking-wide">Last Purchase</div>
                                            <i class="fas fa-clock text-purple-600"></i>
                                        </div>
                                        <div class="text-lg font-bold text-purple-900">${lastPurchaseDate || 'N/A'}</div>
                                        <div class="text-xs text-purple-600 mt-1">
                                            ${daysSinceLastPurchase !== null ? daysSinceLastPurchase + ' days ago' : 'No purchases'}
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br ${growthTrend === 'increasing' ? 'from-emerald-50 to-emerald-100 border-emerald-200' : growthTrend === 'decreasing' ? 'from-red-50 to-red-100 border-red-200' : 'from-gray-50 to-gray-100 border-gray-200'} p-4 rounded-lg border">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold ${growthTrend === 'increasing' ? 'text-emerald-700' : growthTrend === 'decreasing' ? 'text-red-700' : 'text-gray-700'} uppercase tracking-wide">Growth Trend</div>
                                            <i class="fas ${growthTrend === 'increasing' ? 'fa-arrow-up text-emerald-600' : growthTrend === 'decreasing' ? 'fa-arrow-down text-red-600' : 'fa-minus text-gray-600'}"></i>
                                        </div>
                                        <div class="text-2xl font-bold ${growthTrend === 'increasing' ? 'text-emerald-900' : growthTrend === 'decreasing' ? 'text-red-900' : 'text-gray-900'}">
                                            ${growthTrend === 'increasing' ? 'â†—' : growthTrend === 'decreasing' ? 'â†˜' : 'â†’'} ${Math.abs(growthPercentage).toFixed(1)}%
                                        </div>
                                        <div class="text-xs ${growthTrend === 'increasing' ? 'text-emerald-600' : growthTrend === 'decreasing' ? 'text-red-600' : 'text-gray-600'} mt-1 capitalize">${growthTrend}</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-lg border border-indigo-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-indigo-700 uppercase tracking-wide">Preferred Payment</div>
                                            <i class="fas fa-credit-card text-indigo-600"></i>
                                        </div>
                                        <div class="text-lg font-bold text-indigo-900">${preferredPayment}</div>
                                        <div class="text-xs text-indigo-600 mt-1">
                                            ${paymentMethods[preferredPayment] || 0} of ${customerInvoices.length} invoices
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="mb-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h2 class="text-xl font-bold text-gray-800">Invoices for ${selectedCustomer.name}</h2>
                                        <span class="px-3 py-1 ${selectedCustomerStatus.color} rounded-full text-sm font-semibold">
                                            <i class="fas ${selectedCustomerStatus.icon} mr-1"></i>${selectedCustomerStatus.label}
                                        </span>
                                    </div>
                                                    <div class="text-sm text-gray-600">
                                        <span><i class="fas fa-envelope mr-1"></i>${selectedCustomer.email}</span>
                                        <span class="ml-4"><i class="fas fa-phone mr-1"></i>${selectedCustomer.phone}</span>
                                        <span class="ml-4"><i class="fas fa-shopping-cart mr-1"></i>Total: ${formatCurrency(selectedCustomer.totalPurchases)}</span>
                                                    </div>
                                                </div>
                            `;
                        })() : ''}
                        ${selectedCustomer ? `
                                ${customerInvoices.length > 0 ? `
                                    <div class="space-y-3 max-h-[600px] overflow-y-auto">
                                        ${customerInvoices.map(inv => `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div class="font-semibold text-gray-800">${inv.id}</div>
                                                        <div class="text-sm text-gray-600">${inv.date}</div>
                                            </div>
                                            <div class="text-right">
                                                        <div class="font-bold text-indigo-600">${formatCurrency(inv.total)}</div>
                                                        <span class="px-2 py-1 ${inv.payment === 'Cash' ? 'bg-green-100 text-green-800' : inv.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : inv.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs">${inv.payment}</span>
                                            </div>
                                        </div>
                                                <div class="text-sm text-gray-600 mt-2">
                                                    ${inv.items.length} item${inv.items.length > 1 ? 's' : ''}
                                                    ${inv.discount > 0 ? ` â€¢ Discount: ${formatCurrency(inv.discount)}` : ''}
                                                </div>
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="viewInvoice('${inv.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px; flex: 1;">
                                                        <i class="fas fa-eye mr-1"></i>View
                                                    </button>
                                                    <button onclick="printInvoice('${inv.id}')" class="btn" style="background: var(--gray-200); color: var(--gray-800); padding: 6px 12px; font-size: 14px;">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                </div>
                                    </div>
                                `).join('')}
                            </div>
                                ` : `
                                    <div class="text-center py-12 text-gray-500">
                                        <i class="fas fa-file-invoice text-4xl mb-4 text-gray-300"></i>
                                        <p>No invoices found for this customer</p>
                        </div>
                                `}
                            </div>
                        ` : ''}
                    </main>
                </div>
            `;
        }

        function InvoicesPage() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <h1 class="text-3xl font-bold mb-8 text-gray-800">Invoices</h1>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="mb-4">
                                <input type="text" placeholder="Search invoices..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Invoice ID</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Customer</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Items</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Total</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Payment</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${invoices.map(inv => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 font-semibold text-gray-800">${inv.id}</td>
                                                <td class="px-4 py-3 text-gray-800">${inv.customer}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.date}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.items.length} items</td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(inv.total)}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 ${inv.payment === 'Cash' ? 'bg-green-100 text-green-800' : inv.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : inv.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'} rounded-full text-sm">${inv.payment}</span></td>
                                                <td class="px-4 py-3">
                                                    <button onclick="viewInvoice('${inv.id}')" class="text-indigo-600 hover:text-indigo-800 mr-3">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="printInvoice('${inv.id}')" class="text-gray-600 hover:text-gray-800">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function ReportsPage() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            
            // Get filter values from state or defaults
            const filters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // Combine all transactions with type labels
            let allTransactions = [
                ...invoices.map(inv => ({ ...inv, transactionType: 'sale', typeLabel: 'Sale' })),
                ...purchaseOrders.map(po => ({ ...po, transactionType: 'purchase', typeLabel: 'Purchase', customer: po.supplier || 'N/A', payment: 'N/A', discount: 0, tax: 0 })),
                ...returns.map(ret => ({ ...ret, transactionType: 'return', typeLabel: ret.type === 'return' ? 'Return' : 'Exchange', payment: 'N/A', discount: 0, tax: 0 }))
            ];
            
            // Apply filters
            let filteredTransactions = [...allTransactions];
            
            // Order type filter
            if (filters.orderType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.transactionType === filters.orderType);
            }
            
            // Quick filter presets
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                if (filters.quickFilter === 'today') {
                    filteredTransactions = filteredTransactions.filter(t => t.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= weekAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= monthAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= yearAgo && tDate <= today;
                    });
                }
            }
            
            // Date range filter
            if (filters.dateFrom) {
                filteredTransactions = filteredTransactions.filter(t => t.date >= filters.dateFrom);
            }
            if (filters.dateTo) {
                filteredTransactions = filteredTransactions.filter(t => t.date <= filters.dateTo);
            }
            
            // Payment method filter (only for sales)
            if (filters.paymentMethod) {
                filteredTransactions = filteredTransactions.filter(t => t.payment === filters.paymentMethod);
            }
            
            // Calculate statistics from filtered data
            const salesTransactions = filteredTransactions.filter(t => t.transactionType === 'sale');
            const purchaseTransactions = filteredTransactions.filter(t => t.transactionType === 'purchase');
            const returnTransactions = filteredTransactions.filter(t => t.transactionType === 'return');
            
            const totalSales = salesTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalPurchases = purchaseTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalReturns = returnTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalDiscounts = salesTransactions.reduce((sum, t) => sum + (t.discount || 0), 0);
            const totalTax = salesTransactions.reduce((sum, t) => sum + (t.tax || 0), 0);
            const totalItemsSold = salesTransactions.reduce((sum, t) => sum + t.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0);
            
            // Today's sales
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesTransactions.filter(t => t.date === today).reduce((sum, t) => sum + t.total, 0);
            const todayInvoices = salesTransactions.filter(t => t.date === today);
            
            // Top selling products (only from sales)
            const productSales = {};
            salesTransactions.forEach(t => {
                t.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = { name: item.name, qty: 0, revenue: 0 };
                    }
                    productSales[item.name].qty += item.qty;
                    productSales[item.name].revenue += item.qty * (item.price || 0);
                });
            });
            const topProducts = Object.values(productSales).sort((a, b) => b.qty - a.qty).slice(0, 5);
            
            // Payment methods (only for sales)
            const paymentMethods = {};
            salesTransactions.forEach(t => {
                if (t.payment && t.payment !== 'N/A') {
                    paymentMethods[t.payment] = (paymentMethods[t.payment] || 0) + t.total;
                }
            });
            
            // Ensure standard payment methods are always included even if no transactions
            const standardPaymentMethods = ['Cash', 'Card', 'UPI', 'Credit Note'];
            standardPaymentMethods.forEach(method => {
                if (!paymentMethods[method]) {
                    paymentMethods[method] = 0;
                }
            });
            
            // Get unique payment methods for filters (only from sales)
            const uniquePaymentMethods = [...new Set(invoices.map(inv => inv.payment).filter(p => p))];
            // Ensure standard payment methods are in the filter list
            standardPaymentMethods.forEach(method => {
                if (!uniquePaymentMethods.includes(method)) {
                    uniquePaymentMethods.push(method);
                }
            });
            // Sort payment methods: standard methods first, then others
            uniquePaymentMethods.sort((a, b) => {
                const aIndex = standardPaymentMethods.indexOf(a);
                const bIndex = standardPaymentMethods.indexOf(b);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return a.localeCompare(b);
            });
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">Reports</h1>
                            <button onclick="exportReport()" class="btn btn-primary">
                                <i class="fas fa-download mr-2"></i>Export Report
                            </button>
                        </div>
                        
                        <!-- Filters Section -->
                        <div class="card mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 style="font-size: 1.25rem; font-weight: 600;">Filters</h2>
                                <button onclick="clearReportFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-times mr-1"></i>Clear All
                                </button>
                            </div>
                            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Order Type</label>
                                    <select id="orderType" class="input-field" onchange="setReportFilter('orderType', this.value)">
                                        <option value="all" ${filters.orderType === 'all' ? 'selected' : ''}>All Types</option>
                                        <option value="sale" ${filters.orderType === 'sale' ? 'selected' : ''}>Sale</option>
                                        <option value="purchase" ${filters.orderType === 'purchase' ? 'selected' : ''}>Purchase</option>
                                        <option value="return" ${filters.orderType === 'return' ? 'selected' : ''}>Return/Exchange</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quick Filter</label>
                                    <select id="quickFilter" class="input-field" onchange="setReportFilter('quickFilter', this.value)">
                                        <option value="all" ${filters.quickFilter === 'all' ? 'selected' : ''}>All Time</option>
                                        <option value="today" ${filters.quickFilter === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="week" ${filters.quickFilter === 'week' ? 'selected' : ''}>Last 7 Days</option>
                                        <option value="month" ${filters.quickFilter === 'month' ? 'selected' : ''}>Last 30 Days</option>
                                        <option value="year" ${filters.quickFilter === 'year' ? 'selected' : ''}>Last Year</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="dateFrom" class="input-field" value="${filters.dateFrom}" onchange="setReportFilter('dateFrom', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="dateTo" class="input-field" value="${filters.dateTo}" onchange="setReportFilter('dateTo', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                                    <select id="paymentMethod" class="input-field" onchange="setReportFilter('paymentMethod', this.value)">
                                        <option value="">All Methods</option>
                                        ${uniquePaymentMethods.map(method => `
                                            <option value="${method}" ${filters.paymentMethod === method ? 'selected' : ''}>${method}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-end">
                                <div class="text-small text-muted">
                                    Showing ${filteredTransactions.length} of ${allTransactions.length} transactions
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="stat-card">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value" style="color: var(--success);">${formatCurrency(totalSales)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Today's Sales</div>
                                <div class="stat-value" style="color: var(--primary);">${formatCurrency(todaySales)}</div>
                                <div class="text-small mt-2">${todayInvoices.length} transactions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Discounts</div>
                                <div class="stat-value" style="color: var(--warning);">${formatCurrency(totalDiscounts)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Items Sold</div>
                                <div class="stat-value" style="color: var(--info);">${totalItemsSold}</div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="card">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Top Selling Products</h2>
                                <div class="space-y-3">
                                    ${topProducts.length > 0 ? topProducts.map((p, index) => `
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div class="flex items-center space-x-4">
                                                <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                                    ${index + 1}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${p.name}</div>
                                                    <div class="text-small">${p.qty} units sold</div>
                                                </div>
                                            </div>
                                            <div style="font-weight: 700; font-size: 16px; color: var(--primary);">
                                                ${formatCurrency(p.revenue)}
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No sales data available</p>'}
                                </div>
                            </div>

                            <div class="card">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Payment Methods</h2>
                                <div class="space-y-3">
                                    ${Object.entries(paymentMethods).sort((a, b) => {
                                        // Sort by amount (descending), but ensure Cash, Card, UPI, Credit Note order
                                        const order = ['Cash', 'Card', 'UPI', 'Credit Note'];
                                        const aIndex = order.indexOf(a[0]);
                                        const bIndex = order.indexOf(b[0]);
                                        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                                        if (aIndex !== -1) return -1;
                                        if (bIndex !== -1) return 1;
                                        return b[1] - a[1];
                                    }).map(([method, amount]) => {
                                        const percentage = totalSales > 0 ? ((amount / totalSales) * 100).toFixed(1) : '0.0';
                                        return `
                                            <div>
                                                <div class="flex justify-between mb-2">
                                                    <span style="font-weight: 600; font-size: 15px;">${method}</span>
                                                    <span style="font-weight: 700; color: var(--primary);">${formatCurrency(amount)}</span>
                                                </div>
                                                <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                                    <div style="background: var(--primary); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                                </div>
                                                <div class="text-small mt-1">${percentage}% of total sales</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Transactions ${filters.quickFilter !== 'all' || filters.dateFrom || filters.dateTo || filters.paymentMethod || filters.orderType !== 'all' ? '(Filtered)' : ''}</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="table-header">Type</th>
                                            <th class="table-header">ID</th>
                                            <th class="table-header">Customer/Supplier</th>
                                            <th class="table-header">Date</th>
                                            <th class="table-header">Items</th>
                                            <th class="table-header">Discount</th>
                                            <th class="table-header">Total</th>
                                            <th class="table-header">Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredTransactions.length > 0 ? filteredTransactions.slice(-50).reverse().map(t => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="table-cell">
                                                    <span class="badge ${t.transactionType === 'sale' ? 'badge-success' : t.transactionType === 'purchase' ? 'badge-primary' : 'badge-danger'}">
                                                        ${t.typeLabel}
                                                    </span>
                                                </td>
                                                <td class="table-cell" style="font-weight: 600;">${t.id}</td>
                                                <td class="table-cell">${t.customer || t.supplier || 'N/A'}</td>
                                                <td class="table-cell text-muted">${t.date}</td>
                                                <td class="table-cell text-muted">${t.items.length} items</td>
                                                <td class="table-cell">${t.discount > 0 ? `<span style="color: var(--success);">-${formatCurrency(t.discount)}</span>` : '-'}</td>
                                                <td class="table-cell" style="font-weight: 600; ${t.transactionType === 'return' ? 'color: var(--danger);' : ''}">${formatCurrency(t.total)}</td>
                                                <td class="table-cell">
                                                    ${t.payment && t.payment !== 'N/A' ? `<span class="badge ${t.payment === 'Cash' ? 'badge-success' : t.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : t.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'badge-primary'}">${t.payment}</span>` : '-'}
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="8" class="table-cell text-center text-muted py-8">
                                                    No transactions found matching the selected filters
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function InventoryPage() {
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Get filter values from state
            const filters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            
            // Get unique suppliers for filters
            const uniqueSuppliers = [...new Set(purchaseOrders.map(po => po.supplier).filter(s => s))];
            
            // Apply filters to purchase orders
            let filteredPOs = [...purchaseOrders];
            if (filters.poStatus) {
                filteredPOs = filteredPOs.filter(po => po.status === filters.poStatus);
            }
            if (filters.poDateFrom) {
                filteredPOs = filteredPOs.filter(po => po.date >= filters.poDateFrom);
            }
            if (filters.poDateTo) {
                filteredPOs = filteredPOs.filter(po => po.date <= filters.poDateTo);
            }
            if (filters.poSupplier) {
                filteredPOs = filteredPOs.filter(po => po.supplier === filters.poSupplier);
            }
            // Apply search filter
            if (filters.poSearch && filters.poSearch.trim()) {
                const searchTerm = filters.poSearch.toLowerCase().trim();
                filteredPOs = filteredPOs.filter(po => {
                    // Search in PO ID
                    if (po.id.toLowerCase().includes(searchTerm)) return true;
                    // Search in supplier name
                    if (po.supplier && po.supplier.toLowerCase().includes(searchTerm)) return true;
                    // Search in date
                    if (po.date && po.date.includes(searchTerm)) return true;
                    // Search in items
                    if (po.items && po.items.some(item => item.name.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            // Apply filters to returns/exchanges
            let filteredReturns = [...returns];
            if (filters.returnStatus) {
                filteredReturns = filteredReturns.filter(ret => ret.status === filters.returnStatus);
            }
            if (filters.returnType) {
                filteredReturns = filteredReturns.filter(ret => ret.type === filters.returnType);
            }
            if (filters.returnDateFrom) {
                filteredReturns = filteredReturns.filter(ret => ret.date >= filters.returnDateFrom);
            }
            if (filters.returnDateTo) {
                filteredReturns = filteredReturns.filter(ret => ret.date <= filters.returnDateTo);
            }
            // Apply search filter
            if (filters.returnSearch && filters.returnSearch.trim()) {
                const searchTerm = filters.returnSearch.toLowerCase().trim();
                filteredReturns = filteredReturns.filter(ret => {
                    // Search in return ID
                    if (ret.id.toLowerCase().includes(searchTerm)) return true;
                    // Search in invoice ID
                    if (ret.invoiceId && ret.invoiceId.toLowerCase().includes(searchTerm)) return true;
                    // Search in customer name
                    if (ret.customer && ret.customer.toLowerCase().includes(searchTerm)) return true;
                    // Search in date
                    if (ret.date && ret.date.includes(searchTerm)) return true;
                    // Search in items
                    if (ret.items && ret.items.some(item => item.name.toLowerCase().includes(searchTerm))) return true;
                    // Search in reason
                    if (ret.items && ret.items.some(item => item.reason && item.reason.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            // Calculate total stock value
            const totalStockValue = products.reduce((sum, product) => {
                return sum + (product.stock * product.price);
            }, 0);
            
            // Calculate total number of products
            const totalProducts = products.length;
            const totalStockUnits = products.reduce((sum, product) => sum + product.stock, 0);
            
            // Identify slow-moving/not-moving stock
            // Products that haven't been sold in the last 90 days
            const today = new Date();
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setDate(today.getDate() - 90);
            
            // Get all product sales in the last 90 days
            const recentSales = {};
            invoices.forEach(inv => {
                const invDate = new Date(inv.date);
                if (invDate >= ninetyDaysAgo) {
                    inv.items.forEach(item => {
                        if (!recentSales[item.name]) {
                            recentSales[item.name] = 0;
                        }
                        recentSales[item.name] += item.qty;
                    });
                }
            });
            
            // Identify slow-moving products (no sales in last 90 days but have stock)
            const slowMovingProducts = products.filter(product => {
                const hasRecentSales = recentSales[product.name] > 0;
                return !hasRecentSales && product.stock > 0;
            }).map(product => ({
                ...product,
                stockValue: product.stock * product.price,
                daysSinceLastSale: '90+ days'
            }));
            
            // Sort by stock value (highest first) to prioritize high-value dead stock
            slowMovingProducts.sort((a, b) => b.stockValue - a.stockValue);
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">Inventory Management</h1>
                        </div>

                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="stat-card">
                                <div class="stat-label">Total Stock Value</div>
                                <div class="stat-value" style="color: var(--primary);">${formatCurrency(totalStockValue)}</div>
                                <div class="text-small mt-2">${totalStockUnits} units across ${totalProducts} products</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Purchase Orders</div>
                                <div class="stat-value" style="color: var(--primary);">${purchaseOrders.length}</div>
                                <div class="text-small mt-2">${purchaseOrders.filter(po => po.status === 'pending').length} pending</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Returns/Exchanges</div>
                                <div class="stat-value" style="color: var(--danger);">${returns.length}</div>
                                <div class="text-small mt-2">${returns.filter(r => r.status === 'pending').length} pending</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Slow-Moving Stock</div>
                                <div class="stat-value" style="color: var(--warning);">${slowMovingProducts.length}</div>
                                <div class="text-small mt-2">${formatCurrency(slowMovingProducts.reduce((sum, p) => sum + p.stockValue, 0))} tied up</div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <!-- Purchase Orders Section -->
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">Purchase Orders</h2>
                                    <button onclick="showPurchaseOrderModal()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-plus mr-1"></i>New PO
                                    </button>
                                </div>
                                
                                <!-- PO Search Bar -->
                                <div class="mb-4">
                                    <div class="relative">
                                        <input type="text" id="poSearch" placeholder="Search by PO ID, supplier, date, or items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.poSearch || ''}" oninput="filterPurchaseOrders(this.value)" style="padding-right: 40px;">
                                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <!-- PO Filters -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
                                        <button onclick="clearPOFilters()" class="text-xs text-gray-600 hover:text-gray-800">
                                            <i class="fas fa-times mr-1"></i>Clear
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                                            <select id="poStatusFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('poStatus', this.value)">
                                                <option value="">All</option>
                                                <option value="pending" ${filters.poStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="completed" ${filters.poStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Supplier</label>
                                            <select id="poSupplierFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('poSupplier', this.value)">
                                                <option value="">All Suppliers</option>
                                                ${uniqueSuppliers.map(supplier => `
                                                    <option value="${supplier}" ${filters.poSupplier === supplier ? 'selected' : ''}>${supplier}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                                            <input type="date" id="poDateFromFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.poDateFrom}" onchange="setInventoryFilter('poDateFrom', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                                            <input type="date" id="poDateToFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.poDateTo}" onchange="setInventoryFilter('poDateTo', this.value)">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Showing ${filteredPOs.length} of ${purchaseOrders.length} orders
                                    </div>
                                </div>
                                
                                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                                    ${filteredPOs.length > 0 ? filteredPOs.map(po => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${po.id}</div>
                                                    <div class="text-small">${po.supplier}</div>
                                                    <div class="text-small">${po.date}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="badge ${po.status === 'completed' ? 'badge-success' : 'badge-warning'}">${po.status}</span>
                                                    <div style="font-weight: 700; font-size: 18px; color: var(--primary); margin-top: 8px;">
                                                        ${formatCurrency(po.total)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <div class="text-small font-semibold mb-2">Items:</div>
                                                ${po.items.map(item => `
                                                    <div class="flex justify-between text-small mb-1">
                                                        <span>${item.name} x ${item.qty}</span>
                                                        <span>${formatCurrency(item.cost * item.qty)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="flex gap-2 mt-3">
                                                ${po.status === 'pending' ? `
                                                    <button onclick="completePurchaseOrder('${po.id}')" class="btn btn-success" style="padding: 6px 12px; font-size: 14px; flex: 1;">
                                                        <i class="fas fa-check mr-1"></i>Complete
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No purchase orders found</p>'}
                                </div>
                            </div>

                            <!-- Returns & Exchanges Section -->
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">Returns & Exchanges</h2>
                                    <button onclick="showReturnExchangeModal()" class="btn" style="background: var(--info); color: white; padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-exchange-alt mr-1"></i>New Return
                                    </button>
                                </div>
                                
                                <!-- Return Search Bar -->
                                <div class="mb-4">
                                    <div class="relative">
                                        <input type="text" id="returnSearch" placeholder="Search by return ID, invoice ID, customer, date, or items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.returnSearch || ''}" oninput="filterReturnsExchanges(this.value)" style="padding-right: 40px;">
                                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <!-- Return Filters -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
                                        <button onclick="clearReturnFilters()" class="text-xs text-gray-600 hover:text-gray-800">
                                            <i class="fas fa-times mr-1"></i>Clear
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                                            <select id="returnStatusFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('returnStatus', this.value)">
                                                <option value="">All</option>
                                                <option value="pending" ${filters.returnStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="completed" ${filters.returnStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Type</label>
                                            <select id="returnTypeFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('returnType', this.value)">
                                                <option value="">All Types</option>
                                                <option value="return" ${filters.returnType === 'return' ? 'selected' : ''}>Return</option>
                                                <option value="exchange" ${filters.returnType === 'exchange' ? 'selected' : ''}>Exchange</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                                            <input type="date" id="returnDateFromFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.returnDateFrom}" onchange="setInventoryFilter('returnDateFrom', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                                            <input type="date" id="returnDateToFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.returnDateTo}" onchange="setInventoryFilter('returnDateTo', this.value)">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Showing ${filteredReturns.length} of ${returns.length} returns/exchanges
                                    </div>
                                </div>
                                
                                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                                    ${filteredReturns.length > 0 ? filteredReturns.map(ret => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${ret.id}</div>
                                                    <div class="text-small">Invoice: ${ret.invoiceId}</div>
                                                    <div class="text-small">Customer: ${ret.customer}</div>
                                                    <div class="text-small">${ret.date}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="badge ${ret.type === 'return' ? 'badge-danger' : 'badge-primary'}">${ret.type}</span>
                                                    <span class="badge ${ret.status === 'completed' ? 'badge-success' : 'badge-warning'}" style="margin-left: 4px;">${ret.status}</span>
                                                    <div style="font-weight: 700; font-size: 18px; color: var(--danger); margin-top: 8px;">
                                                        ${formatCurrency(ret.total)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                ${ret.items.map(item => `
                                                    <div class="mb-2">
                                                        <div class="flex justify-between text-small mb-1">
                                                            <span style="font-weight: 600;">${item.name} x ${item.qty}</span>
                                                            <span>${formatCurrency(item.price * item.qty)}</span>
                                                        </div>
                                                        <div class="text-xs text-gray-600">Reason: ${item.reason || 'N/A'}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${ret.status === 'pending' ? `
                                                <button onclick="completeReturn('${ret.id}')" class="btn btn-success w-full mt-3" style="padding: 6px 12px; font-size: 14px;">
                                                    <i class="fas fa-check mr-1"></i>Complete Return
                                                </button>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No returns/exchanges found</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Slow-Moving Stock Section -->
                        ${slowMovingProducts.length > 0 ? `
                            <div class="card mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 style="font-size: 1.5rem; font-weight: 600;">Slow-Moving / Not-Moving Stock</h2>
                                        <p class="text-small text-gray-600 mt-1">Products with no sales in the last 90 days</p>
                                    </div>
                                    <button onclick="exportSlowMovingStock()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-download mr-2"></i>Export Data
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr>
                                                <th class="table-header">Product</th>
                                                <th class="table-header">SKU</th>
                                                <th class="table-header">Category</th>
                                                <th class="table-header">Current Stock</th>
                                                <th class="table-header">Unit Price</th>
                                                <th class="table-header">Stock Value</th>
                                                <th class="table-header">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${slowMovingProducts.map(product => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="table-cell">
                                                        <div class="flex items-center space-x-3">
                                                            <span class="text-2xl">${product.image}</span>
                                                            <span class="font-semibold text-gray-800">${product.name}</span>
                                                        </div>
                                                    </td>
                                                    <td class="table-cell text-gray-600">${product.sku}</td>
                                                    <td class="table-cell">
                                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                                                    </td>
                                                    <td class="table-cell">
                                                        <span class="font-bold text-orange-600">${product.stock}</span>
                                                    </td>
                                                    <td class="table-cell font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                                                    <td class="table-cell font-bold text-orange-600">${formatCurrency(product.stockValue)}</td>
                                                    <td class="table-cell">
                                                        <span class="badge badge-warning">Not Moving</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : `
                            <div class="card mb-8">
                                <div class="text-center py-8">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                                    <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800);">All Stock is Moving Well!</h2>
                                    <p class="text-small text-gray-600 mt-2">No products identified as slow-moving in the last 90 days.</p>
                                </div>
                            </div>
                        `}

                        <!-- All Stock Data Section -->
                        <div class="card mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">All Stock Data</h2>
                                    <p class="text-small text-gray-600 mt-1">Complete inventory overview with stock levels and values</p>
                                </div>
                                <button onclick="exportAllStockData()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-download mr-2"></i>Export Data
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="stockSearch" placeholder="Search products by name, SKU, or barcode..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterStockData(this.value)" style="padding-right: 45px;">
                                    <button type="button" onclick="scanBarcodeForStock()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                        <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full" id="stockDataTable">
                                    <thead>
                                        <tr>
                                            <th class="table-header">Product</th>
                                            <th class="table-header">SKU</th>
                                            <th class="table-header">Category</th>
                                            <th class="table-header">Current Stock</th>
                                            <th class="table-header">Unit Price</th>
                                            <th class="table-header">Stock Value</th>
                                            <th class="table-header">Barcode</th>
                                            <th class="table-header">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${products.map(product => {
                                            const stockValue = product.stock * product.price;
                                            const stockStatus = product.stock === 0 ? 'out' : product.stock < 10 ? 'low' : 'good';
                                            return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="table-cell">
                                                    <div class="flex items-center space-x-3">
                                                        <span class="text-2xl">${product.image}</span>
                                                        <span class="font-semibold text-gray-800">${product.name}</span>
                                                    </div>
                                                </td>
                                                <td class="table-cell text-gray-600">${product.sku}</td>
                                                <td class="table-cell">
                                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                                                </td>
                                                <td class="table-cell">
                                                    <span class="font-bold ${stockStatus === 'out' ? 'text-red-600' : stockStatus === 'low' ? 'text-orange-600' : 'text-green-600'}">${product.stock}</span>
                                                </td>
                                                <td class="table-cell font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                                                <td class="table-cell font-bold text-gray-800">${formatCurrency(stockValue)}</td>
                                                <td class="table-cell text-gray-600 text-sm">${product.barcode}</td>
                                                <td class="table-cell">
                                                    ${stockStatus === 'out' ? '<span class="badge badge-danger">Out of Stock</span>' : 
                                                      stockStatus === 'low' ? '<span class="badge badge-warning">Low Stock</span>' : 
                                                      '<span class="badge badge-success">In Stock</span>'}
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function SettingsPage() {
            const settings = store.getState().settings;
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <h1 class="text-3xl font-bold mb-8 text-gray-800">Settings</h1>
                        <div class="max-w-2xl">
                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Business Information</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Business Name</label>
                                        <input type="text" id="businessName" value="${settings.businessName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Tax Rate (%)</label>
                                        <input type="number" id="taxRate" value="${settings.taxRate}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Currency</label>
                                        <select id="currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                            <option value="INR" ${settings.currency === 'INR' ? 'selected' : ''}>INR - Indian Rupee</option>
                                            <option value="USD" ${settings.currency === 'USD' ? 'selected' : ''}>USD - US Dollar</option>
                                            <option value="EUR" ${settings.currency === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                                            <option value="GBP" ${settings.currency === 'GBP' ? 'selected' : ''}>GBP - British Pound</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Data Management</h2>
                                <div class="space-y-3">
                                    <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition">
                                        <i class="fas fa-download mr-2"></i>Export All Data
                                    </button>
                                    <button onclick="if(confirm('Reset all data? This cannot be undone!')) resetData()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>Reset All Data
                                    </button>
                                </div>
                            </div>

                            <button onclick="saveSettings()" class="w-full mt-6 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </main>
                </div>
            `;
        }

        function addToCart(productId) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const cart = store.getState().cart;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            store.setState({ cart });
        }

        function removeFromCart(index) {
            const cart = store.getState().cart;
            cart.splice(index, 1);
            store.setState({ cart });
        }

        function updateCartQty(index, change) {
            const cart = store.getState().cart;
            cart[index].qty += change;
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }
            store.setState({ cart });
        }

        function clearCart() {
            store.setState({ cart: [], discount: 0, selectedCustomer: null });
            // Clear customer info display
            if (document.getElementById('displayName')) {
                document.getElementById('displayName').textContent = 'Walk-in Customer';
                document.getElementById('displayMobile').textContent = '-';
                document.getElementById('displayEmail').textContent = '-';
            }
        }

        function toggleCustomerForm() {
            const form = document.getElementById('customerForm');
            const display = document.getElementById('customerDisplay');
            const btn = document.getElementById('toggleCustomerBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                display.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-times mr-1"></i>Cancel';
            } else {
                form.classList.add('hidden');
                display.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-edit mr-1"></i>Edit';
                // Clear form
                document.getElementById('customerName').value = '';
                document.getElementById('customerMobile').value = '';
                document.getElementById('customerEmail').value = '';
            }
        }

        function saveCustomerInfo() {
            const name = document.getElementById('customerName').value.trim();
            const mobile = document.getElementById('customerMobile').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name || !mobile) {
                alert('Please enter customer name and mobile number');
                return;
            }
            
            // Update display
            document.getElementById('displayName').textContent = name;
            document.getElementById('displayMobile').textContent = mobile;
            document.getElementById('displayEmail').textContent = email || '-';
            
            // Store in state
            store.setState({ 
                customerInfo: { name, mobile, email }
            });
            
            // Hide form and show display
            toggleCustomerForm();
        }

        function selectCustomer(customerId) {
            store.setState({ selectedCustomer: customerId ? parseInt(customerId) : null });
        }

        function filterByCategory(category) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const grid = document.getElementById('productsGrid');
            const filtered = category ? products.filter(p => p.category === category) : products;
            grid.innerHTML = filtered.map(p => `
                <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                    <div style="font-size: 48px; margin-bottom: 12px; text-align: center;">${p.image}</div>
                    <div style="font-weight: 600; font-size: 15px; color: var(--gray-900); margin-bottom: 4px;">${p.name}</div>
                    <div class="text-small" style="margin-bottom: 8px;">${p.category}</div>
                    <div class="price-display" style="font-size: 1.25rem;">${formatCurrency(p.price)}</div>
                    <div class="text-small" style="margin-top: 4px;">Stock: ${p.stock}</div>
                </div>
            `).join('');
        }

        function applyCoupon() {
            const code = document.getElementById('couponCode').value.toUpperCase();
            const coupons = JSON.parse(localStorage.getItem('coupons') || '[]');
            const coupon = coupons.find(c => c.code === code && c.valid);
            
            if (coupon) {
                store.setState({ 
                    discount: coupon.discount, 
                    discountType: coupon.type 
                });
                document.getElementById('discountValue').value = coupon.discount;
                document.getElementById('discountType').value = coupon.type;
                alert(`Coupon "${code}" applied! ${coupon.discount}${coupon.type === 'percentage' ? '%' : ' ' + getCurrencySymbol()} discount.`);
            } else {
                alert('Invalid or expired coupon code!');
            }
        }

        function setDiscount(value) {
            store.setState({ discount: parseFloat(value) || 0 });
        }

        function setDiscountType(type) {
            store.setState({ discountType: type });
        }

        function removeDiscount() {
            store.setState({ discount: 0, discountType: 'percentage' });
            document.getElementById('discountValue').value = 0;
            document.getElementById('discountType').value = 'percentage';
            document.getElementById('couponCode').value = '';
        }

        function holdOrder() {
            const cart = store.getState().cart;
            const selectedCustomer = store.getState().selectedCustomer;
            const discount = store.getState().discount || 0;
            const discountType = store.getState().discountType || 'percentage';
            
            if (cart.length === 0) return;
            
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            const orderNumber = heldOrders.length + 1;
            const orderLabel = `Order #${orderNumber}`;
            
            const newOrder = {
                id: `HOLD-${Date.now()}`,
                date: new Date().toISOString(),
                customer: orderLabel,
                items: [...cart],
                discount,
                discountType
            };
            
            heldOrders.push(newOrder);
            localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
            store.setState({ heldOrders, cart: [], discount: 0, selectedCustomer: null });
            alert(`Order held successfully! (${heldOrders.length} held orders)`);
        }

        function showHeldOrders() {
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            if (heldOrders.length === 0) {
                alert('No held orders found.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">Held Orders (${heldOrders.length})</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${heldOrders.map((order, index) => {
                            const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                            let discountAmount = 0;
                            if (order.discountType === 'percentage') {
                                discountAmount = (subtotal * order.discount) / 100;
                            } else {
                                discountAmount = order.discount;
                            }
                            const total = subtotal - discountAmount;
                            return `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">${order.customer}</div>
                                            <div class="text-small">${new Date(order.date).toLocaleString()}</div>
                                            <div class="text-small mt-1">${order.items.length} items</div>
                                        </div>
                                        <div class="text-right">
                                            <div style="font-weight: 700; font-size: 18px; color: var(--primary);">${formatCurrency(total)}</div>
                                            <button onclick="loadHeldOrder(${index})" class="btn btn-primary mt-2" style="padding: 6px 12px; font-size: 14px;">
                                                <i class="fas fa-arrow-right mr-1"></i>Load
                                            </button>
                                            <button onclick="deleteHeldOrder(${index})" class="btn mt-2" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 14px; margin-left: 4px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function loadHeldOrder(index) {
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            const order = heldOrders[index];
            
            if (order) {
                const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                const customer = customers.find(c => c.name === order.customer);
                store.setState({
                    cart: order.items,
                    selectedCustomer: customer ? customer.id : null,
                    discount: order.discount || 0,
                    discountType: order.discountType || 'percentage'
                });
                document.querySelector('.modal-backdrop')?.remove();
                alert('Order loaded successfully!');
            }
        }

        function deleteHeldOrder(index) {
            if (!confirm('Delete this held order?')) return;
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            heldOrders.splice(index, 1);
            localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
            store.setState({ heldOrders });
            showHeldOrders();
        }

        function selectPaymentMethod(paymentMethod, buttonElement) {
            const cart = store.getState().cart;
            if (cart.length === 0) return;
            
            // Remove selected class from all payment buttons
            document.querySelectorAll('.payment-option-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (!btn.disabled && !btn.classList.contains('selected')) {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-300)';
                    btn.style.color = 'var(--gray-700)';
                    const iconDiv = btn.querySelector('div');
                    if (iconDiv) iconDiv.style.color = 'var(--gray-600)';
                }
            });
            
            // Add selected class to clicked button
            if (!buttonElement.disabled) {
                buttonElement.classList.add('selected');
                buttonElement.style.background = '#10b981';
                buttonElement.style.borderColor = '#10b981';
                buttonElement.style.color = 'white';
                const iconDiv = buttonElement.querySelector('div');
                if (iconDiv) iconDiv.style.color = 'white';
                
                // Show customer information modal
                showCustomerInfoModal(paymentMethod, buttonElement);
            }
        }

        function showCustomerInfoModal(paymentMethod, buttonElement) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 animate-fade-in shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">Customer Information</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);" onmouseover="this.style.background='var(--gray-300)'" onmouseout="this.style.background='var(--gray-200)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="customerInfoForm" onsubmit="submitCustomerInfo(event, '${paymentMethod}', this.closest('.modal-backdrop'))">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Name <span class="text-muted" style="font-weight: 400;">(Optional)</span>
                                </label>
                                <input type="text" id="customerNameInput" name="name" 
                                    class="input-field" 
                                    placeholder="Enter customer name"
                                    style="padding: 12px; font-size: 15px;"
                                    autocomplete="off">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Mobile Number <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="tel" id="customerMobileInput" name="mobile" required 
                                    class="input-field" 
                                    placeholder="Enter mobile number"
                                    style="padding: 12px; font-size: 15px;"
                                    pattern="[0-9]{10,15}"
                                    autocomplete="off">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Email <span class="text-muted" style="font-weight: 400;">(Optional)</span>
                                </label>
                                <input type="email" id="customerEmailInput" name="email" 
                                    class="input-field" 
                                    placeholder="Enter email address"
                                    style="padding: 12px; font-size: 15px;"
                                    autocomplete="off">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" 
                                class="flex-1" 
                                style="background: var(--gray-200); color: var(--gray-700); padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='var(--gray-300)'" 
                                onmouseout="this.style.background='var(--gray-200)'">
                                Cancel
                            </button>
                            <button type="submit" 
                                class="flex-1 btn-primary" 
                                style="padding: 12px; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-check mr-2"></i>Proceed to Payment
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('customerNameInput')?.focus();
            }, 100);
        }

        function submitCustomerInfo(event, paymentMethod, modalElement) {
            event.preventDefault();
            
            const form = event.target;
            const name = form.querySelector('#customerNameInput').value.trim();
            const mobile = form.querySelector('#customerMobileInput').value.trim();
            const email = form.querySelector('#customerEmailInput').value.trim();
            
            // Only mobile is required
            if (!mobile) {
                alert('Please enter mobile number');
                return;
            }
            
            // Validate mobile number
            if (mobile.length < 10 || !/^[0-9]+$/.test(mobile)) {
                alert('Please enter a valid mobile number (10-15 digits)');
                return;
            }
            
            // Store customer info in state (name can be empty)
            store.setState({ 
                customerInfo: { name: name || 'Walk-in Customer', mobile, email }
            });
            
            // Remove modal
            modalElement.remove();
            
            // Proceed with checkout
            checkout(paymentMethod);
        }

        function checkout(paymentMethod) {
            const cart = store.getState().cart;
            const settings = store.getState().settings;
            const discount = store.getState().discount || 0;
            const discountType = store.getState().discountType || 'percentage';
            const customerInfo = store.getState().customerInfo || {};
            
            if (cart.length === 0) return;
            
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            let customer = null;
            let customerName = 'Walk-in Customer';
            let customerEmail = '';
            let customerPhone = '';
            
            // Use customer info from modal (mobile is required, name is optional)
            if (customerInfo.mobile) {
                customerName = customerInfo.name || 'Walk-in Customer';
                customerEmail = customerInfo.email || '';
                customerPhone = customerInfo.mobile;
                
                // Check if customer already exists by phone
                const existingCustomer = customers.find(c => c.phone === customerPhone);
                if (existingCustomer) {
                    customer = existingCustomer;
                    // Update name if provided and different
                    if (customerInfo.name && customerInfo.name !== 'Walk-in Customer' && customerInfo.name !== existingCustomer.name) {
                        existingCustomer.name = customerInfo.name;
                    }
                    // Update email if provided
                    if (customerEmail && customerEmail !== existingCustomer.email) {
                        existingCustomer.email = customerEmail;
                    }
                } else {
                    // Create new customer
                    const newCustomer = {
                        id: Math.max(0, ...customers.map(c => c.id)) + 1,
                        name: customerName,
                        email: customerEmail || `${customerName.toLowerCase().replace(/\s+/g, '')}@email.com`,
                        phone: customerPhone,
                        totalPurchases: 0,
                        lastPurchase: new Date().toISOString().split('T')[0]
                    };
                    customers.push(newCustomer);
                    customer = newCustomer;
                }
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = (subtotal * discount) / 100;
            } else {
                discountAmount = discount;
            }
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const tax = afterDiscount * (settings.taxRate / 100);
            const total = afterDiscount + tax;
            
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const newInvoice = {
                id: `INV-${String(invoices.length + 1).padStart(3, '0')}`,
                date: new Date().toISOString().split('T')[0],
                customer: customerName,
                customerPhone: customerPhone || '',
                customerEmail: customerEmail || '',
                items: cart.map(item => ({ name: item.name, qty: item.qty, price: item.price })),
                subtotal,
                discount: discountAmount,
                tax,
                total,
                payment: paymentMethod,
                status: 'completed'
            };
            invoices.push(newInvoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Update customer total purchases
            if (customer) {
                customer.totalPurchases += total;
                customer.lastPurchase = newInvoice.date;
                // Update email if provided in form
                if (customerInfo.email && customerInfo.email !== customer.email) {
                    customer.email = customerInfo.email;
                }
                const allCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
                const customerIndex = allCustomers.findIndex(c => c.id === customer.id);
                if (customerIndex !== -1) {
                    allCustomers[customerIndex] = customer;
                } else {
                    allCustomers.push(customer);
                }
                localStorage.setItem('customers', JSON.stringify(allCustomers));
            }
            
            // Clear customer info from state
            store.setState({ customerInfo: null });
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock -= cartItem.qty;
                }
            });
            localStorage.setItem('products', JSON.stringify(products));
            
            // Clear payment selection
            document.querySelectorAll('.payment-option-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (!btn.disabled) {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-300)';
                    btn.style.color = 'var(--gray-700)';
                    const iconDiv = btn.querySelector('div');
                    if (iconDiv) iconDiv.style.color = 'var(--gray-600)';
                }
            });
            
            alert(`Payment successful! Invoice ${newInvoice.id} created.`);
            printInvoice(newInvoice.id);
            clearCart();
        }

        function viewInvoice(invoiceId) {
            printInvoice(invoiceId);
        }

        function printInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            const currencySymbol = getCurrencySymbol();
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoice.id}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
                        * { font-family: 'Poppins', sans-serif; }
                        body { padding: 60px; background: white; }
                        .invoice-header { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; padding: 40px; border-radius: 12px 12px 0 0; margin-bottom: 40px; }
                        .invoice-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
                        .invoice-subtitle { font-size: 1rem; opacity: 0.9; }
                        .invoice-details { margin-bottom: 40px; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .invoice-details div { margin: 8px 0; font-size: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
                        th { background: #f3f4f6; padding: 16px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: #374151; }
                        td { padding: 16px; border-bottom: 1px solid #e5e7eb; font-size: 15px; color: #1f2937; }
                        .totals { text-align: right; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .totals div { margin: 8px 0; font-size: 15px; }
                        .grand-total { font-size: 1.5rem; font-weight: 700; margin-top: 16px; color: #1f2937; }
                        .thank-you { text-align: center; margin-top: 60px; color: #6b7280; font-size: 15px; }
                    </style>
                </head>
                <body>
                    <div class="invoice-header">
                        <div class="invoice-title">${store.getState().settings.businessName}</div>
                        <div class="invoice-subtitle">INVOICE</div>
                    </div>
                    <div class="invoice-details">
                        <div><strong>Invoice ID:</strong> ${invoice.id}</div>
                        <div><strong>Date:</strong> ${invoice.date}</div>
                        <div><strong>Customer:</strong> ${invoice.customer}</div>
                        ${invoice.customerPhone ? `<div><strong>Phone:</strong> ${invoice.customerPhone}</div>` : ''}
                        ${invoice.customerEmail ? `<div><strong>Email:</strong> ${invoice.customerEmail}</div>` : ''}
                        <div><strong>Payment Method:</strong> ${invoice.payment}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.qty}</td>
                                    <td>${currencySymbol}${item.price.toFixed(2)}</td>
                                    <td>${currencySymbol}${(item.qty * item.price).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="totals">
                        <div>Subtotal: ${currencySymbol}${invoice.subtotal.toFixed(2)}</div>
                        ${invoice.discount > 0 ? `<div style="color: #059669; font-weight: 600;">Discount: -${currencySymbol}${invoice.discount.toFixed(2)}</div>` : ''}
                        <div>Tax: ${currencySymbol}${invoice.tax.toFixed(2)}</div>
                        <div class="grand-total">Total: ${currencySymbol}${invoice.total.toFixed(2)}</div>
                    </div>
                    <div class="thank-you">
                        Thank you for your business!
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function scanBarcode() {
            // Focus on the search input to allow barcode scanner input
            const searchInput = document.getElementById('productSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                // Show a message to guide user
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                // Listen for Enter key (barcode scanners typically send Enter after scanning)
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        // Search for product by barcode
                        const barcode = searchInput.value.trim();
                        const products = JSON.parse(localStorage.getItem('products') || '[]');
                        const product = products.find(p => p.barcode === barcode || p.sku === barcode);
                        
                        if (product) {
                            // Add product to cart
                            addToCart(product.id);
                            searchInput.value = '';
                            searchInput.placeholder = originalPlaceholder;
                            searchInput.removeEventListener('keypress', handleKeyPress);
                        } else {
                            alert('Product not found with this barcode/SKU');
                            searchInput.value = '';
                            searchInput.placeholder = originalPlaceholder;
                            searchInput.removeEventListener('keypress', handleKeyPress);
                        }
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                // Also handle blur to reset placeholder
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function scanBarcodeForProducts() {
            // Focus on the search input to allow barcode scanner input
            const searchInput = document.getElementById('searchProducts');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                // Show a message to guide user
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                // Listen for Enter key (barcode scanners typically send Enter after scanning)
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        // Filter products by barcode
                        const barcode = searchInput.value.trim();
                        filterProductsList(barcode);
                        searchInput.placeholder = originalPlaceholder;
                        searchInput.removeEventListener('keypress', handleKeyPress);
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                // Also handle blur to reset placeholder
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function filterProducts(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const grid = document.getElementById('productsGrid');
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.barcode.includes(searchTerm) ||
                p.sku.toLowerCase().includes(searchTerm.toLowerCase())
            );
            grid.innerHTML = filtered.map(p => `
                <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                    <div class="text-4xl mb-2 text-center">${p.image}</div>
                    <div class="font-semibold text-gray-800 text-sm">${p.name}</div>
                    <div class="text-gray-600 text-xs">${p.category}</div>
                    <div class="font-bold text-indigo-600 mt-2">${formatCurrency(p.price)}</div>
                    <div class="text-xs text-gray-600 mt-1">Stock: ${p.stock}</div>
                </div>
            `).join('');
        }

        function filterProductsList(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const table = document.getElementById('productsTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchLower) ||
                p.sku.toLowerCase().includes(searchLower) ||
                p.category.toLowerCase().includes(searchLower) ||
                p.barcode.includes(searchTerm)
            );
            
            tbody.innerHTML = filtered.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${p.image}</span>
                            <span class="font-semibold text-gray-800">${p.name}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${p.sku}</td>
                    <td class="px-4 py-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${p.category}</span></td>
                    <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(p.price)}</td>
                    <td class="px-4 py-3">
                        <span class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-800'}">${p.stock}</span>
                        ${p.stock < 10 ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>' : ''}
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-sm">${p.barcode}</td>
                </tr>
            `).join('');
        }

        function filterStockData(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const table = document.getElementById('stockDataTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchLower) ||
                p.sku.toLowerCase().includes(searchLower) ||
                p.category.toLowerCase().includes(searchLower) ||
                p.barcode.includes(searchTerm)
            );
            
            tbody.innerHTML = filtered.map(product => {
                const stockValue = product.stock * product.price;
                const stockStatus = product.stock === 0 ? 'out' : product.stock < 10 ? 'low' : 'good';
                return `
                <tr class="hover:bg-gray-50">
                    <td class="table-cell">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${product.image}</span>
                            <span class="font-semibold text-gray-800">${product.name}</span>
                        </div>
                    </td>
                    <td class="table-cell text-gray-600">${product.sku}</td>
                    <td class="table-cell">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                    </td>
                    <td class="table-cell">
                        <span class="font-bold ${stockStatus === 'out' ? 'text-red-600' : stockStatus === 'low' ? 'text-orange-600' : 'text-green-600'}">${product.stock}</span>
                    </td>
                    <td class="table-cell font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                    <td class="table-cell font-bold text-gray-800">${formatCurrency(stockValue)}</td>
                    <td class="table-cell text-gray-600 text-sm">${product.barcode}</td>
                    <td class="table-cell">
                        ${stockStatus === 'out' ? '<span class="badge badge-danger">Out of Stock</span>' : 
                          stockStatus === 'low' ? '<span class="badge badge-warning">Low Stock</span>' : 
                          '<span class="badge badge-success">In Stock</span>'}
                    </td>
                </tr>
                `;
            }).join('');
        }

        function scanBarcodeForStock() {
            const searchInput = document.getElementById('stockSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        const barcode = searchInput.value.trim();
                        filterStockData(barcode);
                        searchInput.placeholder = originalPlaceholder;
                        searchInput.removeEventListener('keypress', handleKeyPress);
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function filterCustomersList(searchTerm) {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const container = document.getElementById('customersList');
            if (!container) return;
            
            const selectedCustomerId = store.getState().selectedCustomerForView || null;
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            const searchLower = searchTerm.toLowerCase().trim();
            let filtered = customers.filter(c =>
                c.name.toLowerCase().includes(searchLower) ||
                c.email.toLowerCase().includes(searchLower) ||
                c.phone.includes(searchTerm)
            );
            
            // Calculate orders, avg order value, last purchase date for filtered customers
            let customersWithStats = filtered.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            container.innerHTML = customersWithStats.map(c => {
                const status = getCustomerStatus(c.totalPurchases);
                const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase();
                return `
                <tr class="hover:bg-gray-50 transition cursor-pointer ${selectedCustomerId === c.id ? 'bg-indigo-50' : ''}" onclick="selectCustomerForView(${c.id})">
                    <td class="px-4 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-sm">
                                ${initials}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">${c.name}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm text-gray-600">${c.email}</div>
                        <div class="text-sm text-gray-600">${c.phone}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${c.ordersCount}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.totalPurchases)}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.avgOrderValue)}</div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-3 py-1 ${status.color} rounded-full text-xs font-semibold">
                            ${status.label}
                        </span>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function selectCustomerForView(customerId) {
            store.setState({ selectedCustomerForView: customerId });
            render();
        }

        function clearCustomerSelection() {
            store.setState({ selectedCustomerForView: null });
            render();
        }

        function setCustomerFilter(filterName, value) {
            const currentFilters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            currentFilters[filterName] = value;
            store.setState({ customerFilters: currentFilters });
            localStorage.setItem('customerFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearCustomerFilters() {
            const defaultFilters = {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            store.setState({ customerFilters: defaultFilters });
            localStorage.setItem('customerFilters', JSON.stringify(defaultFilters));
            render();
        }

        function setCustomerSort(field, value) {
            const currentSort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            currentSort[field] = value;
            store.setState({ customerSort: currentSort });
            localStorage.setItem('customerSort', JSON.stringify(currentSort));
            render();
        }

        function applyCustomerFilters() {
            // Trigger re-render to apply filters
            render();
        }

        function exportCustomersToCSV() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            // Calculate stats and apply filters (same logic as CustomersPage)
            let customersWithStats = customers.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            // Create CSV content
            let csv = 'Customer Name,Email,Phone,Invoices,Total Spent,Avg Order Value,Last Purchase,Status,Tags\n';
            customersWithStats.forEach(c => {
                const tags = (c.tags || []).join('; ');
                csv += `"${c.name}","${c.email}","${c.phone}",${c.ordersCount},${c.totalPurchases.toFixed(2)},${c.avgOrderValue.toFixed(2)},${c.lastPurchaseDate || 'N/A'},"${c.statusLabel}","${tags}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`Exported ${customersWithStats.length} customers to CSV!`);
        }

        function getCustomerStatus(totalPurchases) {
            if (totalPurchases >= 5000) {
                return { label: 'VIP Customer', color: 'bg-green-100 text-green-800', icon: 'fa-crown' };
            } else if (totalPurchases >= 1000) {
                return { label: 'Regular Customer', color: 'bg-blue-100 text-blue-800', icon: 'fa-user' };
            } else {
                return { label: 'New Customer', color: 'bg-yellow-100 text-yellow-800', icon: 'fa-user-plus' };
            }
        }

        function showProductModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Product</h2>
                    <form onsubmit="event.preventDefault(); addProduct(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Product Name</label>
                                <input type="text" name="name" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">SKU</label>
                                <input type="text" name="sku" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Category</label>
                                <input type="text" name="category" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Price</label>
                                <input type="number" step="0.01" name="price" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Stock</label>
                                <input type="number" name="stock" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Barcode</label>
                                <input type="text" name="barcode" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Emoji Icon</label>
                                <input type="text" name="image" value="ðŸ“¦" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Add Product</button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addProduct(form) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const newProduct = {
                id: Math.max(0, ...products.map(p => p.id)) + 1,
                name: form.name.value,
                sku: form.sku.value,
                category: form.category.value,
                price: parseFloat(form.price.value),
                stock: parseInt(form.stock.value),
                barcode: form.barcode.value,
                image: form.image.value
            };
            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));
            store.navigate('products');
        }

        function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const filtered = products.filter(p => p.id !== id);
            localStorage.setItem('products', JSON.stringify(filtered));
            store.navigate('products');
        }

        function showCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Customer</h2>
                    <form onsubmit="event.preventDefault(); addCustomer(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <input type="text" name="name" placeholder="Full Name" required class="w-full px-4 py-2 border rounded-lg">
                            <input type="email" name="email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg">
                            <input type="tel" name="phone" placeholder="Phone" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Add</button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 py-2 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addCustomer(form) {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            customers.push({
                id: Math.max(0, ...customers.map(c => c.id)) + 1,
                name: form.name.value,
                email: form.email.value,
                phone: form.phone.value,
                totalPurchases: 0,
                lastPurchase: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('customers', JSON.stringify(customers));
            store.navigate('customers');
        }

        function saveSettings() {
            const settings = {
                businessName: document.getElementById('businessName').value,
                taxRate: parseFloat(document.getElementById('taxRate').value),
                currency: document.getElementById('currency').value,
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            store.setState({ settings });
            alert('Settings saved successfully!');
        }

        function exportData() {
            const data = {
                products: localStorage.getItem('products'),
                customers: localStorage.getItem('customers'),
                invoices: localStorage.getItem('invoices'),
                settings: localStorage.getItem('settings')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quickbill-data.json';
            a.click();
        }

        function resetData() {
            localStorage.clear();
            store.initData();
            store.navigate('dashboard');
        }

        function showPurchaseOrderModal() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">New Purchase Order</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); createPurchaseOrder(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Supplier Name</label>
                                <input type="text" name="supplier" required class="input-field" placeholder="Enter supplier name">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Date</label>
                                <input type="date" name="date" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Items</label>
                                <div id="poItems" class="space-y-3 mb-3">
                                    <div class="flex gap-2 items-end">
                                        <div class="flex-1">
                                            <select name="product" class="input-field" required>
                                                <option value="">Select Product</option>
                                                ${products.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div style="width: 120px;">
                                            <input type="number" name="qty" placeholder="Qty" required class="input-field" min="1">
                                        </div>
                                        <div style="width: 120px;">
                                            <input type="number" name="cost" placeholder="Cost" required class="input-field" step="0.01" min="0">
                                        </div>
                                        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" onclick="addPOItem()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-plus mr-2"></i>Add Item
                                </button>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Upload Document</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition cursor-pointer" onclick="document.getElementById('poFileUpload').click()">
                                    <input type="file" id="poFileUpload" name="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 text-sm mb-1">Click to upload or drag and drop</p>
                                    <p class="text-gray-400 text-xs">PDF, JPG, PNG, DOC, DOCX (Max 10MB)</p>
                                    <div id="poFileName" class="mt-2 text-sm text-indigo-600 font-semibold hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-save mr-2"></i>Create Purchase Order
                            </button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle file upload display
            const fileInput = document.getElementById('poFileUpload');
            const fileNameDisplay = document.getElementById('poFileName');
            if (fileInput && fileNameDisplay) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        fileNameDisplay.textContent = file.name;
                        fileNameDisplay.classList.remove('hidden');
                    } else {
                        fileNameDisplay.classList.add('hidden');
                    }
                });
            }
        }

        function addPOItem() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const container = document.getElementById('poItems');
            const newItem = document.createElement('div');
            newItem.className = 'flex gap-2 items-end';
            newItem.innerHTML = `
                <div class="flex-1">
                    <select name="product" class="input-field" required>
                        <option value="">Select Product</option>
                        ${products.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('')}
                    </select>
                </div>
                <div style="width: 120px;">
                    <input type="number" name="qty" placeholder="Qty" required class="input-field" min="1">
                </div>
                <div style="width: 120px;">
                    <input type="number" name="cost" placeholder="Cost" required class="input-field" step="0.01" min="0">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newItem);
        }

        function createPurchaseOrder(form) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const items = [];
            let total = 0;
            
            const itemRows = form.querySelectorAll('#poItems > div');
            itemRows.forEach(row => {
                const productId = parseInt(row.querySelector('[name="product"]').value);
                const qty = parseInt(row.querySelector('[name="qty"]').value);
                const cost = parseFloat(row.querySelector('[name="cost"]').value);
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    items.push({ name: product.name, qty, cost });
                    total += cost * qty;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const newPO = {
                id: `PO-${String(purchaseOrders.length + 1).padStart(3, '0')}`,
                date: form.date.value,
                supplier: form.supplier.value,
                items,
                total,
                status: 'pending'
            };
            
            purchaseOrders.push(newPO);
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            alert(`Purchase Order ${newPO.id} created successfully!`);
            store.navigate('inventory');
        }

        function completePurchaseOrder(poId) {
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const po = purchaseOrders.find(p => p.id === poId);
            
            if (!po) return;
            
            po.items.forEach(poItem => {
                const product = products.find(p => p.name === poItem.name);
                if (product) {
                    product.stock += poItem.qty;
                }
            });
            
            po.status = 'completed';
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            localStorage.setItem('products', JSON.stringify(products));
            alert(`Purchase Order ${poId} completed! Inventory updated.`);
            store.navigate('inventory');
        }

        function deletePurchaseOrder(poId) {
            if (!confirm('Delete this purchase order?')) return;
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const filtered = purchaseOrders.filter(p => p.id !== poId);
            localStorage.setItem('purchaseOrders', JSON.stringify(filtered));
            alert('Purchase order deleted!');
            store.navigate('inventory');
        }

        function showReturnExchangeModal() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">Return / Exchange</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); processReturnExchange(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Select Invoice</label>
                                <select id="returnInvoice" name="invoiceId" class="input-field" required onchange="loadInvoiceItems(this.value)">
                                    <option value="">Select Invoice</option>
                                    ${invoices.map(inv => `<option value="${inv.id}">${inv.id} - ${inv.customer} (${inv.date})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Type</label>
                                <select name="type" class="input-field" required>
                                    <option value="return">Return</option>
                                    <option value="exchange">Exchange</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Items to Return/Exchange</label>
                                <div id="returnItems" class="space-y-3">
                                    <p class="text-muted text-center py-4">Select an invoice first</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="btn" style="background: var(--danger); color: white; flex: 1;">
                                <i class="fas fa-undo mr-2"></i>Process Return/Exchange
                            </button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function loadInvoiceItems(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const container = document.getElementById('returnItems');
            
            if (!invoice) {
                container.innerHTML = '<p class="text-muted text-center py-4">Invoice not found</p>';
                return;
            }
            
            container.innerHTML = invoice.items.map((item, index) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div style="font-weight: 600; font-size: 16px;">${item.name}</div>
                            <div class="text-small">Qty: ${item.qty} | Price: ${formatCurrency(item.price)}</div>
                        </div>
                        <label class="flex items-center">
                            <input type="checkbox" name="returnItem" value="${index}" class="mr-2">
                            <span class="text-sm">Return</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Return Quantity</label>
                        <input type="number" name="returnQty_${index}" placeholder="Qty to return" class="input-field" min="1" max="${item.qty}" value="${item.qty}">
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Reason</label>
                        <select name="reason_${index}" class="input-field">
                            <option value="Defective">Defective</option>
                            <option value="Wrong Item">Wrong Item</option>
                            <option value="Customer Request">Customer Request</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        function processReturnExchange(form) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            const invoiceId = form.invoiceId.value;
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const type = form.type.value;
            
            if (!invoice) {
                alert('Invoice not found!');
                return;
            }
            
            const returnItems = [];
            let total = 0;
            const checkedItems = form.querySelectorAll('input[name="returnItem"]:checked');
            
            if (checkedItems.length === 0) {
                alert('Please select at least one item to return');
                return;
            }
            
            checkedItems.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const item = invoice.items[index];
                const qty = parseInt(form.querySelector(`[name="returnQty_${index}"]`).value) || item.qty;
                const reason = form.querySelector(`[name="reason_${index}"]`).value;
                
                if (qty > 0 && qty <= item.qty) {
                    returnItems.push({
                        name: item.name,
                        qty: qty,
                        price: item.price,
                        reason: reason
                    });
                    total += item.price * qty;
                }
            });
            
            if (returnItems.length === 0) {
                alert('Please select valid items to return');
                return;
            }
            
            const newReturn = {
                id: `RET-${String(returns.length + 1).padStart(3, '0')}`,
                invoiceId: invoiceId,
                date: new Date().toISOString().split('T')[0],
                customer: invoice.customer,
                items: returnItems,
                total: total,
                status: 'pending',
                type: type
            };
            
            returns.push(newReturn);
            localStorage.setItem('returns', JSON.stringify(returns));
            alert(`${type === 'return' ? 'Return' : 'Exchange'} ${newReturn.id} created successfully!`);
            store.navigate('inventory');
        }

        function completeReturn(retId) {
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const ret = returns.find(r => r.id === retId);
            
            if (!ret) return;
            
            // Update inventory - add items back to stock
            ret.items.forEach(retItem => {
                const product = products.find(p => p.name === retItem.name);
                if (product) {
                    product.stock += retItem.qty;
                }
            });
            
            ret.status = 'completed';
            localStorage.setItem('returns', JSON.stringify(returns));
            localStorage.setItem('products', JSON.stringify(products));
            alert(`Return ${retId} completed! Inventory updated.`);
            store.navigate('inventory');
        }

        function setReportFilter(filterName, value) {
            const currentFilters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // If quick filter is set, clear date range
            if (filterName === 'quickFilter' && value !== 'all') {
                currentFilters.dateFrom = '';
                currentFilters.dateTo = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
            }
            
            // If date range is set, clear quick filter
            if ((filterName === 'dateFrom' || filterName === 'dateTo') && value) {
                currentFilters.quickFilter = 'all';
                document.getElementById('quickFilter').value = 'all';
            }
            
            currentFilters[filterName] = value;
            store.setState({ reportFilters: currentFilters });
            localStorage.setItem('reportFilters', JSON.stringify(currentFilters));
            store.navigate('reports');
        }

        function clearReportFilters() {
            const defaultFilters = {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            store.setState({ reportFilters: defaultFilters });
            localStorage.setItem('reportFilters', JSON.stringify(defaultFilters));
            store.navigate('reports');
        }

        function setInventoryFilter(filterName, value) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: ''
            };
            currentFilters[filterName] = value;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearPOFilters() {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.poStatus = '';
            currentFilters.poDateFrom = '';
            currentFilters.poDateTo = '';
            currentFilters.poSupplier = '';
            currentFilters.poSearch = '';
            // Clear search input
            const searchInput = document.getElementById('poSearch');
            if (searchInput) searchInput.value = '';
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearReturnFilters() {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.returnStatus = '';
            currentFilters.returnType = '';
            currentFilters.returnDateFrom = '';
            currentFilters.returnDateTo = '';
            currentFilters.returnSearch = '';
            // Clear search input
            const searchInput = document.getElementById('returnSearch');
            if (searchInput) searchInput.value = '';
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function filterPurchaseOrders(searchTerm) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.poSearch = searchTerm;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function filterReturnsExchanges(searchTerm) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.returnSearch = searchTerm;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function exportSlowMovingStock() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Calculate slow-moving products (same logic as InventoryPage)
            const today = new Date();
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setDate(today.getDate() - 90);
            
            const recentSales = {};
            invoices.forEach(inv => {
                const invDate = new Date(inv.date);
                if (invDate >= ninetyDaysAgo) {
                    inv.items.forEach(item => {
                        if (!recentSales[item.name]) {
                            recentSales[item.name] = 0;
                        }
                        recentSales[item.name] += item.qty;
                    });
                }
            });
            
            const slowMovingProducts = products.filter(product => {
                const hasRecentSales = recentSales[product.name] > 0;
                return !hasRecentSales && product.stock > 0;
            }).map(product => ({
                ...product,
                stockValue: product.stock * product.price
            }));
            
            // Create CSV content
            let csv = 'Product Name,SKU,Category,Current Stock,Unit Price,Stock Value,Status\n';
            slowMovingProducts.forEach(product => {
                csv += `"${product.name}","${product.sku}","${product.category}",${product.stock},${product.price.toFixed(2)},${product.stockValue.toFixed(2)},"Not Moving"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `slow-moving-stock-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`Exported ${slowMovingProducts.length} slow-moving products to CSV!`);
        }

        function exportAllStockData() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const searchInput = document.getElementById('stockSearch');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            // Filter products if search term exists
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.sku.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm) ||
                    p.barcode.includes(searchTerm)
                );
            }
            
            // Create CSV content
            let csv = 'Product Name,SKU,Category,Current Stock,Unit Price,Stock Value,Barcode,Status\n';
            filteredProducts.forEach(product => {
                const stockValue = product.stock * product.price;
                const stockStatus = product.stock === 0 ? 'Out of Stock' : product.stock < 10 ? 'Low Stock' : 'In Stock';
                csv += `"${product.name}","${product.sku}","${product.category}",${product.stock},${product.price.toFixed(2)},${stockValue.toFixed(2)},"${product.barcode}","${stockStatus}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = searchTerm ? `all-stock-data-filtered-${new Date().toISOString().split('T')[0]}.csv` : `all-stock-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.download = fileName;
            a.click();
            alert(`Exported ${filteredProducts.length} products to CSV!`);
        }

        function exportReport() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const filters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // Combine all transactions with type labels (same as ReportsPage)
            let allTransactions = [
                ...invoices.map(inv => ({ ...inv, transactionType: 'sale', typeLabel: 'Sale' })),
                ...purchaseOrders.map(po => ({ ...po, transactionType: 'purchase', typeLabel: 'Purchase', customer: po.supplier || 'N/A', payment: 'N/A', discount: 0, tax: 0 })),
                ...returns.map(ret => ({ ...ret, transactionType: 'return', typeLabel: ret.type === 'return' ? 'Return' : 'Exchange', payment: 'N/A', discount: 0, tax: 0 }))
            ];
            
            // Apply same filters as in ReportsPage
            let filteredTransactions = [...allTransactions];
            
            // Order type filter
            if (filters.orderType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.transactionType === filters.orderType);
            }
            
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                if (filters.quickFilter === 'today') {
                    const todayStr = today.toISOString().split('T')[0];
                    filteredTransactions = filteredTransactions.filter(t => t.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= weekAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= monthAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= yearAgo && tDate <= today;
                    });
                }
            }
            
            if (filters.dateFrom) filteredTransactions = filteredTransactions.filter(t => t.date >= filters.dateFrom);
            if (filters.dateTo) filteredTransactions = filteredTransactions.filter(t => t.date <= filters.dateTo);
            if (filters.paymentMethod) filteredTransactions = filteredTransactions.filter(t => t.payment === filters.paymentMethod);
            
            // Create CSV content
            let csv = 'Type,ID,Customer/Supplier,Date,Items,Subtotal,Discount,Tax,Total,Payment\n';
            filteredTransactions.forEach(t => {
                const items = t.items.map(item => `${item.name} (${item.qty}x)`).join('; ');
                const customerSupplier = t.customer || t.supplier || 'N/A';
                const payment = t.payment && t.payment !== 'N/A' ? t.payment : '-';
                csv += `${t.typeLabel},${t.id},"${customerSupplier}",${t.date},"${items}",${t.subtotal || t.total},${t.discount || 0},${t.tax || 0},${t.total},${payment}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert('Report exported successfully!');
        }

        let dateTimeInterval = null;

        function handleDashboardSearch(event) {
            if (event.key === 'Enter') {
                const searchInput = document.getElementById('dashboardProductSearch');
                const searchTerm = searchInput.value.trim();
                
                if (searchTerm) {
                    // Store search term to use in POS page
                    sessionStorage.setItem('posSearchTerm', searchTerm);
                    // Navigate to POS checkout page
                    store.navigate('pos');
                }
            }
        }

        function handleDashboardSearchClick() {
            const searchInput = document.getElementById('dashboardProductSearch');
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm) {
                // Store search term to use in POS page
                sessionStorage.setItem('posSearchTerm', searchTerm);
                // Navigate to POS checkout page
                store.navigate('pos');
            } else {
                // If empty, just navigate to POS page
                store.navigate('pos');
            }
        }

        function updateDashboardDateTime() {
            const dateElement = document.getElementById('dashboardDate');
            const timeElement = document.getElementById('dashboardTime');
            
            if (dateElement && timeElement) {
                const now = new Date();
                
                // Format date: Monday, December 16, 2024
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
                
                // Format time: HH:MM:SS AM/PM
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                timeElement.textContent = now.toLocaleTimeString('en-US', timeOptions);
            }
        }

        function render() {
            const state = store.getState();
            let html = '';
            if (!state.isLoggedIn) {
                switch (state.currentPage) {
                    case 'features': html = FeaturesPage(); break;
                    case 'pricing': html = PricingPage(); break;
                    case 'about': html = AboutPage(); break;
                    case 'contact': html = ContactPage(); break;
                    default: html = HomePage();
                }
            } else {
                switch (state.currentPage) {
                    case 'dashboard': html = Dashboard(); break;
                    case 'pos': html = POSPage(); break;
                    case 'products': html = ProductsPage(); break;
                    case 'inventory': html = InventoryPage(); break;
                    case 'customers': html = CustomersPage(); break;
                    case 'invoices': html = InvoicesPage(); break;
                    case 'reports': html = ReportsPage(); break;
                    case 'settings': html = SettingsPage(); break;
                    default: html = Dashboard();
                }
            }
            document.getElementById('app').innerHTML = html;
            
            // Update date and time if on dashboard
            if (state.isLoggedIn && state.currentPage === 'dashboard') {
                // Clear existing interval if any
                if (dateTimeInterval) {
                    clearInterval(dateTimeInterval);
                }
                updateDashboardDateTime();
                // Update time every second
                dateTimeInterval = setInterval(updateDashboardDateTime, 1000);
            } else {
                // Clear interval when not on dashboard
                if (dateTimeInterval) {
                    clearInterval(dateTimeInterval);
                    dateTimeInterval = null;
                }
            }
            
            // Handle search term from dashboard to POS
            if (state.isLoggedIn && state.currentPage === 'pos') {
                const searchTerm = sessionStorage.getItem('posSearchTerm');
                if (searchTerm) {
                    const posSearchInput = document.getElementById('productSearch');
                    if (posSearchInput) {
                        posSearchInput.value = searchTerm;
                        // Trigger search filter
                        filterProducts(searchTerm);
                        // Clear the stored search term
                        sessionStorage.removeItem('posSearchTerm');
                    }
                }
            }
        }

        store.subscribe(render);
        render();
    </script>
</body>
</html>
