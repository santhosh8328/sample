<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBill - Professional Billing Software</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            /* Professional Color Palette */
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Gray Scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-xs: 0.75rem;    /* 12px */
            --font-size-sm: 0.875rem;   /* 14px */
            --font-size-base: 1rem;     /* 16px */
            --font-size-lg: 1.125rem;   /* 18px */
            --font-size-xl: 1.25rem;    /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 1.875rem; /* 30px */
            --font-size-4xl: 2.25rem;  /* 36px */
            --font-size-5xl: 3rem;     /* 48px */
            
            /* Spacing */
            --spacing-xs: 0.25rem;   /* 4px */
            --spacing-sm: 0.5rem;    /* 8px */
            --spacing-md: 1rem;      /* 16px */
            --spacing-lg: 1.5rem;    /* 24px */
            --spacing-xl: 2rem;      /* 32px */
            --spacing-2xl: 3rem;     /* 48px */
            --spacing-3xl: 4rem;     /* 64px */
            
            /* Border Radius */
            --radius-sm: 0.375rem;   /* 6px */
            --radius-md: 0.5rem;     /* 8px */
            --radius-lg: 0.75rem;    /* 12px */
            --radius-xl: 1rem;       /* 16px */
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            font-family: var(--font-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }

        body {
            background: var(--gray-50);
            color: var(--gray-900);
            font-size: var(--font-size-base);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* Typography Scale */
        h1 {
            font-size: var(--font-size-4xl);
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
            color: var(--gray-900);
            margin: 0;
        }

        h2 {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.01em;
            color: var(--gray-900);
            margin: 0;
        }

        h3 {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            line-height: 1.4;
            color: var(--gray-800);
            margin: 0;
        }

        h4 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            line-height: 1.4;
            color: var(--gray-800);
            margin: 0;
        }

        p {
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--gray-700);
            margin: 0;
        }

        /* Professional Gradient */
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, #1e3a8a 100%);
        }

        /* Card Styles */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        /* Sidebar Active State */
        .sidebar-active {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        /* Professional Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: var(--font-size-base);
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Professional Payment Options */
        .payment-option-btn {
            min-height: 70px;
        }

        .payment-option-btn.selected {
            background: #10b981 !important;
            border-color: #10b981 !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
        }

        .payment-option-btn.selected div {
            color: white !important;
        }

        .payment-option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .payment-option-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
            border-color: var(--gray-300) !important;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Input Fields */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: all 0.2s ease;
            background: white;
            font-family: var(--font-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }


        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg);
            transition: all 0.3s ease;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
            }
        }

        /* Animations */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Table Styles */
        .table-header {
            background: var(--gray-50);
            font-weight: 600;
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-700);
            padding: var(--spacing-md);
            text-align: left;
        }

        .table-cell {
            padding: var(--spacing-md);
            font-size: var(--font-size-base);
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
            text-align: left;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Navigation */
        .nav-link {
            color: var(--gray-600);
            font-weight: 500;
            font-size: var(--font-size-base);
            transition: color 0.2s ease;
            text-decoration: none;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        /* Logo */
        .logo-text {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.02em;
        }

        /* Text Utilities */
        .text-muted {
            color: var(--gray-600);
            font-size: var(--font-size-base);
        }

        .text-small {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }

        /* Price Display */
        .price-display {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        class Store {
            constructor() {
                this.state = {
                    currentPage: 'home',
                    isLoggedIn: false,
                    cart: [],
                    selectedCustomer: null,
                    selectedCustomerForView: null, // For viewing customer invoices
                    discount: 0,
                    discountType: 'percentage', // 'percentage' or 'fixed'
                    exchangeCredit: 0, // Credit amount from exchange returns
                    currentReturnId: null, // ID of return/exchange being processed from POS
                    heldOrders: JSON.parse(localStorage.getItem('heldOrders') || '[]'),
                    reportFilters: JSON.parse(localStorage.getItem('reportFilters') || 'null') || {
                        dateFrom: '',
                        dateTo: '',
                        paymentMethod: '',
                        customer: '',
                        orderType: 'all',
                        quickFilter: 'all'
                    },
                    customerFilters: JSON.parse(localStorage.getItem('customerFilters') || 'null') || {
                        status: '',
                        dateFrom: '',
                        dateTo: '',
                        purchaseAmountMin: '',
                        purchaseAmountMax: ''
                    },
                    customerSort: JSON.parse(localStorage.getItem('customerSort') || 'null') || {
                        field: 'totalSpent',
                        order: 'desc'
                    },
                    posFilters: JSON.parse(localStorage.getItem('posFilters') || 'null') || {
                        category: '',
                        stockStatus: '',
                        priceMin: '',
                        priceMax: '',
                        sortBy: 'name'
                    },
                    inventoryFilters: JSON.parse(localStorage.getItem('inventoryFilters') || 'null') || {
                        poStatus: '',
                        poDateFrom: '',
                        poDateTo: '',
                        poSupplier: '',
                        poAmountMin: '',
                        poAmountMax: '',
                        poSearch: '',
                        returnStatus: '',
                        returnType: '',
                        returnDateFrom: '',
                        returnDateTo: '',
                        returnCustomer: '',
                        returnAmountMin: '',
                        returnAmountMax: '',
                        returnSearch: ''
                    },
                    invoiceFilters: JSON.parse(localStorage.getItem('invoiceFilters') || 'null') || {
                        search: '',
                        dateFrom: '',
                        dateTo: '',
                        customer: '',
                        paymentMethod: '',
                        amountMin: '',
                        amountMax: '',
                        quickFilter: 'all'
                    },
                    settings: JSON.parse(localStorage.getItem('settings')) || {
                        businessName: 'QuickBill',
                        logo: '',
                        taxRate: 10,
                        currency: 'INR'
                    }
                };
                this.listeners = [];
                this.initData();
            }

            initData() {
                if (!localStorage.getItem('products')) {
                    localStorage.setItem('products', JSON.stringify([
                        { id: 1, name: 'Laptop Pro 15"', sku: 'LAP001', category: 'Electronics', price: 1299.99, stock: 15, barcode: '1234567890123', image: 'ðŸ’»' },
                        { id: 2, name: 'Wireless Mouse', sku: 'MOU001', category: 'Accessories', price: 29.99, stock: 50, barcode: '1234567890124', image: 'ðŸ–±ï¸' },
                        { id: 3, name: 'Mechanical Keyboard', sku: 'KEY001', category: 'Accessories', price: 89.99, stock: 8, barcode: '1234567890125', image: 'âŒ¨ï¸' },
                        { id: 4, name: 'USB-C Hub', sku: 'HUB001', category: 'Accessories', price: 49.99, stock: 25, barcode: '1234567890126', image: 'ðŸ”Œ' },
                        { id: 5, name: 'Smartphone X', sku: 'PHO001', category: 'Electronics', price: 899.99, stock: 20, barcode: '1234567890127', image: 'ðŸ“±' },
                        { id: 6, name: 'Tablet Air', sku: 'TAB001', category: 'Electronics', price: 599.99, stock: 12, barcode: '1234567890128', image: 'ðŸ“±' },
                        { id: 7, name: 'Wireless Headphones', sku: 'HEAD001', category: 'Audio', price: 199.99, stock: 30, barcode: '1234567890129', image: 'ðŸŽ§' },
                        { id: 8, name: 'Smart Watch', sku: 'WAT001', category: 'Wearables', price: 349.99, stock: 18, barcode: '1234567890130', image: 'âŒš' },
                        { id: 9, name: 'External SSD 1TB', sku: 'SSD001', category: 'Storage', price: 149.99, stock: 5, barcode: '1234567890131', image: 'ðŸ’¾' },
                        { id: 10, name: 'Webcam HD', sku: 'CAM001', category: 'Accessories', price: 79.99, stock: 22, barcode: '1234567890132', image: 'ðŸ“·' }
                    ]));
                }

                if (!localStorage.getItem('customers')) {
                    localStorage.setItem('customers', JSON.stringify([
                        { id: 1, name: 'John Smith', email: 'john@email.com', phone: '555-0101', totalPurchases: 2450.50, lastPurchase: '2024-01-15' },
                        { id: 2, name: 'Sarah Johnson', email: 'sarah@email.com', phone: '555-0102', totalPurchases: 1230.00, lastPurchase: '2024-01-14' },
                        { id: 3, name: 'Mike Davis', email: 'mike@email.com', phone: '555-0103', totalPurchases: 3450.75, lastPurchase: '2024-01-13' },
                        { id: 4, name: 'Emily Brown', email: 'emily@email.com', phone: '555-0104', totalPurchases: 890.25, lastPurchase: '2024-01-12' },
                        { id: 5, name: 'David Wilson', email: 'david@email.com', phone: '555-0105', totalPurchases: 5230.00, lastPurchase: '2024-01-11' }
                    ]));
                }

                if (!localStorage.getItem('invoices')) {
                    localStorage.setItem('invoices', JSON.stringify([
                        { id: 'INV-001', date: '2024-01-15', customer: 'John Smith', items: [{ name: 'Laptop Pro 15"', qty: 1, price: 1299.99 }], subtotal: 1299.99, tax: 129.99, discount: 0, total: 1429.98, payment: 'Card', status: 'completed' },
                        { id: 'INV-002', date: '2024-01-14', customer: 'Sarah Johnson', items: [{ name: 'Wireless Mouse', qty: 2, price: 29.99 }, { name: 'USB-C Hub', qty: 1, price: 49.99 }], subtotal: 109.97, tax: 10.99, discount: 0, total: 120.96, payment: 'Cash', status: 'completed' },
                        { id: 'INV-003', date: '2024-01-13', customer: 'Mike Davis', items: [{ name: 'Smartphone X', qty: 1, price: 899.99 }], subtotal: 899.99, tax: 89.99, discount: 0, total: 989.98, payment: 'Card', status: 'completed' }
                    ]));
                }
                
                if (!localStorage.getItem('coupons')) {
                    localStorage.setItem('coupons', JSON.stringify([
                        { code: 'WELCOME10', discount: 10, type: 'percentage', valid: true },
                        { code: 'SAVE50', discount: 50, type: 'fixed', valid: true },
                        { code: 'SUMMER20', discount: 20, type: 'percentage', valid: true }
                    ]));
                }
                
                if (!localStorage.getItem('purchaseOrders')) {
                    localStorage.setItem('purchaseOrders', JSON.stringify([
                        { id: 'PO-001', date: '2024-01-10', supplier: 'Tech Supplies Inc', items: [{ name: 'Laptop Pro 15"', qty: 10, cost: 1000 }], total: 10000, status: 'completed' },
                        { id: 'PO-002', date: '2024-01-12', supplier: 'Accessories Co', items: [{ name: 'Wireless Mouse', qty: 50, cost: 20 }], total: 1000, status: 'pending' }
                    ]));
                }
                
                if (!localStorage.getItem('returns')) {
                    localStorage.setItem('returns', JSON.stringify([
                        { id: 'RET-001', invoiceId: 'INV-001', date: '2024-01-16', customer: 'John Smith', items: [{ name: 'Laptop Pro 15"', qty: 1, price: 1299.99, reason: 'Defective' }], total: 1299.99, status: 'completed', type: 'return' }
                    ]));
                }
            }

            subscribe(listener) { this.listeners.push(listener); }
            setState(newState) { 
                this.state = { ...this.state, ...newState }; 
                this.listeners.forEach(listener => listener(this.state)); 
            }
            getState() { return this.state; }
            navigate(page) { this.setState({ currentPage: page }); window.scrollTo(0, 0); }
            login() { this.setState({ isLoggedIn: true, currentPage: 'dashboard' }); }
            logout() { this.setState({ isLoggedIn: false, currentPage: 'home' }); }
            render() { 
                try {
                    if (typeof render === 'function') {
                        render();
                    }
                } catch (error) {
                    console.error('Error in store.render():', error);
                }
            }
        }

        const store = new Store();

        function getCurrencySymbol() {
            const currency = store.getState().settings.currency;
            const symbols = { INR: 'â‚¹', USD: '$', EUR: 'â‚¬', GBP: 'Â£' };
            return symbols[currency] || currency + ' ';
        }

        function formatCurrency(amount) {
            return getCurrencySymbol() + amount.toFixed(2);
        }

        function MarketingHeader() {
            return `
                <header class="bg-white shadow-sm sticky top-0 z-50 no-print">
                    <nav class="container mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-receipt" style="font-size: 28px; color: var(--primary);"></i>
                                <span class="logo-text">QuickBill</span>
                            </div>
                            <div class="hidden md:flex space-x-8">
                                <a href="#" onclick="store.navigate('home')" class="nav-link">Home</a>
                                <a href="#" onclick="store.navigate('features')" class="nav-link">Features</a>
                                <a href="#" onclick="store.navigate('pricing')" class="nav-link">Pricing</a>
                                <a href="#" onclick="store.navigate('about')" class="nav-link">About</a>
                                <a href="#" onclick="store.navigate('contact')" class="nav-link">Contact</a>
                            </div>
                            <button onclick="store.login()" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login to POS
                            </button>
                        </div>
                    </nav>
                </header>
            `;
        }

        function HomePage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="gradient-bg text-white py-20">
                        <div class="container mx-auto px-6 text-center">
                            <h1 style="font-size: 3.5rem; font-weight: 800; color: white; margin-bottom: 1.5rem;">Professional Billing Software</h1>
                            <p style="font-size: 1.5rem; font-weight: 400; margin-bottom: 2.5rem; opacity: 0.95;">Streamline your business with our powerful, easy-to-use billing solution</p>
                            <div class="flex justify-center space-x-4">
                                <button onclick="store.login()" class="bg-white text-indigo-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition">
                                    Get Started Free
                                </button>
                                <button onclick="store.navigate('features')" class="border-2 border-white text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-white hover:text-indigo-600 transition">
                                    Learn More
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h2 class="text-4xl font-bold text-center mb-16 text-gray-800" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 4rem;">Why Choose QuickBill?</h2>
                            <div class="grid md:grid-cols-3 gap-8">
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-bolt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Lightning Fast</h3>
                                    <p class="text-gray-600">Process transactions in seconds with our optimized interface</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-chart-line text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Real-time Analytics</h3>
                                    <p class="text-gray-600">Track sales, inventory, and customer insights instantly</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-mobile-alt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Fully Responsive</h3>
                                    <p class="text-gray-600">Works seamlessly on desktop, tablet, and mobile devices</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-users text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Customer Management</h3>
                                    <p class="text-gray-600">Build lasting relationships with comprehensive customer profiles</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-boxes text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Inventory Control</h3>
                                    <p class="text-gray-600">Never run out of stock with automated alerts and tracking</p>
                                </div>
                                <div class="text-center p-6 card-hover rounded-lg border border-gray-200">
                                    <i class="fas fa-shield-alt text-5xl text-indigo-600 mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Secure & Reliable</h3>
                                    <p class="text-gray-600">Your data is protected with industry-leading security</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-gray-100">
                        <div class="container mx-auto px-6">
                            <div class="grid md:grid-cols-4 gap-8 text-center">
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">10,000+</div>
                                    <div class="text-gray-600">Active Users</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">â‚¹400Cr+</div>
                                    <div class="text-gray-600">Processed Sales</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">99.9%</div>
                                    <div class="text-gray-600">Uptime</div>
                                </div>
                                <div>
                                    <div class="text-4xl font-bold text-indigo-600 mb-2">24/7</div>
                                    <div class="text-gray-600">Support</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h2 class="text-4xl font-bold text-center mb-16 text-gray-800">What Our Customers Say</h2>
                            <div class="grid md:grid-cols-3 gap-8">
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">JS</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Jane Smith</div>
                                            <div class="text-sm text-gray-600">Retail Store Owner</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700" style="font-size: 15px; line-height: 1.7;">"QuickBill transformed our business! The interface is intuitive and our checkout time has been cut in half."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">RC</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Robert Chen</div>
                                            <div class="text-sm text-gray-600">Restaurant Manager</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700">"The inventory management features are outstanding. We always know what's in stock and what needs to be ordered."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">ML</div>
                                        <div class="ml-4">
                                            <div class="font-semibold text-gray-800">Maria Lopez</div>
                                            <div class="text-sm text-gray-600">Boutique Owner</div>
                                        </div>
                                    </div>
                                    <p class="text-gray-700">"Best POS system I've used. The customer management features help us build better relationships with our clients."</p>
                                    <div class="mt-4 text-yellow-500">â˜…â˜…â˜…â˜…â˜…</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="gradient-bg text-white py-20">
                        <div class="container mx-auto px-6 text-center">
                            <h2 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem; color: white;">Ready to Get Started?</h2>
                            <p style="font-size: 1.25rem; margin-bottom: 2rem; opacity: 0.95; color: white;">Join thousands of businesses using QuickBill</p>
                            <button onclick="store.login()" class="bg-white text-indigo-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition">
                                Start Your Free Trial
                            </button>
                        </div>
                    </section>

                    ${Footer()}
                </main>
            `;
        }

        function FeaturesPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Powerful Features</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">Everything you need to run your business efficiently</p>
                            <div class="space-y-16">
                                <div class="flex flex-col md:flex-row items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-shopping-cart text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Fast Checkout</h2>
                                        <p class="text-gray-600 mb-4">Process sales quickly with our intuitive checkout interface. Add items with a click, apply discounts, and accept multiple payment methods.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Quick product search</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Barcode scanning support</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Multiple payment methods</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Automatic tax calculation</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-receipt text-9xl text-indigo-600"></i>
                                    </div>
                                </div>

                                <div class="flex flex-col md:flex-row-reverse items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-chart-bar text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Analytics Dashboard</h2>
                                        <p class="text-gray-600 mb-4">Get real-time insights into your business performance with comprehensive analytics and beautiful charts.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Sales trends and forecasting</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Top-selling products</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Customer insights</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Inventory analytics</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-chart-line text-9xl text-indigo-600"></i>
                                    </div>
                                </div>

                                <div class="flex flex-col md:flex-row items-center gap-8">
                                    <div class="md:w-1/2">
                                        <i class="fas fa-warehouse text-6xl text-indigo-600 mb-4"></i>
                                        <h2 class="text-3xl font-bold mb-4 text-gray-800">Inventory Management</h2>
                                        <p class="text-gray-600 mb-4">Keep track of your stock levels, get low-stock alerts, and manage products effortlessly.</p>
                                        <ul class="space-y-2 text-gray-600">
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Real-time stock tracking</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Low-stock notifications</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Category management</li>
                                            <li><i class="fas fa-check text-green-500 mr-2"></i>Bulk import/export</li>
                                        </ul>
                                    </div>
                                    <div class="md:w-1/2 bg-indigo-100 rounded-lg p-8 text-center">
                                        <i class="fas fa-boxes text-9xl text-indigo-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function PricingPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Simple, Transparent Pricing</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">Choose the plan that fits your business</p>
                            <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                                <div class="border-2 border-gray-200 rounded-lg p-8 card-hover">
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Starter</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹2,499<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Up to 100 products</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>1 user account</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Basic reports</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Email support</li>
                                    </ul>
                                    <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Get Started</button>
                                </div>

                                <div class="border-2 border-indigo-600 rounded-lg p-8 card-hover relative">
                                    <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-4 py-1 rounded-full text-sm">Popular</div>
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Professional</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹6,499<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Unlimited products</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>5 user accounts</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Advanced analytics</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Priority support</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Custom branding</li>
                                    </ul>
                                    <button class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Get Started</button>
                                </div>

                                <div class="border-2 border-gray-200 rounded-lg p-8 card-hover">
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Enterprise</h3>
                                    <div class="text-4xl font-bold mb-6 text-gray-800">â‚¹15,999<span class="text-lg text-gray-600">/mo</span></div>
                                    <ul class="space-y-3 mb-8 text-gray-600">
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Everything in Pro</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Unlimited users</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>Multi-location</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>API access</li>
                                        <li><i class="fas fa-check text-green-500 mr-2"></i>24/7 phone support</li>
                                    </ul>
                                    <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Contact Sales</button>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function AboutPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <div class="max-w-4xl mx-auto space-y-12">
                                <div>
                                    <h1 class="text-5xl font-bold text-center mb-6 text-gray-800" style="font-size: 3rem; font-weight: 700;">About QuickBill</h1>
                                    <p class="text-xl text-center text-gray-600" style="font-size: 1.125rem;">We're on a mission to make billing systems accessible, powerful, and easy to use for businesses of all sizes.</p>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800 text-center">Our Story</h2>
                                    <p class="text-gray-600 leading-relaxed text-center" style="font-size: 16px; line-height: 1.8;">Founded in 2020, QuickBill was born from the frustration of using outdated, complicated billing systems. We believed there had to be a better way â€“ something modern, intuitive, and built for today's businesses.</p>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800 text-center">Our Mission</h2>
                                    <p class="text-gray-600 leading-relaxed text-center" style="font-size: 16px; line-height: 1.8;">To empower businesses with technology that simplifies operations, provides actionable insights, and helps them grow. We believe every business deserves access to enterprise-level tools without the enterprise-level complexity.</p>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-bold mb-4 text-gray-800 text-center">Our Values</h2>
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800 text-center">Simplicity</h3>
                                            <p class="text-gray-600 text-center">We design for clarity and ease of use</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800 text-center">Innovation</h3>
                                            <p class="text-gray-600 text-center">We're always improving and evolving</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800 text-center">Reliability</h3>
                                            <p class="text-gray-600 text-center">Your business can count on us</p>
                                        </div>
                                        <div class="bg-gray-50 p-6 rounded-lg">
                                            <h3 class="font-semibold text-lg mb-2 text-gray-800 text-center">Support</h3>
                                            <p class="text-gray-600 text-center">We're here when you need us</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function ContactPage() {
            return `
                ${MarketingHeader()}
                <main class="animate-fade-in">
                    <section class="py-20 bg-white">
                        <div class="container mx-auto px-6">
                            <h1 class="text-5xl font-bold text-center mb-6 text-gray-800">Contact Us</h1>
                            <p class="text-xl text-center text-gray-600 mb-16">We'd love to hear from you</p>
                            <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-12">
                                <div>
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Get in Touch</h2>
                                    <div class="space-y-6">
                                        <div class="flex items-start">
                                            <i class="fas fa-map-marker-alt text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Address</div>
                                                <div class="text-gray-600">123 Business Street<br>San Francisco, CA 94105</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-phone text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Phone</div>
                                                <div class="text-gray-600">+1 (555) 123-4567</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-envelope text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Email</div>
                                                <div class="text-gray-600">support@smartpos.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-clock text-2xl text-indigo-600 mr-4 mt-1"></i>
                                            <div>
                                                <div class="font-semibold text-gray-800">Hours</div>
                                                <div class="text-gray-600">Mon-Fri: 9AM - 6PM PST<br>Sat-Sun: Closed</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <form class="space-y-4" onsubmit="event.preventDefault(); alert('Thank you for your message! (Demo only)');">
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Name</label>
                                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Email</label>
                                            <input type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Subject</label>
                                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2 font-medium">Message</label>
                                            <textarea rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" required></textarea>
                                        </div>
                                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                            Send Message
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                    ${Footer()}
                </main>
            `;
        }

        function Footer() {
            return `
                <footer class="bg-gray-900 text-white py-12">
                    <div class="container mx-auto px-6">
                        <div class="grid md:grid-cols-4 gap-8">
                            <div>
                                <div class="flex items-center space-x-3 mb-4">
                                    <i class="fas fa-receipt" style="font-size: 24px;"></i>
                                    <span class="logo-text" style="color: white;">QuickBill</span>
                                </div>
                                <p class="text-gray-400" style="font-size: 15px;">Modern billing system for modern businesses.</p>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Product</h3>
                                <ul class="space-y-2 text-gray-400">
                                    <li><a href="#" onclick="store.navigate('features')" class="hover:text-white transition">Features</a></li>
                                    <li><a href="#" onclick="store.navigate('pricing')" class="hover:text-white transition">Pricing</a></li>
                                    <li><a href="#" class="hover:text-white transition">Security</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Company</h3>
                                <ul class="space-y-2 text-gray-400">
                                    <li><a href="#" onclick="store.navigate('about')" class="hover:text-white transition">About</a></li>
                                    <li><a href="#" onclick="store.navigate('contact')" class="hover:text-white transition">Contact</a></li>
                                    <li><a href="#" class="hover:text-white transition">Careers</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-4">Connect</h3>
                                <div class="flex space-x-4 text-2xl">
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-linkedin"></i></a>
                                    <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                            <p>&copy; 2024 SmartPOS. All rights reserved.</p>
                        </div>
                    </div>
                </footer>
            `;
        }

        function POSSidebar() {
            const currentPage = store.getState().currentPage;
            return `
                <aside class="w-64 bg-white border-r border-gray-200 h-screen sticky top-0 no-print">
                    <div class="p-6">
                                <div class="flex items-center space-x-3 mb-8">
                            <i class="fas fa-receipt" style="font-size: 32px; color: var(--primary);"></i>
                            <span class="logo-text">QuickBill</span>
                        </div>
                        <nav class="space-y-2">
                            <a href="#" onclick="store.navigate('dashboard')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'dashboard' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                            <a href="#" onclick="store.navigate('pos')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'pos' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-shopping-cart"></i>
                                <span>POS / Checkout</span>
                            </a>
                            <a href="#" onclick="store.navigate('invoices')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'invoices' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-file-invoice"></i>
                                <span>Invoices</span>
                            </a>
                            <a href="#" onclick="store.navigate('customers')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'customers' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-users"></i>
                                <span>Customers</span>
                            </a>
                            <a href="#" onclick="store.navigate('products')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'products' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-box"></i>
                                <span>Products</span>
                            </a>
                            <a href="#" onclick="store.navigate('inventory')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'inventory' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-warehouse"></i>
                                <span>Inventory</span>
                            </a>
                            <a href="#" onclick="store.navigate('reports')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'reports' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                            <a href="#" onclick="store.navigate('campaigns')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'campaigns' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-bullhorn"></i>
                                <span>Campaigns</span>
                            </a>
                            <a href="#" onclick="store.navigate('settings')" class="flex items-center space-x-3 px-4 py-3 rounded-lg ${currentPage === 'settings' ? 'sidebar-active' : 'hover:bg-gray-100'} transition">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <a href="#" onclick="store.logout()" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 transition">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </nav>
                    </div>
                </aside>
            `;
        }

        function Dashboard() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate today's sales
            const todaySales = invoices
                .filter(inv => inv.date === today)
                .reduce((sum, inv) => sum + inv.total, 0);
            
            // Count today's invoices
            const todayInvoices = invoices.filter(inv => inv.date === today).length;
            
            // Total customers
            const totalCustomers = customers.length;
            
            const totalSales = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const lowStock = products.filter(p => p.stock < 10).length;
            const topProducts = [...products].sort((a, b) => b.stock - a.stock).slice(0, 5);
            const lowStockProducts = products.filter(p => p.stock < 10);

            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-gray-800" id="dashboardDate"></div>
                                <div class="text-sm text-gray-600" id="dashboardTime"></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Today's Sales</p>
                                        <p class="text-2xl font-bold text-gray-800">${formatCurrency(todaySales)}</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl text-green-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Total Customers</p>
                                        <p class="text-2xl font-bold text-gray-800">${totalCustomers}</p>
                                    </div>
                                    <i class="fas fa-users text-3xl text-blue-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Today's Invoices</p>
                                        <p class="text-2xl font-bold text-gray-800">${todayInvoices}</p>
                                    </div>
                                    <i class="fas fa-file-invoice text-3xl text-purple-500"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Low Stock Items</p>
                                        <p class="text-2xl font-bold text-gray-800">${lowStock}</p>
                                    </div>
                                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                            <div class="relative">
                                <input type="text" id="dashboardProductSearch" placeholder="Search products or scan barcode..." class="input-field" onkeypress="handleDashboardSearch(event)" style="padding-right: 45px;">
                                <button type="button" onclick="handleDashboardSearchClick()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                    <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Top Products</h2>
                                <div class="space-y-3">
                                    ${topProducts.map(p => `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">${p.image}</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">${p.name}</div>
                                                    <div class="text-sm text-gray-600">${p.category}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold text-gray-800">${formatCurrency(p.price)}</div>
                                                <div class="text-sm text-gray-600">Stock: ${p.stock}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                    Low Stock Alert
                                </h2>
                                <div class="space-y-3">
                                    ${lowStockProducts.length > 0 ? lowStockProducts.map(p => `
                                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">${p.image}</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">${p.name}</div>
                                                    <div class="text-sm text-gray-600">${p.category}</div>
                                                </div>
                                            </div>
                                            <div class="text-red-600 font-bold">
                                                ${p.stock} left
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-600 text-center py-8">All products are well stocked! ðŸŽ‰</p>'}
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm mt-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Recent Invoices</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Invoice ID</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Customer</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Total</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${invoices.slice(-5).reverse().map(inv => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-gray-800">${inv.id}</td>
                                                <td class="px-4 py-3 text-gray-800">${inv.customer}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.date}</td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(inv.total)}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">${inv.payment}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function POSPage() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const cart = store.getState().cart;
            const settings = store.getState().settings;
            const selectedCustomer = store.getState().selectedCustomer;
            const discount = store.getState().discount || 0;
            const discountType = store.getState().discountType || 'percentage';
            const exchangeCredit = store.getState().exchangeCredit || 0;
            const heldOrders = store.getState().heldOrders || [];
            const categories = [...new Set(products.map(p => p.category))];
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = (subtotal * discount) / 100;
            } else {
                discountAmount = discount;
            }
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const afterExchange = Math.max(0, afterDiscount - exchangeCredit);
            const tax = afterExchange * (settings.taxRate / 100);
            const total = afterExchange + tax;

            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">POS / Checkout</h1>
                            <div class="flex gap-2">
                                <button onclick="showHeldOrders()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-bookmark mr-2"></i>Held Orders (${heldOrders.length})
                                </button>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2">
                                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                                    <div class="mb-4 relative">
                                        <input type="text" id="productSearch" placeholder="Search products or scan barcode..." class="input-field" oninput="filterProducts(this.value)" style="padding-right: 45px;">
                                        <button type="button" onclick="scanBarcode()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                            <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                        </button>
                                </div>
                                </div>
                                <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-[600px] overflow-y-auto">
                                    ${products.map(p => `
                                        <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                                            <div style="font-size: 48px; margin-bottom: 12px; text-align: center;">${p.image}</div>
                                            <div style="font-weight: 600; font-size: 15px; color: var(--gray-900); margin-bottom: 4px;">${p.name}</div>
                                            <div class="text-small" style="margin-bottom: 8px;">${p.category}</div>
                                            <div class="price-display" style="font-size: 1.25rem;">${formatCurrency(p.price)}</div>
                                            <div class="text-small" style="margin-top: 4px;">Stock: ${p.stock}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm h-fit sticky top-8">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Current Order</h2>
                                
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Discount / Coupon</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="couponCode" placeholder="Enter coupon code" class="input-field flex-1" style="padding: 8px;">
                                        <button onclick="applyCoupon()" class="btn btn-primary" style="padding: 8px 16px;">
                                            <i class="fas fa-tag"></i>
                                        </button>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <input type="number" id="discountValue" placeholder="Discount" value="${discount}" class="input-field" style="padding: 8px; width: 60%;" onchange="setDiscount(this.value)">
                                        <select id="discountType" class="input-field" style="padding: 8px; width: 40%;" onchange="setDiscountType(this.value)">
                                            <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>%</option>
                                            <option value="fixed" ${discountType === 'fixed' ? 'selected' : ''}>Fixed</option>
                                        </select>
                                    </div>
                                    ${discount > 0 ? `<button onclick="removeDiscount()" class="mt-2 text-sm text-red-600 hover:text-red-800"><i class="fas fa-times mr-1"></i>Remove Discount</button>` : ''}
                                </div>

                                <div class="space-y-3 mb-6 max-h-[300px] overflow-y-auto">
                                    ${cart.length === 0 ? '<p class="text-muted text-center py-8" style="font-size: 15px;">Cart is empty</p>' : ''}
                                    ${cart.map((item, index) => `
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div class="flex-1">
                                                <div style="font-weight: 600; font-size: 15px; color: var(--gray-900);">${item.name}</div>
                                                <div class="text-small">${formatCurrency(item.price)} x ${item.qty}</div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="updateCartQty(${index}, -1)" style="width: 32px; height: 32px; background: var(--gray-200); border-radius: 6px; border: none; cursor: pointer; font-weight: 600;" onmouseover="this.style.background='var(--gray-300)';" onmouseout="this.style.background='var(--gray-200)';">-</button>
                                                <span style="width: 40px; text-align: center; font-weight: 600; font-size: 15px;">${item.qty}</span>
                                                <button onclick="updateCartQty(${index}, 1)" style="width: 32px; height: 32px; background: var(--gray-200); border-radius: 6px; border: none; cursor: pointer; font-weight: 600;" onmouseover="this.style.background='var(--gray-300)';" onmouseout="this.style.background='var(--gray-200)';">+</button>
                                                <button onclick="removeFromCart(${index})" style="width: 32px; height: 32px; background: var(--danger); color: white; border-radius: 6px; border: none; cursor: pointer; margin-left: 8px; font-weight: 600;" onmouseover="this.style.background='#dc2626';" onmouseout="this.style.background='var(--danger)';">Ã—</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="border-top: 1.5px solid var(--gray-200); padding-top: 1.5rem;">
                                    <div class="flex justify-between text-muted mb-2" style="font-size: 15px;">
                                        <span>Subtotal</span>
                                        <span>${formatCurrency(subtotal)}</span>
                                    </div>
                                    ${discountAmount > 0 ? `
                                        <div class="flex justify-between text-green-600 mb-2" style="font-size: 15px; font-weight: 600;">
                                            <span>Discount ${discountType === 'percentage' ? `(${discount}%)` : ''}</span>
                                            <span>-${formatCurrency(discountAmount)}</span>
                                        </div>
                                    ` : ''}
                                    ${exchangeCredit > 0 ? `
                                        <div class="flex justify-between text-blue-600 mb-2" style="font-size: 15px; font-weight: 600;">
                                            <span>Return/Exchange Credit</span>
                                            <span>-${formatCurrency(exchangeCredit)}</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex justify-between text-muted mb-4" style="font-size: 15px;">
                                        <span>Tax (${settings.taxRate}%)</span>
                                        <span>${formatCurrency(tax)}</span>
                                    </div>
                                    <div class="flex justify-between pt-4 border-t-2" style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">
                                        <span>Total</span>
                                        <span>${formatCurrency(total)}</span>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem;">Payment Methods</h3>
                                    <div class="grid grid-cols-2 gap-2 mb-4">
                                        <button onclick="selectPaymentMethod('Cash', this)" class="payment-option-btn" data-payment="Cash" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-money-bill-wave"></i></div>
                                            <div>Cash</div>
                                    </button>
                                        <button onclick="selectPaymentMethod('Card', this)" class="payment-option-btn" data-payment="Card" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-credit-card"></i></div>
                                            <div>Card</div>
                                    </button>
                                        <button onclick="selectPaymentMethod('UPI', this)" class="payment-option-btn" data-payment="UPI" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-qrcode"></i></div>
                                            <div>UPI</div>
                                        </button>
                                        <button onclick="selectPaymentMethod('Credit Note', this)" class="payment-option-btn" data-payment="Credit Note" ${cart.length === 0 ? 'disabled' : ''} style="background: white; border: 2px solid var(--gray-300); padding: 10px; border-radius: 10px; color: var(--gray-700); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden;" onmouseover="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-400)'; this.style.boxShadow='0 2px 6px rgba(0, 0, 0, 0.15)';}" onmouseout="if(!this.disabled && !this.classList.contains('selected')) {this.style.borderColor='var(--gray-300)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';}">
                                            <div style="font-size: 20px; color: var(--gray-600);"><i class="fas fa-file-invoice"></i></div>
                                            <div>Credit Note</div>
                                    </button>
                                    </div>
                                    <div class="space-y-2 mt-4">
                                        <button onclick="showReturnExchangeModal()" class="w-full" style="background: white; border: 2px solid var(--info); color: var(--info); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='var(--info)'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='var(--info)';">
                                            <i class="fas fa-exchange-alt"></i>Return / Exchange
                                        </button>
                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="holdOrder()" class="w-full" style="background: white; border: 2px solid var(--warning); color: var(--warning); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;" ${cart.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onmouseover="if(!this.disabled) {this.style.background='var(--warning)'; this.style.color='white';}" onmouseout="if(!this.disabled) {this.style.background='white'; this.style.color='var(--warning)';}">
                                                <i class="fas fa-bookmark"></i>Hold
                                            </button>
                                            <button onclick="clearCart()" class="w-full" style="background: white; border: 2px solid var(--gray-400); color: var(--gray-600); padding: 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;" ${cart.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onmouseover="if(!this.disabled) {this.style.background='var(--gray-200)'; this.style.borderColor='var(--gray-500)';}" onmouseout="if(!this.disabled) {this.style.background='white'; this.style.borderColor='var(--gray-400)';}">
                                                <i class="fas fa-trash"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function ProductsPage() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Products</h1>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="mb-4 relative">
                                <input type="text" id="searchProducts" placeholder="Search products or scan barcode..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterProductsList(this.value)" style="padding-right: 45px;">
                                <button type="button" onclick="scanBarcodeForProducts()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                    <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="productsTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Product</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">SKU</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Category</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Price</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Stock</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Barcode</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${products.map(p => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center space-x-3">
                                                        <span class="text-2xl">${p.image}</span>
                                                        <span class="font-semibold text-gray-800">${p.name}</span>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-gray-600">${p.sku}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${p.category}</span></td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(p.price)}</td>
                                                <td class="px-4 py-3">
                                                    <span class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-800'}">${p.stock}</span>
                                                    ${p.stock < 10 ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>' : ''}
                                                </td>
                                                <td class="px-4 py-3 text-gray-600 text-sm">${p.barcode}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function CustomersPage() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const selectedCustomerId = store.getState().selectedCustomerForView || null;
            const selectedCustomer = selectedCustomerId ? customers.find(c => c.id === selectedCustomerId) : null;
            const customerInvoices = selectedCustomer ? invoices.filter(inv => {
                // Match by customer name or phone
                return inv.customer === selectedCustomer.name || inv.customerPhone === selectedCustomer.phone;
            }) : [];
            const selectedCustomerStatus = selectedCustomer ? getCustomerStatus(selectedCustomer.totalPurchases) : null;
            
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            // Calculate orders, avg order value, last purchase date for each customer
            let customersWithStats = customers.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Customers</h1>
                            ${selectedCustomer ? `
                                <button onclick="clearCustomerSelection()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-times mr-2"></i>Clear Selection
                            </button>
                            ` : ''}
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div class="mb-4">
                                <input type="text" id="customerSearch" placeholder="Search customers..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterCustomersList(this.value)">
                            </div>
                            
                            <!-- Filters and Sort Section -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-bold text-gray-800">Filters & Sort</h3>
                                    <div class="flex gap-3">
                                        <button onclick="clearCustomerFilters()" class="text-sm text-gray-600 hover:text-gray-800 font-medium">
                                            <i class="fas fa-times mr-1"></i>Clear All
                                        </button>
                                        <button onclick="exportCustomersToCSV()" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">
                                            <i class="fas fa-download mr-1"></i>Export CSV
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-end gap-3">
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Status</label>
                                        <select id="filterStatus" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerFilter('status', this.value)">
                                            <option value="">All Status</option>
                                            <option value="New Customer" ${filters.status === 'New Customer' ? 'selected' : ''}>New Customer</option>
                                            <option value="Regular Customer" ${filters.status === 'Regular Customer' ? 'selected' : ''}>Regular Customer</option>
                                            <option value="VIP Customer" ${filters.status === 'VIP Customer' ? 'selected' : ''}>VIP Customer</option>
                                        </select>
                                    </div>
                                    <div class="flex-1 min-w-[140px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Date From</label>
                                        <input type="date" id="filterDateFrom" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.dateFrom}" onchange="setCustomerFilter('dateFrom', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[140px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Date To</label>
                                        <input type="date" id="filterDateTo" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.dateTo}" onchange="setCustomerFilter('dateTo', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Min Amount</label>
                                        <input type="number" id="filterAmountMin" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Min" value="${filters.purchaseAmountMin}" onchange="setCustomerFilter('purchaseAmountMin', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[120px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Max Amount</label>
                                        <input type="number" id="filterAmountMax" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Max" value="${filters.purchaseAmountMax}" onchange="setCustomerFilter('purchaseAmountMax', this.value)">
                                    </div>
                                    <div class="flex-1 min-w-[130px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Sort By</label>
                                        <select id="sortField" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerSort('field', this.value)">
                                            <option value="totalSpent" ${sort.field === 'totalSpent' ? 'selected' : ''}>Total Spent</option>
                                            <option value="lastPurchase" ${sort.field === 'lastPurchase' ? 'selected' : ''}>Last Purchase</option>
                                            <option value="invoiceCount" ${sort.field === 'invoiceCount' ? 'selected' : ''}>Invoice Count</option>
                                            <option value="ltv" ${sort.field === 'ltv' ? 'selected' : ''}>Lifetime Value</option>
                                        </select>
                                    </div>
                                    <div class="flex-1 min-w-[130px]">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Order</label>
                                        <select id="sortOrder" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="setCustomerSort('order', this.value)">
                                            <option value="desc" ${sort.order === 'desc' ? 'selected' : ''}>Descending</option>
                                            <option value="asc" ${sort.order === 'asc' ? 'selected' : ''}>Ascending</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3 flex justify-between items-center">
                                    <div class="text-xs text-gray-600">
                                        Showing ${customersWithStats.length} of ${customers.length} customers
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full" id="customersTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">CUSTOMER</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">CONTACT</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">INVOICES</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">TOTAL SPENT</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">AVG ORDER VALUE</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">STATUS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200" id="customersList">
                                        ${customersWithStats.map(c => {
                                            const status = getCustomerStatus(c.totalPurchases);
                                            const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase();
                                            return `
                                            <tr class="hover:bg-gray-50 transition cursor-pointer ${selectedCustomerId === c.id ? 'bg-indigo-50' : ''}" onclick="selectCustomerForView(${c.id})">
                                                <td class="px-4 py-4">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-sm">
                                                            ${initials}
                                                </div>
                                                <div>
                                                            <div class="font-semibold text-gray-800">${c.name}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm text-gray-600">${c.email}</div>
                                                    <div class="text-sm text-gray-600">${c.phone}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${c.ordersCount}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.totalPurchases)}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.avgOrderValue)}</div>
                                                </td>
                                                <td class="px-4 py-4">
                                                    <span class="px-3 py-1 ${status.color} rounded-full text-xs font-semibold">
                                                        ${status.label}
                                                    </span>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ${selectedCustomer ? (() => {
                            // Calculate analytics
                            const sortedInvoices = [...customerInvoices].sort((a, b) => new Date(a.date) - new Date(b.date));
                            const ltv = selectedCustomer.totalPurchases;
                            
                            // Last purchase date and days since
                            const lastPurchaseDate = sortedInvoices.length > 0 ? sortedInvoices[sortedInvoices.length - 1].date : selectedCustomer.lastPurchase;
                            const daysSinceLastPurchase = lastPurchaseDate ? Math.floor((new Date() - new Date(lastPurchaseDate)) / (1000 * 60 * 60 * 24)) : null;
                            
                            // Purchase frequency (average days between orders)
                            let avgDaysBetweenOrders = null;
                            if (sortedInvoices.length > 1) {
                                const daysBetween = [];
                                for (let i = 1; i < sortedInvoices.length; i++) {
                                    const days = Math.floor((new Date(sortedInvoices[i].date) - new Date(sortedInvoices[i-1].date)) / (1000 * 60 * 60 * 24));
                                    daysBetween.push(days);
                                }
                                avgDaysBetweenOrders = Math.round(daysBetween.reduce((a, b) => a + b, 0) / daysBetween.length);
                            }
                            
                            // Growth trend
                            let growthTrend = 'stable';
                            let growthPercentage = 0;
                            if (sortedInvoices.length >= 2) {
                                const firstHalf = sortedInvoices.slice(0, Math.floor(sortedInvoices.length / 2));
                                const secondHalf = sortedInvoices.slice(Math.floor(sortedInvoices.length / 2));
                                const firstHalfAvg = firstHalf.reduce((sum, inv) => sum + inv.total, 0) / firstHalf.length;
                                const secondHalfAvg = secondHalf.reduce((sum, inv) => sum + inv.total, 0) / secondHalf.length;
                                if (firstHalfAvg > 0) {
                                    growthPercentage = ((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100;
                                    growthTrend = growthPercentage > 5 ? 'increasing' : growthPercentage < -5 ? 'decreasing' : 'stable';
                                }
                            }
                            
                            // Preferred payment method
                            const paymentMethods = {};
                            customerInvoices.forEach(inv => {
                                paymentMethods[inv.payment] = (paymentMethods[inv.payment] || 0) + 1;
                            });
                            const preferredPayment = Object.keys(paymentMethods).length > 0 
                                ? Object.keys(paymentMethods).reduce((a, b) => paymentMethods[a] > paymentMethods[b] ? a : b)
                                : 'N/A';
                            
                            return `
                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Customer Analytics</h2>
                                <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4">
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Lifetime Value</div>
                                            <i class="fas fa-chart-line text-blue-600"></i>
                                        </div>
                                        <div class="text-2xl font-bold text-blue-900">${formatCurrency(ltv)}</div>
                                        <div class="text-xs text-blue-600 mt-1">Total revenue</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-green-700 uppercase tracking-wide">Purchase Frequency</div>
                                            <i class="fas fa-calendar-alt text-green-600"></i>
                                        </div>
                                        <div class="text-2xl font-bold text-green-900">
                                            ${avgDaysBetweenOrders !== null ? avgDaysBetweenOrders + ' days' : 'N/A'}
                                        </div>
                                        <div class="text-xs text-green-600 mt-1">Avg between orders</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-purple-700 uppercase tracking-wide">Last Purchase</div>
                                            <i class="fas fa-clock text-purple-600"></i>
                                        </div>
                                        <div class="text-lg font-bold text-purple-900">${lastPurchaseDate || 'N/A'}</div>
                                        <div class="text-xs text-purple-600 mt-1">
                                            ${daysSinceLastPurchase !== null ? daysSinceLastPurchase + ' days ago' : 'No purchases'}
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br ${growthTrend === 'increasing' ? 'from-emerald-50 to-emerald-100 border-emerald-200' : growthTrend === 'decreasing' ? 'from-red-50 to-red-100 border-red-200' : 'from-gray-50 to-gray-100 border-gray-200'} p-4 rounded-lg border">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold ${growthTrend === 'increasing' ? 'text-emerald-700' : growthTrend === 'decreasing' ? 'text-red-700' : 'text-gray-700'} uppercase tracking-wide">Growth Trend</div>
                                            <i class="fas ${growthTrend === 'increasing' ? 'fa-arrow-up text-emerald-600' : growthTrend === 'decreasing' ? 'fa-arrow-down text-red-600' : 'fa-minus text-gray-600'}"></i>
                                        </div>
                                        <div class="text-2xl font-bold ${growthTrend === 'increasing' ? 'text-emerald-900' : growthTrend === 'decreasing' ? 'text-red-900' : 'text-gray-900'}">
                                            ${growthTrend === 'increasing' ? 'â†—' : growthTrend === 'decreasing' ? 'â†˜' : 'â†’'} ${Math.abs(growthPercentage).toFixed(1)}%
                                        </div>
                                        <div class="text-xs ${growthTrend === 'increasing' ? 'text-emerald-600' : growthTrend === 'decreasing' ? 'text-red-600' : 'text-gray-600'} mt-1 capitalize">${growthTrend}</div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-lg border border-indigo-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-semibold text-indigo-700 uppercase tracking-wide">Preferred Payment</div>
                                            <i class="fas fa-credit-card text-indigo-600"></i>
                                        </div>
                                        <div class="text-lg font-bold text-indigo-900">${preferredPayment}</div>
                                        <div class="text-xs text-indigo-600 mt-1">
                                            ${paymentMethods[preferredPayment] || 0} of ${customerInvoices.length} invoices
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="mb-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h2 class="text-xl font-bold text-gray-800">Invoices for ${selectedCustomer.name}</h2>
                                        <span class="px-3 py-1 ${selectedCustomerStatus.color} rounded-full text-sm font-semibold">
                                            <i class="fas ${selectedCustomerStatus.icon} mr-1"></i>${selectedCustomerStatus.label}
                                        </span>
                                    </div>
                                                    <div class="text-sm text-gray-600">
                                        <span><i class="fas fa-envelope mr-1"></i>${selectedCustomer.email}</span>
                                        <span class="ml-4"><i class="fas fa-phone mr-1"></i>${selectedCustomer.phone}</span>
                                        <span class="ml-4"><i class="fas fa-shopping-cart mr-1"></i>Total: ${formatCurrency(selectedCustomer.totalPurchases)}</span>
                                                    </div>
                                                </div>
                            `;
                        })() : ''}
                        ${selectedCustomer ? `
                                ${customerInvoices.length > 0 ? `
                                    <div class="space-y-3 max-h-[600px] overflow-y-auto">
                                        ${customerInvoices.map(inv => `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div class="font-semibold text-gray-800">${inv.id}</div>
                                                        <div class="text-sm text-gray-600">${inv.date}</div>
                                            </div>
                                            <div class="text-right">
                                                        <div class="font-bold text-indigo-600">${formatCurrency(inv.total)}</div>
                                                        <span class="px-2 py-1 ${inv.payment === 'Cash' ? 'bg-green-100 text-green-800' : inv.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : inv.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs">${inv.payment}</span>
                                            </div>
                                        </div>
                                                <div class="text-sm text-gray-600 mt-2">
                                                    ${inv.items.length} item${inv.items.length > 1 ? 's' : ''}
                                                    ${inv.discount > 0 ? ` â€¢ Discount: ${formatCurrency(inv.discount)}` : ''}
                                                </div>
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="viewInvoice('${inv.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px; flex: 1;">
                                                        <i class="fas fa-eye mr-1"></i>View
                                                    </button>
                                                    <button onclick="printInvoice('${inv.id}')" class="btn" style="background: var(--gray-200); color: var(--gray-800); padding: 6px 12px; font-size: 14px;">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                                ` : `
                                    <div class="text-center py-12 text-gray-500">
                                        <i class="fas fa-file-invoice text-4xl mb-4 text-gray-300"></i>
                                        <p>No invoices found for this customer</p>
                        </div>
                                `}
                            </div>
                        ` : ''}
                    </main>
                </div>
            `;
        }

        function InvoicesPage() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            
            // Get filter values from state
            const filters = store.getState().invoiceFilters || {
                search: '',
                dateFrom: '',
                dateTo: '',
                customer: '',
                paymentMethod: '',
                amountMin: '',
                amountMax: '',
                quickFilter: 'all'
            };
            
            // Get unique customers and payment methods for filters
            const uniqueCustomers = [...new Set(invoices.map(inv => inv.customer).filter(c => c))].sort();
            const uniquePaymentMethods = [...new Set(invoices.map(inv => inv.payment).filter(p => p))].sort();
            
            // Apply filters
            let filteredInvoices = [...invoices];
            
            // Quick filter presets
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                if (filters.quickFilter === 'today') {
                    filteredInvoices = filteredInvoices.filter(inv => inv.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= weekAgo && invDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= monthAgo && invDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= yearAgo && invDate <= today;
                    });
                }
            }
            
            // Date range filter
            if (filters.dateFrom) {
                filteredInvoices = filteredInvoices.filter(inv => inv.date >= filters.dateFrom);
            }
            if (filters.dateTo) {
                filteredInvoices = filteredInvoices.filter(inv => inv.date <= filters.dateTo);
            }
            
            // Customer filter
            if (filters.customer) {
                filteredInvoices = filteredInvoices.filter(inv => inv.customer === filters.customer);
            }
            
            // Payment method filter
            if (filters.paymentMethod) {
                filteredInvoices = filteredInvoices.filter(inv => inv.payment === filters.paymentMethod);
            }
            
            // Amount range filter
            if (filters.amountMin) {
                filteredInvoices = filteredInvoices.filter(inv => inv.total >= parseFloat(filters.amountMin));
            }
            if (filters.amountMax) {
                filteredInvoices = filteredInvoices.filter(inv => inv.total <= parseFloat(filters.amountMax));
            }
            
            // Search filter
            if (filters.search && filters.search.trim()) {
                const searchTerm = filters.search.toLowerCase().trim();
                filteredInvoices = filteredInvoices.filter(inv => {
                    return inv.id.toLowerCase().includes(searchTerm) ||
                           inv.customer.toLowerCase().includes(searchTerm) ||
                           inv.date.includes(searchTerm) ||
                           (inv.customerPhone && inv.customerPhone.includes(searchTerm)) ||
                           (inv.customerEmail && inv.customerEmail.toLowerCase().includes(searchTerm)) ||
                           inv.items.some(item => item.name.toLowerCase().includes(searchTerm));
                });
            }
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Invoices</h1>
                            <button onclick="exportInvoices()" class="btn btn-primary">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                        
                        <!-- Filters Section -->
                        <div class="card mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 style="font-size: 1.25rem; font-weight: 600;">Filters</h2>
                                <button onclick="clearInvoiceFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-times mr-1"></i>Clear All
                                </button>
                            </div>
                            
                            <!-- Search Bar -->
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="invoiceSearch" placeholder="Search by invoice ID, customer, date, or items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.search || ''}" oninput="setInvoiceFilter('search', this.value)" style="padding-right: 40px;">
                                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quick Filter</label>
                                    <select id="invoiceQuickFilter" class="input-field" onchange="setInvoiceFilter('quickFilter', this.value)">
                                        <option value="all" ${filters.quickFilter === 'all' ? 'selected' : ''}>All Time</option>
                                        <option value="today" ${filters.quickFilter === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="week" ${filters.quickFilter === 'week' ? 'selected' : ''}>Last 7 Days</option>
                                        <option value="month" ${filters.quickFilter === 'month' ? 'selected' : ''}>Last 30 Days</option>
                                        <option value="year" ${filters.quickFilter === 'year' ? 'selected' : ''}>Last Year</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="invoiceDateFrom" class="input-field" value="${filters.dateFrom || ''}" onchange="setInvoiceFilter('dateFrom', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="invoiceDateTo" class="input-field" value="${filters.dateTo || ''}" onchange="setInvoiceFilter('dateTo', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Customer</label>
                                    <select id="invoiceCustomer" class="input-field" onchange="setInvoiceFilter('customer', this.value)">
                                        <option value="">All Customers</option>
                                        ${uniqueCustomers.map(customer => `
                                            <option value="${customer}" ${filters.customer === customer ? 'selected' : ''}>${customer}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                                    <select id="invoicePaymentMethod" class="input-field" onchange="setInvoiceFilter('paymentMethod', this.value)">
                                        <option value="">All Methods</option>
                                        ${uniquePaymentMethods.map(method => `
                                            <option value="${method}" ${filters.paymentMethod === method ? 'selected' : ''}>${method}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Min Amount</label>
                                    <input type="number" id="invoiceAmountMin" class="input-field" placeholder="Min" value="${filters.amountMin || ''}" onchange="setInvoiceFilter('amountMin', this.value)" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Max Amount</label>
                                    <input type="number" id="invoiceAmountMax" class="input-field" placeholder="Max" value="${filters.amountMax || ''}" onchange="setInvoiceFilter('amountMax', this.value)" step="0.01">
                                </div>
                            </div>
                            <div class="text-small text-muted">
                                Showing ${filteredInvoices.length} of ${invoices.length} invoices
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full" id="invoicesTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Invoice ID</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Customer</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Items</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Total</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Payment</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${filteredInvoices.length > 0 ? filteredInvoices.map(inv => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 font-semibold text-gray-800">${inv.id}</td>
                                                <td class="px-4 py-3 text-gray-800">${inv.customer}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.date}</td>
                                                <td class="px-4 py-3 text-gray-600">${inv.items.length} items</td>
                                                <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(inv.total)}</td>
                                                <td class="px-4 py-3"><span class="px-3 py-1 ${inv.payment === 'Cash' ? 'bg-green-100 text-green-800' : inv.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : inv.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'} rounded-full text-sm">${inv.payment}</span></td>
                                                <td class="px-4 py-3">
                                                    <button onclick="viewInvoice('${inv.id}')" class="text-indigo-600 hover:text-indigo-800 mr-3">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="printInvoice('${inv.id}')" class="text-gray-600 hover:text-gray-800">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                                    No invoices found matching the selected filters
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function CampaignsPage() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Get campaign history
            const campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
            
            // Calculate customer segments
            const allCustomers = customers.map(c => {
                const customerInvoices = invoices.filter(inv => inv.customer === c.name || inv.customerPhone === c.phone);
                const totalSpent = customerInvoices.reduce((sum, inv) => sum + inv.total, 0);
                return {
                    ...c,
                    totalSpent,
                    orderCount: customerInvoices.length,
                    lastPurchase: customerInvoices.length > 0 ? customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : null
                };
            });
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Email & SMS Campaigns</h1>
                            <button onclick="showNewCampaignModal()" class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i>New Campaign
                            </button>
                        </div>
                        
                        <!-- Campaign Stats -->
                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">Total Campaigns</p>
                                        <p class="text-2xl font-bold text-gray-800">${campaigns.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-bullhorn text-indigo-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">Total Recipients</p>
                                        <p class="text-2xl font-bold text-gray-800">${campaigns.reduce((sum, c) => sum + (c.recipients?.length || 0), 0)}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-users text-green-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">Email Sent</p>
                                        <p class="text-2xl font-bold text-gray-800">${campaigns.filter(c => c.type === 'email').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-envelope text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 mb-1">SMS Sent</p>
                                        <p class="text-2xl font-bold text-gray-800">${campaigns.filter(c => c.type === 'sms').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-sms text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campaign List -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Campaign History</h2>
                            ${campaigns.length > 0 ? `
                                <div class="space-y-4">
                                    ${campaigns.map((campaign, index) => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div class="flex items-center gap-3 mb-2">
                                                        <h3 class="text-lg font-semibold text-gray-800">${campaign.subject || campaign.title}</h3>
                                                        <span class="px-3 py-1 ${campaign.type === 'email' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'} rounded-full text-xs font-semibold">
                                                            ${campaign.type === 'email' ? 'Email' : 'SMS'}
                                                        </span>
                                                        <span class="px-3 py-1 ${campaign.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} rounded-full text-xs font-semibold">
                                                            ${campaign.status || 'Draft'}
                                                        </span>
                                                    </div>
                                                    <p class="text-sm text-gray-600 mb-2">${campaign.message || campaign.content}</p>
                                                    <div class="flex items-center gap-4 text-xs text-gray-500">
                                                        <span><i class="fas fa-users mr-1"></i>${campaign.recipients?.length || 0} recipients</span>
                                                        <span><i class="fas fa-calendar mr-1"></i>${campaign.date || new Date().toLocaleDateString()}</span>
                                                        ${campaign.segment ? `<span><i class="fas fa-filter mr-1"></i>${campaign.segment}</span>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="viewCampaign(${index})" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="deleteCampaign(${index})" class="btn" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 14px;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-bullhorn text-4xl mb-4 text-gray-300"></i>
                                    <p>No campaigns yet. Create your first campaign to reach out to customers!</p>
                                </div>
                            `}
                        </div>
                    </main>
                </div>
            `;
        }

        function ReportsPage() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            
            // Get filter values from state or defaults
            const filters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // Combine all transactions with type labels
            let allTransactions = [
                ...invoices.map(inv => ({ ...inv, transactionType: 'sale', typeLabel: 'Sale' })),
                ...purchaseOrders.map(po => ({ ...po, transactionType: 'purchase', typeLabel: 'Purchase', customer: po.supplier || 'N/A', payment: 'N/A', discount: 0, tax: 0 })),
                ...returns.map(ret => ({ ...ret, transactionType: 'return', typeLabel: ret.type === 'return' ? 'Return' : 'Exchange', payment: 'N/A', discount: 0, tax: 0 }))
            ];
            
            // Apply filters
            let filteredTransactions = [...allTransactions];
            
            // Order type filter
            if (filters.orderType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.transactionType === filters.orderType);
            }
            
            // Quick filter presets
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                if (filters.quickFilter === 'today') {
                    filteredTransactions = filteredTransactions.filter(t => t.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= weekAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= monthAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= yearAgo && tDate <= today;
                    });
                }
            }
            
            // Date range filter
            if (filters.dateFrom) {
                filteredTransactions = filteredTransactions.filter(t => t.date >= filters.dateFrom);
            }
            if (filters.dateTo) {
                filteredTransactions = filteredTransactions.filter(t => t.date <= filters.dateTo);
            }
            
            // Payment method filter (only for sales)
            if (filters.paymentMethod) {
                filteredTransactions = filteredTransactions.filter(t => t.payment === filters.paymentMethod);
            }
            
            // Calculate statistics from filtered data
            const salesTransactions = filteredTransactions.filter(t => t.transactionType === 'sale');
            const purchaseTransactions = filteredTransactions.filter(t => t.transactionType === 'purchase');
            const returnTransactions = filteredTransactions.filter(t => t.transactionType === 'return');
            
            const totalSales = salesTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalPurchases = purchaseTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalReturns = returnTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalDiscounts = salesTransactions.reduce((sum, t) => sum + (t.discount || 0), 0);
            const totalTax = salesTransactions.reduce((sum, t) => sum + (t.tax || 0), 0);
            const totalItemsSold = salesTransactions.reduce((sum, t) => sum + t.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0);
            
            // Today's sales
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesTransactions.filter(t => t.date === today).reduce((sum, t) => sum + t.total, 0);
            const todayInvoices = salesTransactions.filter(t => t.date === today);
            
            // Top selling products (only from sales)
            const productSales = {};
            salesTransactions.forEach(t => {
                t.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = { name: item.name, qty: 0, revenue: 0 };
                    }
                    productSales[item.name].qty += item.qty;
                    productSales[item.name].revenue += item.qty * (item.price || 0);
                });
            });
            const topProducts = Object.values(productSales).sort((a, b) => b.qty - a.qty).slice(0, 5);
            
            // Payment methods (only for sales)
            const paymentMethods = {};
            salesTransactions.forEach(t => {
                if (t.payment && t.payment !== 'N/A') {
                    paymentMethods[t.payment] = (paymentMethods[t.payment] || 0) + t.total;
                }
            });
            
            // Ensure standard payment methods are always included even if no transactions
            const standardPaymentMethods = ['Cash', 'Card', 'UPI', 'Credit Note'];
            standardPaymentMethods.forEach(method => {
                if (!paymentMethods[method]) {
                    paymentMethods[method] = 0;
                }
            });
            
            // Get unique payment methods for filters (only from sales)
            const uniquePaymentMethods = [...new Set(invoices.map(inv => inv.payment).filter(p => p))];
            // Ensure standard payment methods are in the filter list
            standardPaymentMethods.forEach(method => {
                if (!uniquePaymentMethods.includes(method)) {
                    uniquePaymentMethods.push(method);
                }
            });
            // Sort payment methods: standard methods first, then others
            uniquePaymentMethods.sort((a, b) => {
                const aIndex = standardPaymentMethods.indexOf(a);
                const bIndex = standardPaymentMethods.indexOf(b);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return a.localeCompare(b);
            });
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">Reports</h1>
                            <button onclick="exportReport()" class="btn btn-primary">
                                <i class="fas fa-download mr-2"></i>Export Report
                            </button>
                        </div>
                        
                        <!-- Filters Section -->
                        <div class="card mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 style="font-size: 1.25rem; font-weight: 600;">Filters</h2>
                                <button onclick="clearReportFilters()" class="text-sm text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-times mr-1"></i>Clear All
                                </button>
                            </div>
                            <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Order Type</label>
                                    <select id="orderType" class="input-field" onchange="setReportFilter('orderType', this.value)">
                                        <option value="all" ${filters.orderType === 'all' ? 'selected' : ''}>All Types</option>
                                        <option value="sale" ${filters.orderType === 'sale' ? 'selected' : ''}>Sale</option>
                                        <option value="purchase" ${filters.orderType === 'purchase' ? 'selected' : ''}>Purchase</option>
                                        <option value="return" ${filters.orderType === 'return' ? 'selected' : ''}>Return/Exchange</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quick Filter</label>
                                    <select id="quickFilter" class="input-field" onchange="setReportFilter('quickFilter', this.value)">
                                        <option value="all" ${filters.quickFilter === 'all' ? 'selected' : ''}>All Time</option>
                                        <option value="today" ${filters.quickFilter === 'today' ? 'selected' : ''}>Today</option>
                                        <option value="week" ${filters.quickFilter === 'week' ? 'selected' : ''}>Last 7 Days</option>
                                        <option value="month" ${filters.quickFilter === 'month' ? 'selected' : ''}>Last 30 Days</option>
                                        <option value="year" ${filters.quickFilter === 'year' ? 'selected' : ''}>Last Year</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">From Date</label>
                                    <input type="date" id="dateFrom" class="input-field" value="${filters.dateFrom}" onchange="setReportFilter('dateFrom', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">To Date</label>
                                    <input type="date" id="dateTo" class="input-field" value="${filters.dateTo}" onchange="setReportFilter('dateTo', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                                    <select id="paymentMethod" class="input-field" onchange="setReportFilter('paymentMethod', this.value)">
                                        <option value="">All Methods</option>
                                        ${uniquePaymentMethods.map(method => `
                                            <option value="${method}" ${filters.paymentMethod === method ? 'selected' : ''}>${method}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-end">
                                <div class="text-small text-muted">
                                    Showing ${filteredTransactions.length} of ${allTransactions.length} transactions
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="stat-card">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value" style="color: var(--success);">${formatCurrency(totalSales)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Today's Sales</div>
                                <div class="stat-value" style="color: var(--primary);">${formatCurrency(todaySales)}</div>
                                <div class="text-small mt-2">${todayInvoices.length} transactions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Discounts</div>
                                <div class="stat-value" style="color: var(--warning);">${formatCurrency(totalDiscounts)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Items Sold</div>
                                <div class="stat-value" style="color: var(--info);">${totalItemsSold}</div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="card">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Top Selling Products</h2>
                                <div class="space-y-3">
                                    ${topProducts.length > 0 ? topProducts.map((p, index) => `
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div class="flex items-center space-x-4">
                                                <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                                    ${index + 1}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${p.name}</div>
                                                    <div class="text-small">${p.qty} units sold</div>
                                                </div>
                                            </div>
                                            <div style="font-weight: 700; font-size: 16px; color: var(--primary);">
                                                ${formatCurrency(p.revenue)}
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No sales data available</p>'}
                                </div>
                            </div>

                            <div class="card">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Payment Methods</h2>
                                <div class="space-y-3">
                                    ${Object.entries(paymentMethods).sort((a, b) => {
                                        // Sort by amount (descending), but ensure Cash, Card, UPI, Credit Note order
                                        const order = ['Cash', 'Card', 'UPI', 'Credit Note'];
                                        const aIndex = order.indexOf(a[0]);
                                        const bIndex = order.indexOf(b[0]);
                                        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                                        if (aIndex !== -1) return -1;
                                        if (bIndex !== -1) return 1;
                                        return b[1] - a[1];
                                    }).map(([method, amount]) => {
                                        const percentage = totalSales > 0 ? ((amount / totalSales) * 100).toFixed(1) : '0.0';
                                        return `
                                            <div>
                                                <div class="flex justify-between mb-2">
                                                    <span style="font-weight: 600; font-size: 15px;">${method}</span>
                                                    <span style="font-weight: 700; color: var(--primary);">${formatCurrency(amount)}</span>
                                                </div>
                                                <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                                    <div style="background: var(--primary); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                                </div>
                                                <div class="text-small mt-1">${percentage}% of total sales</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Seasonal Pattern Analysis -->
                        <div class="card mb-6">
                            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Seasonal Pattern Analysis</h2>
                            ${(() => {
                                // Calculate sales by month
                                const monthlySales = {};
                                const monthlyCounts = {};
                                salesTransactions.forEach(t => {
                                    const date = new Date(t.date);
                                    const monthKey = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                                    if (!monthlySales[monthKey]) {
                                        monthlySales[monthKey] = 0;
                                        monthlyCounts[monthKey] = 0;
                                    }
                                    monthlySales[monthKey] += t.total;
                                    monthlyCounts[monthKey] += 1;
                                });
                                
                                // Calculate seasonal trends
                                const seasonalData = {};
                                salesTransactions.forEach(t => {
                                    const date = new Date(t.date);
                                    const month = date.getMonth();
                                    let season = 'Spring';
                                    if (month >= 2 && month <= 4) season = 'Spring';
                                    else if (month >= 5 && month <= 7) season = 'Summer';
                                    else if (month >= 8 && month <= 10) season = 'Fall';
                                    else season = 'Winter';
                                    
                                    if (!seasonalData[season]) {
                                        seasonalData[season] = { total: 0, count: 0 };
                                    }
                                    seasonalData[season].total += t.total;
                                    seasonalData[season].count += 1;
                                });
                                
                                const maxMonthly = Math.max(...Object.values(monthlySales), 0);
                                const maxSeasonal = Math.max(...Object.values(seasonalData).map(s => s.total), 0);
                                
                                return `
                                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Monthly Sales Trend</h3>
                                            <div class="space-y-3">
                                                ${Object.entries(monthlySales).sort((a, b) => new Date(a[0]) - new Date(b[0])).map(([month, amount]) => {
                                                    const percentage = maxMonthly > 0 ? ((amount / maxMonthly) * 100).toFixed(0) : 0;
                                                    return `
                                                        <div>
                                                            <div class="flex justify-between mb-2">
                                                                <span class="font-semibold text-gray-800">${month}</span>
                                                                <span class="font-bold text-indigo-600">${formatCurrency(amount)}</span>
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden; flex: 1;">
                                                                    <div style="background: linear-gradient(90deg, #4f46e5, #7c3aed); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                                                </div>
                                                                <span class="text-xs text-gray-600">${monthlyCounts[month]} orders</span>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('') || '<p class="text-gray-500 text-center py-4">No monthly data available</p>'}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Seasonal Performance</h3>
                                            <div class="space-y-3">
                                                ${Object.entries(seasonalData).map(([season, data]) => {
                                                    const percentage = maxSeasonal > 0 ? ((data.total / maxSeasonal) * 100).toFixed(0) : 0;
                                                    const avgOrder = data.count > 0 ? (data.total / data.count) : 0;
                                                    return `
                                                        <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                                                            <div class="flex justify-between items-center mb-2">
                                                                <span class="font-bold text-gray-800 text-lg">${season}</span>
                                                                <span class="font-bold text-indigo-600 text-lg">${formatCurrency(data.total)}</span>
                                                            </div>
                                                            <div class="text-sm text-gray-600 mb-2">
                                                                ${data.count} orders â€¢ Avg: ${formatCurrency(avgOrder)}
                                                            </div>
                                                            <div style="background: var(--gray-200); height: 10px; border-radius: 5px; overflow: hidden;">
                                                                <div style="background: linear-gradient(90deg, #6366f1, #8b5cf6); height: 100%; width: ${percentage}%;"></div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('') || '<p class="text-gray-500 text-center py-4">No seasonal data available</p>'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>

                        <!-- Peak Hours/Day Analysis -->
                        <div class="card mb-6">
                            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Peak Hours & Day Analysis</h2>
                            ${(() => {
                                // Calculate sales by day of week
                                const daySales = {
                                    'Sunday': 0, 'Monday': 0, 'Tuesday': 0, 'Wednesday': 0,
                                    'Thursday': 0, 'Friday': 0, 'Saturday': 0
                                };
                                const dayCounts = {
                                    'Sunday': 0, 'Monday': 0, 'Tuesday': 0, 'Wednesday': 0,
                                    'Thursday': 0, 'Friday': 0, 'Saturday': 0
                                };
                                
                                salesTransactions.forEach(t => {
                                    const date = new Date(t.date);
                                    const dayName = date.toLocaleString('default', { weekday: 'long' });
                                    daySales[dayName] += t.total;
                                    dayCounts[dayName] += 1;
                                });
                                
                                // For peak hours, we'll use a simulated approach since invoices don't have time
                                // In production, you'd track time with each transaction
                                const peakHours = {
                                    'Morning (9-12)': salesTransactions.length * 0.25,
                                    'Afternoon (12-5)': salesTransactions.length * 0.40,
                                    'Evening (5-9)': salesTransactions.length * 0.30,
                                    'Night (9-12)': salesTransactions.length * 0.05
                                };
                                
                                const maxDay = Math.max(...Object.values(daySales), 0);
                                const maxHour = Math.max(...Object.values(peakHours), 0);
                                
                                const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                                
                                return `
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Sales by Day of Week</h3>
                                            <div class="space-y-3">
                                                ${dayOrder.map(day => {
                                                    const amount = daySales[day];
                                                    const count = dayCounts[day];
                                                    const percentage = maxDay > 0 ? ((amount / maxDay) * 100).toFixed(0) : 0;
                                                    return `
                                                        <div>
                                                            <div class="flex justify-between mb-2">
                                                                <span class="font-semibold text-gray-800">${day}</span>
                                                                <span class="font-bold text-green-600">${formatCurrency(amount)}</span>
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden; flex: 1;">
                                                                    <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: ${percentage}%;"></div>
                                                                </div>
                                                                <span class="text-xs text-gray-600">${count} orders</span>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold mb-4 text-gray-700">Peak Hours Distribution</h3>
                                            <div class="space-y-3">
                                                ${Object.entries(peakHours).map(([period, count]) => {
                                                    const percentage = maxHour > 0 ? ((count / maxHour) * 100).toFixed(0) : 0;
                                                    return `
                                                        <div>
                                                            <div class="flex justify-between mb-2">
                                                                <span class="font-semibold text-gray-800">${period}</span>
                                                                <span class="font-bold text-purple-600">~${Math.round(count)} transactions</span>
                                                            </div>
                                                            <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                                                <div style="background: linear-gradient(90deg, #a855f7, #9333ea); height: 100%; width: ${percentage}%;"></div>
                                                            </div>
                                                            <p class="text-xs text-gray-500 mt-1">Note: Time tracking needed for accurate data</p>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>

                        <!-- Tax Reports Section -->
                        <div class="card mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 style="font-size: 1.5rem; font-weight: 600;">Tax Reports</h2>
                                <button onclick="exportTaxReport()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-download mr-2"></i>Export Tax Report
                                </button>
                            </div>
                            ${(() => {
                                const settings = store.getState().settings;
                                const taxRates = settings.taxRates || [];
                                
                                // Calculate tax by type
                                const taxByType = {};
                                salesTransactions.forEach(t => {
                                    const taxAmount = t.tax || 0;
                                    const taxRate = t.taxRate || settings.taxRate;
                                    const taxType = t.taxType || settings.defaultTaxType || 'gst';
                                    
                                    if (!taxByType[taxType]) {
                                        taxByType[taxType] = { total: 0, count: 0, rate: taxRate };
                                    }
                                    taxByType[taxType].total += taxAmount;
                                    taxByType[taxType].count += 1;
                                });
                                
                                const totalTaxCollected = salesTransactions.reduce((sum, t) => sum + (t.tax || 0), 0);
                                
                                return `
                                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border border-blue-200">
                                            <div class="text-sm font-semibold text-blue-700 mb-2">Total Tax Collected</div>
                                            <div class="text-3xl font-bold text-blue-900">${formatCurrency(totalTaxCollected)}</div>
                                            <div class="text-xs text-blue-600 mt-2">From ${salesTransactions.length} transactions</div>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
                                            <div class="text-sm font-semibold text-green-700 mb-2">Taxable Sales</div>
                                            <div class="text-3xl font-bold text-green-900">${formatCurrency(salesTransactions.reduce((sum, t) => sum + (t.subtotal || t.total - (t.tax || 0)), 0))}</div>
                                        </div>
                                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border border-purple-200">
                                            <div class="text-sm font-semibold text-purple-700 mb-2">Average Tax Rate</div>
                                            <div class="text-3xl font-bold text-purple-900">${taxRates.length > 0 ? taxRates.find(t => t.type === settings.defaultTaxType)?.rate || settings.taxRate : settings.taxRate}%</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Tax Breakdown by Type</h3>
                                        <div class="space-y-3">
                                            ${taxRates.length > 0 ? taxRates.map(tax => {
                                                const taxData = taxByType[tax.type] || { total: 0, count: 0 };
                                                return `
                                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <div class="font-semibold text-gray-800">${tax.name} (${tax.rate}%)</div>
                                                            <div class="text-sm text-gray-600">${taxData.count} transactions</div>
                                                        </div>
                                                        <div class="text-xl font-bold text-indigo-600">${formatCurrency(taxData.total)}</div>
                                                    </div>
                                                `;
                                            }).join('') : `
                                                <div class="p-4 bg-gray-50 rounded-lg text-center text-gray-500">
                                                    Configure tax rates in Settings to see detailed breakdown
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>

                        <div class="card">
                            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Transactions ${filters.quickFilter !== 'all' || filters.dateFrom || filters.dateTo || filters.paymentMethod || filters.orderType !== 'all' ? '(Filtered)' : ''}</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="table-header">Type</th>
                                            <th class="table-header">ID</th>
                                            <th class="table-header">Customer/Supplier</th>
                                            <th class="table-header">Date</th>
                                            <th class="table-header">Items</th>
                                            <th class="table-header">Discount</th>
                                            <th class="table-header">Total</th>
                                            <th class="table-header">Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredTransactions.length > 0 ? filteredTransactions.slice(-50).reverse().map(t => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="table-cell">
                                                    <span class="badge ${t.transactionType === 'sale' ? 'badge-success' : t.transactionType === 'purchase' ? 'badge-primary' : 'badge-danger'}">
                                                        ${t.typeLabel}
                                                    </span>
                                                </td>
                                                <td class="table-cell" style="font-weight: 600;">${t.id}</td>
                                                <td class="table-cell">${t.customer || t.supplier || 'N/A'}</td>
                                                <td class="table-cell text-muted">${t.date}</td>
                                                <td class="table-cell text-muted">${t.items.length} items</td>
                                                <td class="table-cell">${t.discount > 0 ? `<span style="color: var(--success);">-${formatCurrency(t.discount)}</span>` : '-'}</td>
                                                <td class="table-cell" style="font-weight: 600; ${t.transactionType === 'return' ? 'color: var(--danger);' : ''}">${formatCurrency(t.total)}</td>
                                                <td class="table-cell">
                                                    ${t.payment && t.payment !== 'N/A' ? `<span class="badge ${t.payment === 'Cash' ? 'badge-success' : t.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : t.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'badge-primary'}">${t.payment}</span>` : '-'}
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="8" class="table-cell text-center text-muted py-8">
                                                    No transactions found matching the selected filters
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function InventoryPage() {
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Get filter values from state
            const filters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            
            // Get unique suppliers for filters
            const uniqueSuppliers = [...new Set(purchaseOrders.map(po => po.supplier).filter(s => s))];
            
            // Apply filters to purchase orders
            let filteredPOs = [...purchaseOrders];
            if (filters.poStatus) {
                filteredPOs = filteredPOs.filter(po => po.status === filters.poStatus);
            }
            if (filters.poDateFrom) {
                filteredPOs = filteredPOs.filter(po => po.date >= filters.poDateFrom);
            }
            if (filters.poDateTo) {
                filteredPOs = filteredPOs.filter(po => po.date <= filters.poDateTo);
            }
            if (filters.poSupplier) {
                filteredPOs = filteredPOs.filter(po => po.supplier === filters.poSupplier);
            }
            // Apply search filter
            if (filters.poSearch && filters.poSearch.trim()) {
                const searchTerm = filters.poSearch.toLowerCase().trim();
                filteredPOs = filteredPOs.filter(po => {
                    // Search in PO ID
                    if (po.id.toLowerCase().includes(searchTerm)) return true;
                    // Search in supplier name
                    if (po.supplier && po.supplier.toLowerCase().includes(searchTerm)) return true;
                    // Search in date
                    if (po.date && po.date.includes(searchTerm)) return true;
                    // Search in items
                    if (po.items && po.items.some(item => item.name.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            // Apply filters to returns/exchanges
            let filteredReturns = [...returns];
            if (filters.returnStatus) {
                filteredReturns = filteredReturns.filter(ret => ret.status === filters.returnStatus);
            }
            if (filters.returnType) {
                filteredReturns = filteredReturns.filter(ret => ret.type === filters.returnType);
            }
            if (filters.returnDateFrom) {
                filteredReturns = filteredReturns.filter(ret => ret.date >= filters.returnDateFrom);
            }
            if (filters.returnDateTo) {
                filteredReturns = filteredReturns.filter(ret => ret.date <= filters.returnDateTo);
            }
            // Apply search filter
            if (filters.returnSearch && filters.returnSearch.trim()) {
                const searchTerm = filters.returnSearch.toLowerCase().trim();
                filteredReturns = filteredReturns.filter(ret => {
                    // Search in return ID
                    if (ret.id.toLowerCase().includes(searchTerm)) return true;
                    // Search in invoice ID
                    if (ret.invoiceId && ret.invoiceId.toLowerCase().includes(searchTerm)) return true;
                    // Search in customer name
                    if (ret.customer && ret.customer.toLowerCase().includes(searchTerm)) return true;
                    // Search in date
                    if (ret.date && ret.date.includes(searchTerm)) return true;
                    // Search in items
                    if (ret.items && ret.items.some(item => item.name.toLowerCase().includes(searchTerm))) return true;
                    // Search in reason
                    if (ret.items && ret.items.some(item => item.reason && item.reason.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            // Calculate total stock value
            const totalStockValue = products.reduce((sum, product) => {
                return sum + (product.stock * product.price);
            }, 0);
            
            // Calculate total number of products
            const totalProducts = products.length;
            const totalStockUnits = products.reduce((sum, product) => sum + product.stock, 0);
            
            // Identify slow-moving/not-moving stock
            // Products that haven't been sold in the last 90 days
            const today = new Date();
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setDate(today.getDate() - 90);
            
            // Get all product sales in the last 90 days
            const recentSales = {};
            invoices.forEach(inv => {
                const invDate = new Date(inv.date);
                if (invDate >= ninetyDaysAgo) {
                    inv.items.forEach(item => {
                        if (!recentSales[item.name]) {
                            recentSales[item.name] = 0;
                        }
                        recentSales[item.name] += item.qty;
                    });
                }
            });
            
            // Identify slow-moving products (no sales in last 90 days but have stock)
            const slowMovingProducts = products.filter(product => {
                const hasRecentSales = recentSales[product.name] > 0;
                return !hasRecentSales && product.stock > 0;
            }).map(product => ({
                ...product,
                stockValue: product.stock * product.price,
                daysSinceLastSale: '90+ days'
            }));
            
            // Sort by stock value (highest first) to prioritize high-value dead stock
            slowMovingProducts.sort((a, b) => b.stockValue - a.stockValue);
            
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 style="font-size: 2.5rem; font-weight: 700;">Inventory Management</h1>
                        </div>

                        <div class="grid md:grid-cols-4 gap-6 mb-8">
                            <div class="stat-card">
                                <div class="stat-label">Total Stock Value</div>
                                <div class="stat-value" style="color: var(--primary);">${formatCurrency(totalStockValue)}</div>
                                <div class="text-small mt-2">${totalStockUnits} units across ${totalProducts} products</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Purchase Orders</div>
                                <div class="stat-value" style="color: var(--primary);">${purchaseOrders.length}</div>
                                <div class="text-small mt-2">${purchaseOrders.filter(po => po.status === 'pending').length} pending</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Returns/Exchanges</div>
                                <div class="stat-value" style="color: var(--danger);">${returns.length}</div>
                                <div class="text-small mt-2">${returns.filter(r => r.status === 'pending').length} pending</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Slow-Moving Stock</div>
                                <div class="stat-value" style="color: var(--warning);">${slowMovingProducts.length}</div>
                                <div class="text-small mt-2">${formatCurrency(slowMovingProducts.reduce((sum, p) => sum + p.stockValue, 0))} tied up</div>
                            </div>
                        </div>

                        <!-- Physical Inventory Scanning Section -->
                        <div class="card mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">Physical Inventory Audit</h2>
                                    <p class="text-small text-gray-600 mt-1">Scan products to identify missing items or theft</p>
                                </div>
                                <button onclick="startPhysicalInventoryScan()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-barcode mr-2"></i>Start Physical Count
                                </button>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                                    <div class="text-sm text-yellow-800">
                                        <strong>How it works:</strong> Scan or search products to count physical stock. The system will compare with recorded stock to identify discrepancies, missing items, or potential theft.
                                    </div>
                                </div>
                            </div>
                            <div id="physicalInventoryResults" class="hidden">
                                <h3 class="text-lg font-semibold mb-4 text-gray-800">Audit Results</h3>
                                <div id="discrepancyList" class="space-y-3"></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <!-- Purchase Orders Section -->
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">Purchase Orders</h2>
                                    <button onclick="showPurchaseOrderModal()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-plus mr-1"></i>New PO
                                    </button>
                                </div>
                                
                                <!-- PO Search Bar -->
                                <div class="mb-4">
                                    <div class="relative">
                                        <input type="text" id="poSearch" placeholder="Search by PO ID, supplier, date, or items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.poSearch || ''}" oninput="filterPurchaseOrders(this.value)" style="padding-right: 40px;">
                                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <!-- PO Filters -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
                                        <button onclick="clearPOFilters()" class="text-xs text-gray-600 hover:text-gray-800">
                                            <i class="fas fa-times mr-1"></i>Clear
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                                            <select id="poStatusFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('poStatus', this.value)">
                                                <option value="">All</option>
                                                <option value="pending" ${filters.poStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="completed" ${filters.poStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Supplier</label>
                                            <select id="poSupplierFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('poSupplier', this.value)">
                                                <option value="">All Suppliers</option>
                                                ${uniqueSuppliers.map(supplier => `
                                                    <option value="${supplier}" ${filters.poSupplier === supplier ? 'selected' : ''}>${supplier}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                                            <input type="date" id="poDateFromFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.poDateFrom}" onchange="setInventoryFilter('poDateFrom', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                                            <input type="date" id="poDateToFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.poDateTo}" onchange="setInventoryFilter('poDateTo', this.value)">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Showing ${filteredPOs.length} of ${purchaseOrders.length} orders
                                    </div>
                                </div>
                                
                                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                                    ${filteredPOs.length > 0 ? filteredPOs.map(po => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${po.id}</div>
                                                    <div class="text-small">${po.supplier}</div>
                                                    <div class="text-small">${po.date}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="badge ${po.status === 'completed' ? 'badge-success' : 'badge-warning'}">${po.status}</span>
                                                    <div style="font-weight: 700; font-size: 18px; color: var(--primary); margin-top: 8px;">
                                                        ${formatCurrency(po.total)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <div class="text-small font-semibold mb-2">Items:</div>
                                                ${po.items.map(item => `
                                                    <div class="flex justify-between text-small mb-1">
                                                        <span>${item.name} x ${item.qty}</span>
                                                        <span>${formatCurrency(item.cost * item.qty)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="flex gap-2 mt-3">
                                                ${po.status === 'pending' ? `
                                                    <button onclick="completePurchaseOrder('${po.id}')" class="btn btn-success" style="padding: 6px 12px; font-size: 14px; flex: 1;">
                                                        <i class="fas fa-check mr-1"></i>Complete
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No purchase orders found</p>'}
                                </div>
                            </div>

                            <!-- Returns & Exchanges Section -->
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">Returns & Exchanges</h2>
                                    <button onclick="showReturnExchangeModal()" class="btn" style="background: var(--info); color: white; padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-exchange-alt mr-1"></i>New Return
                                    </button>
                                </div>
                                
                                <!-- Return Search Bar -->
                                <div class="mb-4">
                                    <div class="relative">
                                        <input type="text" id="returnSearch" placeholder="Search by return ID, invoice ID, customer, date, or items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" value="${filters.returnSearch || ''}" oninput="filterReturnsExchanges(this.value)" style="padding-right: 40px;">
                                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <!-- Return Filters -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
                                        <button onclick="clearReturnFilters()" class="text-xs text-gray-600 hover:text-gray-800">
                                            <i class="fas fa-times mr-1"></i>Clear
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                                            <select id="returnStatusFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('returnStatus', this.value)">
                                                <option value="">All</option>
                                                <option value="pending" ${filters.returnStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="completed" ${filters.returnStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Type</label>
                                            <select id="returnTypeFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" onchange="setInventoryFilter('returnType', this.value)">
                                                <option value="">All Types</option>
                                                <option value="return" ${filters.returnType === 'return' ? 'selected' : ''}>Return</option>
                                                <option value="exchange" ${filters.returnType === 'exchange' ? 'selected' : ''}>Exchange</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                                            <input type="date" id="returnDateFromFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.returnDateFrom}" onchange="setInventoryFilter('returnDateFrom', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                                            <input type="date" id="returnDateToFilter" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-indigo-600" value="${filters.returnDateTo}" onchange="setInventoryFilter('returnDateTo', this.value)">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        Showing ${filteredReturns.length} of ${returns.length} returns/exchanges
                                    </div>
                                </div>
                                
                                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                                    ${filteredReturns.length > 0 ? filteredReturns.map(ret => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 16px; color: var(--gray-900);">${ret.id}</div>
                                                    <div class="text-small">Invoice: ${ret.invoiceId}</div>
                                                    <div class="text-small">Customer: ${ret.customer}</div>
                                                    <div class="text-small">${ret.date}</div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="badge ${ret.type === 'return' ? 'badge-danger' : 'badge-primary'}">${ret.type}</span>
                                                    <span class="badge ${ret.status === 'completed' ? 'badge-success' : 'badge-warning'}" style="margin-left: 4px;">${ret.status}</span>
                                                    <div style="font-weight: 700; font-size: 18px; color: var(--danger); margin-top: 8px;">
                                                        ${formatCurrency(ret.total)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                ${ret.items.map(item => `
                                                    <div class="mb-2">
                                                        <div class="flex justify-between text-small mb-1">
                                                            <span style="font-weight: 600;">${item.name} x ${item.qty}</span>
                                                            <span>${formatCurrency(item.price * item.qty)}</span>
                                                        </div>
                                                        <div class="text-xs text-gray-600">Reason: ${item.reason || 'N/A'}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${ret.status === 'pending' ? `
                                                <button onclick="completeReturn('${ret.id}')" class="btn btn-success w-full mt-3" style="padding: 6px 12px; font-size: 14px;">
                                                    <i class="fas fa-check mr-1"></i>Complete Return
                                                </button>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-muted text-center py-8">No returns/exchanges found</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Slow-Moving Stock Section -->
                        ${slowMovingProducts.length > 0 ? `
                            <div class="card mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 style="font-size: 1.5rem; font-weight: 600;">Slow-Moving / Not-Moving Stock</h2>
                                        <p class="text-small text-gray-600 mt-1">Products with no sales in the last 90 days</p>
                                    </div>
                                    <button onclick="exportSlowMovingStock()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-download mr-2"></i>Export Data
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr>
                                                <th class="table-header">Product</th>
                                                <th class="table-header">SKU</th>
                                                <th class="table-header">Category</th>
                                                <th class="table-header">Current Stock</th>
                                                <th class="table-header">Unit Price</th>
                                                <th class="table-header">Stock Value</th>
                                                <th class="table-header">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${slowMovingProducts.map(product => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="table-cell">
                                                        <div class="flex items-center space-x-3">
                                                            <span class="text-2xl">${product.image}</span>
                                                            <span class="font-semibold text-gray-800">${product.name}</span>
                                                        </div>
                                                    </td>
                                                    <td class="table-cell text-gray-600">${product.sku}</td>
                                                    <td class="table-cell">
                                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                                                    </td>
                                                    <td class="table-cell">
                                                        <span class="font-bold text-orange-600">${product.stock}</span>
                                                    </td>
                                                    <td class="table-cell font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                                                    <td class="table-cell font-bold text-orange-600">${formatCurrency(product.stockValue)}</td>
                                                    <td class="table-cell">
                                                        <span class="badge badge-warning">Not Moving</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : `
                            <div class="card mb-8">
                                <div class="text-center py-8">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                                    <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800);">All Stock is Moving Well!</h2>
                                    <p class="text-small text-gray-600 mt-2">No products identified as slow-moving in the last 90 days.</p>
                                </div>
                            </div>
                        `}

                        <!-- All Stock Data Section -->
                        <div class="card mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h2 style="font-size: 1.5rem; font-weight: 600;">All Stock Data</h2>
                                    <p class="text-small text-gray-600 mt-1">Complete inventory overview with stock levels and values</p>
                                </div>
                                <button onclick="exportAllStockData()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-download mr-2"></i>Export Data
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="stockSearch" placeholder="Search products by name, SKU, or barcode..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" oninput="filterStockData(this.value)" style="padding-right: 45px;">
                                    <button type="button" onclick="scanBarcodeForStock()" class="absolute right-3 top-1/2 transform -translate-y-1/2" style="background: transparent; border: none; cursor: pointer; color: var(--gray-500); padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--gray-500)'">
                                        <i class="fas fa-barcode" style="font-size: 18px;"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full" id="stockDataTable">
                                    <thead>
                                        <tr>
                                            <th class="table-header text-left">Product</th>
                                            <th class="table-header text-left">SKU</th>
                                            <th class="table-header text-left">Category</th>
                                            <th class="table-header text-left">Current Stock</th>
                                            <th class="table-header text-left">Unit Price</th>
                                            <th class="table-header text-left">Stock Value</th>
                                            <th class="table-header text-left">Barcode</th>
                                            <th class="table-header text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${products.map(product => {
                                            const stockValue = product.stock * product.price;
                                            const stockStatus = product.stock === 0 ? 'out' : product.stock < 10 ? 'low' : 'good';
                                            return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="table-cell text-left">
                                                    <div class="flex items-center space-x-3">
                                                        <span class="text-2xl">${product.image}</span>
                                                        <span class="font-semibold text-gray-800">${product.name}</span>
                                                    </div>
                                                </td>
                                                <td class="table-cell text-left text-gray-600">${product.sku}</td>
                                                <td class="table-cell text-left">
                                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                                                </td>
                                                <td class="table-cell text-left">
                                                    <span class="font-bold ${stockStatus === 'out' ? 'text-red-600' : stockStatus === 'low' ? 'text-orange-600' : 'text-green-600'}">${product.stock}</span>
                                                </td>
                                                <td class="table-cell text-left font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                                                <td class="table-cell text-left font-bold text-gray-800">${formatCurrency(stockValue)}</td>
                                                <td class="table-cell text-left text-gray-600 text-sm">${product.barcode}</td>
                                                <td class="table-cell text-left">
                                                    ${stockStatus === 'out' ? '<span class="badge badge-danger">Out of Stock</span>' : 
                                                      stockStatus === 'low' ? '<span class="badge badge-warning">Low Stock</span>' : 
                                                      '<span class="badge badge-success">In Stock</span>'}
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function SettingsPage() {
            const settings = store.getState().settings;
            return `
                <div class="flex">
                    ${POSSidebar()}
                    <main class="flex-1 p-8 overflow-y-auto animate-fade-in">
                        <h1 class="text-3xl font-bold mb-8 text-gray-800">Settings</h1>
                        <div class="max-w-2xl">
                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Business Information</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Business Name</label>
                                        <input type="text" id="businessName" value="${settings.businessName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Default Tax Rate (%)</label>
                                        <input type="number" id="taxRate" value="${settings.taxRate}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                        <p class="text-xs text-gray-500 mt-1">Used as fallback for backward compatibility</p>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2 font-medium">Currency</label>
                                        <div class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
                                            INR - Indian Rupee
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Tax Rates Management</h2>
                                    <button onclick="showAddTaxRateModal()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-plus mr-2"></i>Add Tax Rate
                                    </button>
                                </div>
                                <div class="space-y-3" id="taxRatesList">
                                    ${(settings.taxRates || []).map((tax, index) => `
                                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                            <div class="flex items-center gap-4">
                                                <div>
                                                    <div class="font-semibold text-gray-800">${tax.name}</div>
                                                    <div class="text-sm text-gray-600">${tax.rate}% â€¢ ${tax.type.toUpperCase()}</div>
                                                </div>
                                                ${settings.defaultTaxType === tax.type ? '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Default</span>' : ''}
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="setDefaultTaxType('${tax.type}')" class="btn" style="padding: 6px 12px; font-size: 14px; ${settings.defaultTaxType === tax.type ? 'background: var(--gray-200);' : ''}">
                                                    <i class="fas fa-check-circle"></i> Set Default
                                                </button>
                                                <button onclick="deleteTaxRate(${index})" class="btn" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 14px;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${(!settings.taxRates || settings.taxRates.length === 0) ? `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-receipt text-4xl mb-4 text-gray-300"></i>
                                            <p>No tax rates configured. Add your first tax rate above.</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <h2 class="text-xl font-bold mb-4 text-gray-800">Data Management</h2>
                                <div class="space-y-3">
                                    <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition">
                                        <i class="fas fa-download mr-2"></i>Export All Data
                                    </button>
                                </div>
                            </div>

                            <button onclick="saveSettings()" class="w-full mt-6 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </main>
                </div>
            `;
        }

        function addToCart(productId) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const cart = store.getState().cart;
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            store.setState({ cart });
        }

        function removeFromCart(index) {
            const cart = store.getState().cart;
            cart.splice(index, 1);
            store.setState({ cart });
        }

        function updateCartQty(index, change) {
            const cart = store.getState().cart;
            cart[index].qty += change;
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }
            store.setState({ cart });
        }

        function clearCart() {
            try {
                store.setState({ cart: [], discount: 0, selectedCustomer: null, exchangeCredit: 0, currentReturnId: null });
                // Clear customer info display
                try {
                    const displayName = document.getElementById('displayName');
                    const displayMobile = document.getElementById('displayMobile');
                    const displayEmail = document.getElementById('displayEmail');
                    if (displayName) displayName.textContent = 'Walk-in Customer';
                    if (displayMobile) displayMobile.textContent = '-';
                    if (displayEmail) displayEmail.textContent = '-';
                } catch (domError) {
                    console.warn('Error clearing customer display:', domError);
                }
                store.render(); // Explicitly render to update UI
            } catch (error) {
                console.error('Error in clearCart:', error);
                // Still try to clear the state even if render fails
                try {
                    store.setState({ cart: [], discount: 0, selectedCustomer: null, exchangeCredit: 0, currentReturnId: null });
                } catch (e) {
                    console.error('Failed to clear cart state:', e);
                }
            }
        }

        function toggleCustomerForm() {
            const form = document.getElementById('customerForm');
            const display = document.getElementById('customerDisplay');
            const btn = document.getElementById('toggleCustomerBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                display.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-times mr-1"></i>Cancel';
            } else {
                form.classList.add('hidden');
                display.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-edit mr-1"></i>Edit';
                // Clear form
                document.getElementById('customerName').value = '';
                document.getElementById('customerMobile').value = '';
                document.getElementById('customerEmail').value = '';
            }
        }

        function saveCustomerInfo() {
            const name = document.getElementById('customerName').value.trim();
            const mobile = document.getElementById('customerMobile').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name || !mobile) {
                alert('Please enter customer name and mobile number');
                return;
            }
            
            // Validate name - must be only alphabets and spaces
            if (!/^[A-Za-z\s]+$/.test(name) || name.length < 2) {
                alert('Name must contain only letters and be at least 2 characters long');
                const nameInput = document.getElementById('customerName');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.style.borderColor = 'var(--danger)';
                }
                return;
            }
            
            // Validate mobile number - must be exactly 10 digits
            if (mobile.length !== 10 || !/^[0-9]{10}$/.test(mobile)) {
                alert('Please enter a valid 10-digit mobile number');
                const mobileInput = document.getElementById('customerMobile');
                if (mobileInput) {
                    mobileInput.focus();
                    mobileInput.style.borderColor = 'var(--danger)';
                }
                return;
            }
            
            // Update display
            document.getElementById('displayName').textContent = name;
            document.getElementById('displayMobile').textContent = mobile;
            document.getElementById('displayEmail').textContent = email || '-';
            
            // Store in state
            store.setState({ 
                customerInfo: { name, mobile, email }
            });
            
            // Hide form and show display
            toggleCustomerForm();
        }

        function selectCustomer(customerId) {
            store.setState({ selectedCustomer: customerId ? parseInt(customerId) : null });
        }

        function filterByCategory(category) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const grid = document.getElementById('productsGrid');
            const filtered = category ? products.filter(p => p.category === category) : products;
            grid.innerHTML = filtered.map(p => `
                <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                    <div style="font-size: 48px; margin-bottom: 12px; text-align: center;">${p.image}</div>
                    <div style="font-weight: 600; font-size: 15px; color: var(--gray-900); margin-bottom: 4px;">${p.name}</div>
                    <div class="text-small" style="margin-bottom: 8px;">${p.category}</div>
                    <div class="price-display" style="font-size: 1.25rem;">${formatCurrency(p.price)}</div>
                    <div class="text-small" style="margin-top: 4px;">Stock: ${p.stock}</div>
                </div>
            `).join('');
        }

        function applyCoupon() {
            const code = document.getElementById('couponCode').value.toUpperCase();
            const coupons = JSON.parse(localStorage.getItem('coupons') || '[]');
            const coupon = coupons.find(c => c.code === code && c.valid);
            
            if (coupon) {
                store.setState({ 
                    discount: coupon.discount, 
                    discountType: coupon.type 
                });
                document.getElementById('discountValue').value = coupon.discount;
                document.getElementById('discountType').value = coupon.type;
                alert(`Coupon "${code}" applied! ${coupon.discount}${coupon.type === 'percentage' ? '%' : ' ' + getCurrencySymbol()} discount.`);
            } else {
                alert('Invalid or expired coupon code!');
            }
        }

        function setDiscount(value) {
            store.setState({ discount: parseFloat(value) || 0 });
        }

        function setDiscountType(type) {
            store.setState({ discountType: type });
        }

        function removeDiscount() {
            store.setState({ discount: 0, discountType: 'percentage' });
            document.getElementById('discountValue').value = 0;
            document.getElementById('discountType').value = 'percentage';
            document.getElementById('couponCode').value = '';
        }

        function holdOrder() {
            const cart = store.getState().cart;
            const selectedCustomer = store.getState().selectedCustomer;
            const discount = store.getState().discount || 0;
            const discountType = store.getState().discountType || 'percentage';
            const exchangeCredit = store.getState().exchangeCredit || 0;
            const currentReturnId = store.getState().currentReturnId || null;
            
            if (cart.length === 0) return;
            
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            const orderNumber = heldOrders.length + 1;
            const orderLabel = `Order #${orderNumber}`;
            
            const newOrder = {
                id: `HOLD-${Date.now()}`,
                date: new Date().toISOString(),
                customer: orderLabel,
                items: [...cart],
                discount,
                discountType,
                exchangeCredit: exchangeCredit, // Save exchange credit
                currentReturnId: currentReturnId // Save return ID
            };
            
            heldOrders.push(newOrder);
            localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
            store.setState({ heldOrders, cart: [], discount: 0, selectedCustomer: null, exchangeCredit: 0, currentReturnId: null });
            store.render(); // Explicitly render to update UI
            alert(`Order held successfully! (${heldOrders.length} held orders)`);
        }

        function showHeldOrders() {
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            if (heldOrders.length === 0) {
                alert('No held orders found.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">Held Orders (${heldOrders.length})</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${heldOrders.map((order, index) => {
                            const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                            let discountAmount = 0;
                            if (order.discountType === 'percentage') {
                                discountAmount = (subtotal * order.discount) / 100;
                            } else {
                                discountAmount = order.discount;
                            }
                            const afterDiscount = subtotal - discountAmount;
                            const exchangeCredit = order.exchangeCredit || 0;
                            const total = Math.max(0, afterDiscount - exchangeCredit);
                            return `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">${order.customer}</div>
                                            <div class="text-small">${new Date(order.date).toLocaleString()}</div>
                                            <div class="text-small mt-1">${order.items.length} items</div>
                                            ${exchangeCredit > 0 ? `<div class="text-small mt-1" style="color: var(--info);">Exchange Credit: ${formatCurrency(exchangeCredit)}</div>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <div style="font-weight: 700; font-size: 18px; color: var(--primary);">${formatCurrency(total)}</div>
                                            <button onclick="loadHeldOrder(${index})" class="btn btn-primary mt-2" style="padding: 6px 12px; font-size: 14px;">
                                                <i class="fas fa-arrow-right mr-1"></i>Load
                                            </button>
                                            <button onclick="deleteHeldOrder(${index})" class="btn mt-2" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 14px; margin-left: 4px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function loadHeldOrder(index) {
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            const order = heldOrders[index];
            
            if (order) {
                const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                const customer = customers.find(c => c.name === order.customer);
                store.setState({
                    cart: order.items,
                    selectedCustomer: customer ? customer.id : null,
                    discount: order.discount || 0,
                    discountType: order.discountType || 'percentage',
                    exchangeCredit: order.exchangeCredit || 0, // Restore exchange credit
                    currentReturnId: order.currentReturnId || null // Restore return ID
                });
                document.querySelector('.modal-backdrop')?.remove();
                store.render(); // Explicitly render to update UI
                alert('Order loaded successfully!');
            }
        }

        function deleteHeldOrder(index) {
            if (!confirm('Delete this held order?')) return;
            const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
            heldOrders.splice(index, 1);
            localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
            store.setState({ heldOrders });
            showHeldOrders();
        }

        function selectPaymentMethod(paymentMethod, buttonElement) {
            const cart = store.getState().cart;
            if (cart.length === 0) return;
            
            // Remove selected class from all payment buttons
            document.querySelectorAll('.payment-option-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (!btn.disabled && !btn.classList.contains('selected')) {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--gray-300)';
                    btn.style.color = 'var(--gray-700)';
                    const iconDiv = btn.querySelector('div');
                    if (iconDiv) iconDiv.style.color = 'var(--gray-600)';
                }
            });
            
            // Add selected class to clicked button
            if (!buttonElement.disabled) {
                buttonElement.classList.add('selected');
                buttonElement.style.background = '#10b981';
                buttonElement.style.borderColor = '#10b981';
                buttonElement.style.color = 'white';
                const iconDiv = buttonElement.querySelector('div');
                if (iconDiv) iconDiv.style.color = 'white';
                
                // Show customer information modal
                showCustomerInfoModal(paymentMethod, buttonElement);
            }
        }

        function showCustomerInfoModal(paymentMethod, buttonElement) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 animate-fade-in shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">Customer Information</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);" onmouseover="this.style.background='var(--gray-300)'" onmouseout="this.style.background='var(--gray-200)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="customerInfoForm" onsubmit="submitCustomerInfo(event, '${paymentMethod}', this.closest('.modal-backdrop'))">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Name <span class="text-muted" style="font-weight: 400;">(Optional)</span>
                                </label>
                                <input type="text" id="customerNameInput" name="name" 
                                    class="input-field" 
                                    placeholder="Enter customer name (letters only)"
                                    style="padding: 12px; font-size: 15px;"
                                    pattern="[A-Za-z\s]+"
                                    oninput="this.value = this.value.replace(/[^A-Za-z\s]/g, ''); validateName(this)"
                                    autocomplete="off">
                                <div id="nameError" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Mobile Number <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="tel" id="customerMobileInput" name="mobile" required 
                                    class="input-field" 
                                    placeholder="Enter 10-digit mobile number"
                                    style="padding: 12px; font-size: 15px;"
                                    pattern="[0-9]{10}"
                                    maxlength="10"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10); validateMobileNumber(this)"
                                    autocomplete="off">
                                <div id="mobileError" class="text-xs text-red-600 mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Email <span class="text-muted" style="font-weight: 400;">(Optional)</span>
                                </label>
                                <input type="email" id="customerEmailInput" name="email" 
                                    class="input-field" 
                                    placeholder="Enter email address"
                                    style="padding: 12px; font-size: 15px;"
                                    autocomplete="off">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" 
                                class="flex-1" 
                                style="background: var(--gray-200); color: var(--gray-700); padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='var(--gray-300)'" 
                                onmouseout="this.style.background='var(--gray-200)'">
                                Cancel
                            </button>
                            <button type="submit" 
                                class="flex-1 btn-primary" 
                                style="padding: 12px; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-check mr-2"></i>Proceed to Payment
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('customerNameInput')?.focus();
            }, 100);
        }

        function validateName(input) {
            const name = input.value.trim();
            const errorDiv = document.getElementById('nameError');
            
            if (!errorDiv) return;
            
            if (name.length === 0) {
                errorDiv.classList.add('hidden');
                input.style.borderColor = '';
                return;
            }
            
            if (!/^[A-Za-z\s]+$/.test(name)) {
                errorDiv.textContent = 'Name must contain only letters and spaces';
                errorDiv.classList.remove('hidden');
                input.style.borderColor = 'var(--danger)';
            } else if (name.length < 2) {
                errorDiv.textContent = 'Name must be at least 2 characters';
                errorDiv.classList.remove('hidden');
                input.style.borderColor = 'var(--danger)';
            } else {
                errorDiv.classList.add('hidden');
                input.style.borderColor = '#10b981'; // green border for valid
            }
        }

        function validateMobileNumber(input) {
            const mobile = input.value.trim();
            const errorDiv = document.getElementById('mobileError');
            
            if (!errorDiv) return;
            
            if (mobile.length === 0) {
                errorDiv.classList.add('hidden');
                input.style.borderColor = '';
                return;
            }
            
            if (mobile.length !== 10) {
                errorDiv.textContent = 'Mobile number must be exactly 10 digits';
                errorDiv.classList.remove('hidden');
                input.style.borderColor = 'var(--danger)';
            } else if (!/^[0-9]{10}$/.test(mobile)) {
                errorDiv.textContent = 'Mobile number must contain only digits';
                errorDiv.classList.remove('hidden');
                input.style.borderColor = 'var(--danger)';
            } else {
                errorDiv.classList.add('hidden');
                input.style.borderColor = '#10b981'; // green border for valid
            }
        }

        function submitCustomerInfo(event, paymentMethod, modalElement) {
            event.preventDefault();
            
            const form = event.target;
            const name = form.querySelector('#customerNameInput').value.trim();
            const mobile = form.querySelector('#customerMobileInput').value.trim();
            const email = form.querySelector('#customerEmailInput').value.trim();
            
            // Only mobile is required
            if (!mobile) {
                alert('Please enter mobile number');
                return;
            }
            
            // Validate mobile number - must be exactly 10 digits
            if (mobile.length !== 10 || !/^[0-9]{10}$/.test(mobile)) {
                alert('Please enter a valid 10-digit mobile number');
                const mobileInput = form.querySelector('#customerMobileInput');
                if (mobileInput) {
                    mobileInput.focus();
                    mobileInput.style.borderColor = 'var(--danger)';
                }
                return;
            }
            
            // Validate name if provided - must be only alphabets and spaces
            if (name && (!/^[A-Za-z\s]+$/.test(name) || name.length < 2)) {
                alert('Name must contain only letters and be at least 2 characters long');
                const nameInput = form.querySelector('#customerNameInput');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.style.borderColor = 'var(--danger)';
                }
                return;
            }
            
            // Store customer info in state (name can be empty)
            store.setState({ 
                customerInfo: { name: name || 'Walk-in Customer', mobile, email }
            });
            
            // Remove modal
            modalElement.remove();
            
            // Proceed with checkout
            checkout(paymentMethod);
        }

        function showPaymentSuccessModal(invoiceId) {
            const currentPage = store.getState().currentPage;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.backdropFilter = 'blur(4px)';
            modal.style.zIndex = '9998'; // Lower z-index so print dialog appears on top
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl" style="animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);">
                    <div class="text-center">
                        <!-- Success Icon with Animation -->
                        <div class="mx-auto flex items-center justify-center h-24 w-24 rounded-full bg-gradient-to-br from-green-400 to-green-600 mb-6 shadow-lg" style="animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;">
                            <i class="fas fa-check text-5xl text-white"></i>
                        </div>
                        
                        <!-- Success Message -->
                        <h2 class="text-3xl font-bold text-gray-900 mb-3" style="animation: fadeInUp 0.5s ease-out 0.3s both;">Payment Successful!</h2>
                        <p class="text-gray-600 mb-1 text-lg" style="animation: fadeInUp 0.5s ease-out 0.4s both;">
                            Invoice <span class="font-bold text-indigo-600 text-xl">${invoiceId}</span>
                        </p>
                        <p class="text-gray-500 text-sm mb-6" style="animation: fadeInUp 0.5s ease-out 0.5s both;">has been created successfully</p>
                        
                        <!-- Decorative Line -->
                        <div class="my-6" style="animation: fadeInUp 0.5s ease-out 0.6s both;">
                            <div class="h-1 w-32 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-full mx-auto"></div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="mt-8" style="animation: fadeInUp 0.5s ease-out 0.7s both;">
                            <button id="continuePaymentBtn" 
                                class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95">
                                <i class="fas fa-check mr-2"></i>Continue
                            </button>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-30px) scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    @keyframes scaleIn {
                        from {
                            transform: scale(0) rotate(-180deg);
                        }
                        to {
                            transform: scale(1) rotate(0deg);
                        }
                    }
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                </style>
            `;
            document.body.appendChild(modal);
            
            // After print window closes, bring modal to front
            setTimeout(() => {
                modal.style.zIndex = '9999'; // Bring to front after print
            }, 3000);
            
            // Handle continue button click - only way to close modal
            const continueBtn = modal.querySelector('#continuePaymentBtn');
            continueBtn.addEventListener('click', () => {
                // Close any open print windows (not the main window)
                try {
                    if (window.currentPrintWindow && !window.currentPrintWindow.closed) {
                        window.currentPrintWindow.close();
                    }
                } catch (e) {}
                
                // Determine where to redirect based on current page
                if (currentPage === 'pos') {
                    store.navigate('dashboard');
                } else {
                    store.navigate('dashboard');
                }
                
                // Close modal with animation
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            });
            
            // Don't allow closing on backdrop click - only Continue button
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    // Do nothing - require Continue button click
                }
            });
        }

        function checkout(paymentMethod) {
            try {
                const cart = store.getState().cart;
                const settings = store.getState().settings;
                const discount = store.getState().discount || 0;
                const discountType = store.getState().discountType || 'percentage';
                const exchangeCredit = store.getState().exchangeCredit || 0;
                const customerInfo = store.getState().customerInfo || {};
                
                if (cart.length === 0) {
                    alert('Cart is empty. Please add items to cart.');
                    return;
                }
                
                const allCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
                let customer = null;
                let customerName = 'Walk-in Customer';
                let customerEmail = '';
                let customerPhone = '';
                
                // Use customer info from modal (mobile is required, name is optional)
                if (customerInfo.mobile) {
                    customerName = customerInfo.name || 'Walk-in Customer';
                    customerEmail = customerInfo.email || '';
                    customerPhone = customerInfo.mobile;
                    
                    // Check if customer already exists by phone
                    const existingCustomer = allCustomers.find(c => c.phone === customerPhone);
                    if (existingCustomer) {
                        customer = existingCustomer;
                        // Update name if provided and different
                        if (customerInfo.name && customerInfo.name !== 'Walk-in Customer' && customerInfo.name !== existingCustomer.name) {
                            existingCustomer.name = customerInfo.name;
                        }
                        // Update email if provided
                        if (customerEmail && customerEmail !== existingCustomer.email) {
                            existingCustomer.email = customerEmail;
                        }
                    } else {
                        // Create new customer
                        const maxId = allCustomers.length > 0 ? Math.max(...allCustomers.map(c => (c.id || 0))) : 0;
                        const newCustomer = {
                            id: maxId + 1,
                            name: customerName,
                            email: customerEmail || `${customerName.toLowerCase().replace(/\s+/g, '')}@email.com`,
                            phone: customerPhone,
                            totalPurchases: 0,
                            lastPurchase: new Date().toISOString().split('T')[0]
                        };
                        allCustomers.push(newCustomer);
                        customer = newCustomer;
                        // Save new customer to localStorage immediately
                        localStorage.setItem('customers', JSON.stringify(allCustomers));
                    }
                }
                
                // Calculate invoice totals with proper order: subtotal -> discount -> exchange credit -> tax -> total
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                
                // Calculate discount
                let discountAmount = 0;
                if (discountType === 'percentage') {
                    discountAmount = (subtotal * discount) / 100;
                } else {
                    discountAmount = discount;
                }
                
                // Apply discount to subtotal
                const afterDiscount = Math.max(0, subtotal - discountAmount);
                
                // Apply exchange credit after discount
                const afterExchange = Math.max(0, afterDiscount - exchangeCredit);
                
                // Calculate tax on the amount after discount and exchange credit
                const tax = afterExchange * (settings.taxRate / 100);
                
                // Final total is afterExchange + tax
                const total = afterExchange + tax;
                
                // Get current return ID and details BEFORE clearing state
                const currentReturnId = store.getState().currentReturnId;
                let exchangeReturnDetails = null;
                
                // Get exchange/return details if exists
                if (currentReturnId) {
                    try {
                        const returns = JSON.parse(localStorage.getItem('returns') || '[]');
                        exchangeReturnDetails = returns.find(r => r && r.id === currentReturnId);
                        // Ensure exchangeReturnDetails has required properties
                        if (exchangeReturnDetails && (!exchangeReturnDetails.items || !Array.isArray(exchangeReturnDetails.items))) {
                            exchangeReturnDetails.items = exchangeReturnDetails.items || [];
                        }
                    } catch (error) {
                        console.warn('Error loading return details:', error);
                        exchangeReturnDetails = null;
                    }
                }
                
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                // Generate unique invoice ID - handle edge cases
                let maxInvoiceNum = 0;
                if (invoices.length > 0) {
                    const invoiceNumbers = invoices
                        .map(inv => {
                            if (!inv || !inv.id) return 0;
                            const match = inv.id.match(/INV-(\d+)/);
                            return match ? parseInt(match[1]) : 0;
                        })
                        .filter(num => !isNaN(num) && num > 0);
                    
                    if (invoiceNumbers.length > 0) {
                        maxInvoiceNum = Math.max(...invoiceNumbers);
                    }
                }
                const newInvoiceId = `INV-${String(maxInvoiceNum + 1).padStart(3, '0')}`;
                
                // Store intermediate values for transparency and verification
                const afterDiscountValue = parseFloat(afterDiscount.toFixed(2));
                const afterExchangeValue = parseFloat(afterExchange.toFixed(2));
                
                // Create new invoice with all calculated values and complete information
                const newInvoice = {
                    id: newInvoiceId,
                    date: new Date().toISOString().split('T')[0],
                    customer: customerName,
                    customerPhone: customerPhone || '',
                    customerEmail: customerEmail || '',
                    items: cart.map(item => ({ 
                        name: item.name, 
                        qty: item.qty, 
                        price: parseFloat(item.price.toFixed(2))
                    })),
                    // Financial breakdown
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    discount: parseFloat(discountAmount.toFixed(2)),
                    discountType: discountType, // Store discount type for reference
                    afterDiscount: afterDiscountValue, // Amount after discount applied
                    exchangeCredit: parseFloat(exchangeCredit.toFixed(2)), // Exchange credit amount deducted
                    afterExchange: afterExchangeValue, // Amount after exchange credit applied
                    taxRate: settings.taxRate, // Tax rate used for calculation
                    tax: parseFloat(tax.toFixed(2)),
                    total: parseFloat(total.toFixed(2)),
                    // Payment and status
                    payment: paymentMethod,
                    status: 'completed',
                    // Exchange/Return information - include full details in invoice
                    returnId: currentReturnId || null, // Link to return/exchange if exists
                    exchangeReturnDetails: exchangeReturnDetails ? {
                        id: exchangeReturnDetails.id || '',
                        type: exchangeReturnDetails.type || 'return', // 'return' or 'exchange'
                        originalInvoiceId: exchangeReturnDetails.invoiceId || '',
                        items: Array.isArray(exchangeReturnDetails.items) ? exchangeReturnDetails.items : [], // Items that were returned/exchanged
                        total: parseFloat(exchangeReturnDetails.total || 0),
                        date: exchangeReturnDetails.date || new Date().toISOString().split('T')[0]
                    } : null
                };
                
                // Verify calculation is correct - recalculate from stored values
                const verifyAfterDiscount = newInvoice.subtotal - newInvoice.discount;
                const verifyAfterExchange = Math.max(0, verifyAfterDiscount - newInvoice.exchangeCredit);
                const verifyTax = verifyAfterExchange * (newInvoice.taxRate / 100);
                const verifyTotal = verifyAfterExchange + verifyTax;
                
                // Ensure values match (with small tolerance for floating point errors)
                const tolerance = 0.01;
                if (Math.abs(newInvoice.afterDiscount - verifyAfterDiscount) > tolerance ||
                    Math.abs(newInvoice.afterExchange - verifyAfterExchange) > tolerance ||
                    Math.abs(newInvoice.tax - verifyTax) > tolerance ||
                    Math.abs(newInvoice.total - verifyTotal) > tolerance) {
                    console.warn('Invoice calculation verification failed, correcting values', {
                        stored: { afterDiscount: newInvoice.afterDiscount, afterExchange: newInvoice.afterExchange, tax: newInvoice.tax, total: newInvoice.total },
                        calculated: { afterDiscount: verifyAfterDiscount, afterExchange: verifyAfterExchange, tax: verifyTax, total: verifyTotal }
                    });
                    // Use verified calculated values
                    newInvoice.afterDiscount = parseFloat(verifyAfterDiscount.toFixed(2));
                    newInvoice.afterExchange = parseFloat(verifyAfterExchange.toFixed(2));
                    newInvoice.tax = parseFloat(verifyTax.toFixed(2));
                    newInvoice.total = parseFloat(verifyTotal.toFixed(2));
                }
                
                invoices.push(newInvoice);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                // Update customer total purchases
                if (customer) {
                    customer.totalPurchases += total;
                    customer.lastPurchase = newInvoice.date;
                    // Update email if provided in form
                    if (customerInfo.email && customerInfo.email !== customer.email) {
                        customer.email = customerInfo.email;
                    }
                    // Update customer in the allCustomers array
                    const customerIndex = allCustomers.findIndex(c => c.id === customer.id);
                    if (customerIndex !== -1) {
                        allCustomers[customerIndex] = customer;
                    } else {
                        allCustomers.push(customer);
                    }
                    localStorage.setItem('customers', JSON.stringify(allCustomers));
                }
                
                // Clear customer info, exchange credit, and return ID from state
                store.setState({ customerInfo: null, exchangeCredit: 0, currentReturnId: null });
                
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                cart.forEach(cartItem => {
                    const product = products.find(p => p.id === cartItem.id);
                    if (product) {
                        product.stock -= cartItem.qty;
                    }
                });
                localStorage.setItem('products', JSON.stringify(products));
                
                // Clear payment selection
                document.querySelectorAll('.payment-option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (!btn.disabled) {
                        btn.style.background = 'white';
                        btn.style.borderColor = 'var(--gray-300)';
                        btn.style.color = 'var(--gray-700)';
                        const iconDiv = btn.querySelector('div');
                        if (iconDiv) iconDiv.style.color = 'var(--gray-600)';
                    }
                });
                
                // Show success modal first (it will be in background behind print dialog)
                showPaymentSuccessModal(newInvoice.id);
                
                // Print only the new invoice which includes all exchange/return information
                try {
                    printInvoice(newInvoice.id);
                } catch (printError) {
                    console.error('Error printing invoice:', printError);
                    // Continue even if print fails
                }
                
                // Clear cart (exchangeCredit and currentReturnId already cleared above)
                // Wrap in try-catch to prevent errors from breaking the checkout flow
                try {
                    clearCart();
                } catch (clearError) {
                    console.error('Error clearing cart:', clearError);
                    // Still try to clear the state manually
                    try {
                        store.setState({ cart: [], discount: 0, selectedCustomer: null, exchangeCredit: 0, currentReturnId: null });
                    } catch (e) {
                        console.error('Failed to clear cart state:', e);
                    }
                }
            } catch (error) {
                console.error('Error during checkout:', error);
                alert('An error occurred during checkout. Please try again.');
            }
        }

        function viewInvoice(invoiceId) {
            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const invoice = invoices.find(inv => inv && inv.id === invoiceId);
                if (!invoice) {
                    alert('Invoice not found!');
                    return;
                }
                
                const currencySymbol = getCurrencySymbol();
                const settings = store.getState().settings;
                const isCreditNote = invoice.isCreditNote || invoice.id.startsWith('CN-');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--gray-900);">${isCreditNote ? 'Credit Note' : 'Invoice'} Details</h2>
                            <p class="text-small text-gray-600 mt-1">${invoice.id}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="${isCreditNote ? 'printCreditNote' : 'printInvoice'}('${invoiceId}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                <i class="fas fa-print mr-2"></i>Print
                            </button>
                            <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);" onmouseover="this.style.background='var(--gray-300)'" onmouseout="this.style.background='var(--gray-200)'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Invoice/Credit Note Header -->
                    <div class="bg-gradient-to-r ${isCreditNote ? 'from-red-600 to-red-800' : 'from-indigo-600 to-indigo-800'} text-white p-6 rounded-lg mb-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">${settings.businessName}</h3>
                                <p class="text-sm opacity-90">${isCreditNote ? 'CREDIT NOTE' : 'INVOICE'}</p>
                            </div>
                            <div class="text-right">
                                <div style="font-size: 1.25rem; font-weight: 700;">${invoice.id}</div>
                                <div class="text-sm opacity-90 mt-1">${invoice.date}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Customer Information -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">Customer Information</h4>
                            <div class="space-y-2 text-sm">
                                <div><strong>Name:</strong> ${invoice.customer}</div>
                                ${invoice.customerPhone ? `<div><strong>Phone:</strong> ${invoice.customerPhone}</div>` : ''}
                                ${invoice.customerEmail ? `<div><strong>Email:</strong> ${invoice.customerEmail}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Payment Information -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">Payment Information</h4>
                            <div class="space-y-2 text-sm">
                                <div><strong>Payment Method:</strong> 
                                    <span class="px-3 py-1 ${invoice.payment === 'Cash' ? 'bg-green-100 text-green-800' : invoice.payment === 'UPI' ? 'bg-purple-100 text-purple-800' : invoice.payment === 'Credit Note' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs font-semibold ml-2">
                                        ${invoice.payment}
                                    </span>
                                </div>
                                <div><strong>Status:</strong> 
                                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold ml-2">
                                        ${invoice.status || 'Completed'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <div class="mb-6">
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">Items</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Item</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Quantity</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Unit Price</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${Array.isArray(invoice.items) && invoice.items.length > 0 ? invoice.items.map(item => {
                                        const itemName = item && item.name ? item.name : 'Unknown';
                                        const itemQty = item && item.qty ? item.qty : 0;
                                        const itemPrice = item && item.price ? parseFloat(item.price) : 0;
                                        const itemTotal = itemQty * itemPrice;
                                        return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-gray-800 font-medium">${itemName}</td>
                                            <td class="px-4 py-3 text-center text-gray-600">${itemQty}</td>
                                            <td class="px-4 py-3 text-right text-gray-600">${currencySymbol}${itemPrice.toFixed(2)}</td>
                                            <td class="px-4 py-3 text-right font-semibold text-gray-800">${currencySymbol}${itemTotal.toFixed(2)}</td>
                                        </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">No items</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    ${invoice.exchangeReturnDetails ? `
                    <!-- Exchange/Return Information -->
                    <div class="mb-6 p-4 rounded-lg" style="background: ${invoice.exchangeReturnDetails.type === 'exchange' ? '#fef3c7' : '#fee2e2'}; border: 2px solid ${invoice.exchangeReturnDetails.type === 'exchange' ? '#fcd34d' : '#fca5a5'};">
                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 12px;">
                            <i class="fas fa-${invoice.exchangeReturnDetails.type === 'exchange' ? 'exchange-alt' : 'undo'} mr-2"></i>
                            ${invoice.exchangeReturnDetails.type === 'exchange' ? 'Exchange' : 'Return'} Information
                        </h4>
                        <div class="space-y-2 text-sm mb-3">
                            <div><strong>${invoice.exchangeReturnDetails.type === 'exchange' ? 'Exchange' : 'Return'} ID:</strong> ${invoice.exchangeReturnDetails.id || 'N/A'}</div>
                            <div><strong>Original Invoice:</strong> ${invoice.exchangeReturnDetails.originalInvoiceId || 'N/A'}</div>
                            <div><strong>Date:</strong> ${invoice.exchangeReturnDetails.date || 'N/A'}</div>
                            <div><strong>Credit Applied:</strong> <span class="font-semibold text-blue-600">${currencySymbol}${(invoice.exchangeCredit || 0).toFixed(2)}</span></div>
                        </div>
                        ${invoice.exchangeReturnDetails.items && Array.isArray(invoice.exchangeReturnDetails.items) && invoice.exchangeReturnDetails.items.length > 0 ? `
                        <div class="mt-3">
                            <div class="text-sm font-semibold text-gray-700 mb-2">${invoice.exchangeReturnDetails.type === 'exchange' ? 'Exchanged' : 'Returned'} Items:</div>
                            <div class="space-y-1">
                                ${invoice.exchangeReturnDetails.items.map(item => {
                                    const itemName = item && item.name ? item.name : 'Unknown';
                                    const itemQty = item && item.qty ? item.qty : 0;
                                    const itemPrice = item && item.price ? item.price : 0;
                                    const itemTotal = itemPrice * itemQty;
                                    const itemReason = item && item.reason ? item.reason : '';
                                    return `
                                    <div class="flex justify-between text-sm bg-white p-2 rounded border border-gray-200">
                                        <span>${itemName} (Qty: ${itemQty})</span>
                                        <span class="font-semibold">${currencySymbol}${itemTotal.toFixed(2)}</span>
                                        ${itemReason ? `<span class="text-gray-500 text-xs ml-2">- ${itemReason}</span>` : ''}
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Totals -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="flex justify-end">
                            <div class="w-full max-w-md space-y-3">
                                <div class="flex justify-between text-gray-700">
                                    <span>Subtotal:</span>
                                    <span class="font-semibold">${currencySymbol}${(invoice.subtotal || 0).toFixed(2)}</span>
                                </div>
                                ${(invoice.discount || 0) > 0 ? `
                                    <div class="flex justify-between text-green-600">
                                        <span>Discount:</span>
                                        <span class="font-semibold">-${currencySymbol}${(invoice.discount || 0).toFixed(2)}</span>
                                    </div>
                                ` : ''}
                                ${(invoice.exchangeCredit || 0) > 0 ? `
                                    <div class="flex justify-between text-blue-600">
                                        <span>Return/Exchange Credit:</span>
                                        <span class="font-semibold">-${currencySymbol}${(invoice.exchangeCredit || 0).toFixed(2)}</span>
                                    </div>
                                ` : ''}
                                <div class="flex justify-between text-gray-700">
                                    <span>Tax (${settings.taxRate || 0}%):</span>
                                    <span class="font-semibold">${currencySymbol}${(invoice.tax || 0).toFixed(2)}</span>
                                </div>
                                <div class="border-t-2 border-gray-300 pt-3 mt-3">
                                    <div class="flex justify-between">
                                        <span style="font-size: 1.25rem; font-weight: 700; color: var(--gray-900);">Total:</span>
                                        <span style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${currencySymbol}${(invoice.total || 0).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            } catch (error) {
                console.error('Error in viewInvoice:', error);
                alert('Error loading invoice. Please try again.');
            }
        }

        function printInvoice(invoiceId) {
            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const invoice = invoices.find(inv => inv && inv.id === invoiceId);
                if (!invoice) {
                    console.warn('Invoice not found:', invoiceId);
                    return;
                }
                
                // Check if it's a credit note and redirect to printCreditNote
                const isCreditNote = invoice.isCreditNote || invoice.id.startsWith('CN-');
                if (isCreditNote) {
                    printCreditNote(invoiceId);
                    return;
                }
                
                const currencySymbol = getCurrencySymbol();
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    console.warn('Failed to open print window');
                    return;
                }
            window.currentPrintWindow = printWindow; // Store reference
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoice.id}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
                        * { font-family: 'Poppins', sans-serif; }
                        body { padding: 60px; background: white; }
                        .invoice-header { background: linear-gradient(135deg, ${invoice.isCreditNote || invoice.id.startsWith('CN-') ? '#ef4444' : '#2563eb'} 0%, ${invoice.isCreditNote || invoice.id.startsWith('CN-') ? '#dc2626' : '#1e40af'} 100%); color: white; padding: 40px; border-radius: 12px 12px 0 0; margin-bottom: 40px; }
                        .invoice-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
                        .invoice-subtitle { font-size: 1rem; opacity: 0.9; }
                        .invoice-details { margin-bottom: 40px; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .invoice-details div { margin: 8px 0; font-size: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
                        th { background: #f3f4f6; padding: 16px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: #374151; }
                        td { padding: 16px; border-bottom: 1px solid #e5e7eb; font-size: 15px; color: #1f2937; }
                        .totals { text-align: right; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .totals div { margin: 8px 0; font-size: 15px; }
                        .grand-total { font-size: 1.5rem; font-weight: 700; margin-top: 16px; color: #1f2937; }
                        .thank-you { text-align: center; margin-top: 60px; color: #6b7280; font-size: 15px; }
                    </style>
                </head>
                <body>
                    <div class="invoice-header">
                        <div class="invoice-title">${store.getState().settings.businessName}</div>
                        <div class="invoice-subtitle">${invoice.isCreditNote || invoice.id.startsWith('CN-') ? 'CREDIT NOTE' : 'INVOICE'}</div>
                    </div>
                    <div class="invoice-details">
                        <div><strong>${invoice.isCreditNote || invoice.id.startsWith('CN-') ? 'Credit Note' : 'Invoice'} ID:</strong> ${invoice.id}</div>
                        ${invoice.originalInvoiceId ? `<div><strong>Original Invoice:</strong> ${invoice.originalInvoiceId}</div>` : ''}
                        ${invoice.returnId ? `<div><strong>Return ID:</strong> ${invoice.returnId}</div>` : ''}
                        <div><strong>Date:</strong> ${invoice.date}</div>
                        <div><strong>Customer:</strong> ${invoice.customer}</div>
                        ${invoice.customerPhone ? `<div><strong>Phone:</strong> ${invoice.customerPhone}</div>` : ''}
                        ${invoice.customerEmail ? `<div><strong>Email:</strong> ${invoice.customerEmail}</div>` : ''}
                        <div><strong>Payment Method:</strong> ${invoice.payment}</div>
                    </div>
                    ${invoice.exchangeReturnDetails ? `
                    <div style="margin-bottom: 40px; padding: 24px; background: ${invoice.exchangeReturnDetails.type === 'exchange' ? '#fef3c7' : '#fee2e2'}; border: 2px solid ${invoice.exchangeReturnDetails.type === 'exchange' ? '#fcd34d' : '#fca5a5'}; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: #1f2937;">
                            ${invoice.exchangeReturnDetails.type === 'exchange' ? 'ðŸ”„ Exchange' : 'â†©ï¸ Return'} Information
                        </div>
                        <div style="font-size: 14px; margin-bottom: 8px;"><strong>${invoice.exchangeReturnDetails.type === 'exchange' ? 'Exchange' : 'Return'} ID:</strong> ${invoice.exchangeReturnDetails.id || 'N/A'}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;"><strong>Original Invoice:</strong> ${invoice.exchangeReturnDetails.originalInvoiceId || 'N/A'}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;"><strong>Credit Applied:</strong> <span style="font-weight: 600; color: #2563eb;">${currencySymbol}${(invoice.exchangeCredit || 0).toFixed(2)}</span></div>
                        ${invoice.exchangeReturnDetails.items && Array.isArray(invoice.exchangeReturnDetails.items) && invoice.exchangeReturnDetails.items.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">${invoice.exchangeReturnDetails.type === 'exchange' ? 'Exchanged' : 'Returned'} Items:</div>
                            ${invoice.exchangeReturnDetails.items.map(item => {
                                const itemName = item && item.name ? item.name : 'Unknown';
                                const itemQty = item && item.qty ? item.qty : 0;
                                const itemPrice = item && item.price ? item.price : 0;
                                const itemTotal = itemPrice * itemQty;
                                const itemReason = item && item.reason ? item.reason : '';
                                return `
                                <div style="font-size: 13px; margin: 4px 0; padding: 8px; background: white; border-radius: 4px;">
                                    ${itemName} (Qty: ${itemQty}) - ${currencySymbol}${itemTotal.toFixed(2)}${itemReason ? ` - ${itemReason}` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Array.isArray(invoice.items) && invoice.items.length > 0 ? invoice.items.map(item => {
                                const itemName = item && item.name ? item.name : 'Unknown';
                                const itemQty = item && item.qty ? item.qty : 0;
                                const itemPrice = item && item.price ? parseFloat(item.price) : 0;
                                const itemTotal = itemQty * itemPrice;
                                return `
                                <tr>
                                    <td>${itemName}</td>
                                    <td>${itemQty}</td>
                                    <td>${currencySymbol}${itemPrice.toFixed(2)}</td>
                                    <td>${currencySymbol}${itemTotal.toFixed(2)}</td>
                                </tr>
                                `;
                            }).join('') : '<tr><td colspan="4" style="text-align: center; padding: 20px;">No items</td></tr>'}
                        </tbody>
                    </table>
                    <div class="totals">
                        <div>Subtotal: ${currencySymbol}${(invoice.subtotal || 0).toFixed(2)}</div>
                        ${(invoice.discount || 0) > 0 ? `<div style="color: #059669; font-weight: 600;">Discount: -${currencySymbol}${(invoice.discount || 0).toFixed(2)}</div>` : ''}
                        ${(invoice.exchangeCredit || 0) > 0 ? `<div style="color: #2563eb; font-weight: 600;">Return/Exchange Credit: -${currencySymbol}${(invoice.exchangeCredit || 0).toFixed(2)}</div>` : ''}
                        <div>Tax (${store.getState().settings.taxRate || 0}%): ${currencySymbol}${(invoice.tax || 0).toFixed(2)}</div>
                        <div class="grand-total" style="color: ${invoice.isCreditNote || invoice.id.startsWith('CN-') ? '#dc2626' : '#1f2937'};">${invoice.isCreditNote || invoice.id.startsWith('CN-') ? 'Credit Amount' : 'Total'}: ${currencySymbol}${(invoice.total || 0).toFixed(2)}</div>
                    </div>
                    <div class="thank-you">
                        ${invoice.isCreditNote || invoice.id.startsWith('CN-') ? 'This credit note can be used for future purchases.' : 'Thank you for your business!'}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Add script to auto-close after print
            const script = printWindow.document.createElement('script');
            script.textContent = 'window.addEventListener("afterprint", function() { setTimeout(function() { window.close(); }, 100); }); window.onfocus = function() { setTimeout(function() { if (document.hasFocus()) { window.close(); } }, 500); };';
            printWindow.document.body.appendChild(script);
            
            // Trigger print (print dialog will appear on top of the modal)
            printWindow.focus();
            printWindow.print();
            
            // Monitor when print window closes to bring modal to front
            const checkPrintClosed = setInterval(() => {
                try {
                    if (printWindow.closed) {
                        clearInterval(checkPrintClosed);
                        // Bring modal to front after print window closes
                        setTimeout(() => {
                            const modalElement = document.querySelector('.modal-backdrop');
                            if (modalElement) {
                                modalElement.style.zIndex = '9999';
                            }
                        }, 100);
                    }
                } catch (e) {
                    clearInterval(checkPrintClosed);
                }
            }, 100);
            
            // Fallback: Close print window after 5 seconds if still open
            setTimeout(() => {
                clearInterval(checkPrintClosed);
                try {
                    if (!printWindow.closed) {
                        printWindow.close();
                    }
                } catch (e) {}
                // Bring modal to front
                setTimeout(() => {
                    const modalElement = document.querySelector('.modal-backdrop');
                    if (modalElement) {
                        modalElement.style.zIndex = '9999';
                    }
                }, 100);
            }, 5000);
            } catch (error) {
                console.error('Error in printInvoice:', error);
                alert('Error printing invoice. Please try again.');
            }
        }

        function generateAndPrintCreditNote(returnRecord, originalInvoice) {
            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const settings = store.getState().settings;
                const currencySymbol = getCurrencySymbol();
                
                // Generate unique credit note ID
                let maxCreditNoteNum = 0;
                const creditNotes = invoices.filter(inv => inv.id && inv.id.startsWith('CN-'));
                if (creditNotes.length > 0) {
                    const creditNoteNumbers = creditNotes
                        .map(inv => {
                            const match = inv.id.match(/CN-(\d+)/);
                            return match ? parseInt(match[1]) : 0;
                        })
                        .filter(num => !isNaN(num) && num > 0);
                    
                    if (creditNoteNumbers.length > 0) {
                        maxCreditNoteNum = Math.max(...creditNoteNumbers);
                    }
                }
                const creditNoteId = `CN-${String(maxCreditNoteNum + 1).padStart(3, '0')}`;
                
                // Calculate credit note totals
                const subtotal = returnRecord.total;
                const tax = subtotal * (settings.taxRate / 100);
                const total = subtotal + tax;
                
                // Create credit note invoice
                const creditNote = {
                    id: creditNoteId,
                    date: new Date().toISOString().split('T')[0],
                    customer: returnRecord.customer,
                    customerPhone: returnRecord.customerPhone || '',
                    customerEmail: returnRecord.customerEmail || '',
                    items: returnRecord.items.map(item => ({
                        name: item.name,
                        qty: item.qty,
                        price: parseFloat(item.price.toFixed(2))
                    })),
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    discount: 0,
                    discountType: 'percentage',
                    afterDiscount: parseFloat(subtotal.toFixed(2)),
                    exchangeCredit: 0,
                    afterExchange: parseFloat(subtotal.toFixed(2)),
                    taxRate: settings.taxRate,
                    tax: parseFloat(tax.toFixed(2)),
                    total: parseFloat(total.toFixed(2)),
                    payment: 'Credit Note',
                    status: 'completed',
                    returnId: returnRecord.id,
                    originalInvoiceId: returnRecord.invoiceId,
                    isCreditNote: true,
                    creditNoteDetails: {
                        returnId: returnRecord.id,
                        originalInvoiceId: returnRecord.invoiceId,
                        items: returnRecord.items,
                        reasons: returnRecord.items.map(item => item.reason || '').filter(r => r)
                    }
                };
                
                // Save credit note to invoices
                invoices.push(creditNote);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                // Print the credit note
                setTimeout(() => {
                    printCreditNote(creditNoteId);
                }, 500);
                
            } catch (error) {
                console.error('Error generating credit note:', error);
                alert('Error generating credit note. Please try again.');
            }
        }

        function printCreditNote(creditNoteId) {
            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const creditNote = invoices.find(inv => inv && inv.id === creditNoteId);
                if (!creditNote) {
                    console.warn('Credit note not found:', creditNoteId);
                    return;
                }
                const currencySymbol = getCurrencySymbol();
                const settings = store.getState().settings;
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    console.warn('Failed to open print window');
                    return;
                }
                window.currentPrintWindow = printWindow;
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Credit Note ${creditNote.id}</title>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
                            * { font-family: 'Poppins', sans-serif; }
                            body { padding: 60px; background: white; }
                            .credit-note-header { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 40px; border-radius: 12px 12px 0 0; margin-bottom: 40px; }
                            .credit-note-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
                            .credit-note-subtitle { font-size: 1rem; opacity: 0.9; }
                            .credit-note-details { margin-bottom: 40px; padding: 24px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; }
                            .credit-note-details div { margin: 8px 0; font-size: 15px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
                            th { background: #f3f4f6; padding: 16px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: #374151; }
                            td { padding: 16px; border-bottom: 1px solid #e5e7eb; font-size: 15px; color: #1f2937; }
                            .totals { text-align: right; padding: 24px; background: #f9fafb; border-radius: 8px; }
                            .totals div { margin: 8px 0; font-size: 15px; }
                            .grand-total { font-size: 1.5rem; font-weight: 700; margin-top: 16px; color: #dc2626; }
                            .thank-you { text-align: center; margin-top: 60px; color: #6b7280; font-size: 15px; }
                            .reason { font-size: 13px; color: #6b7280; font-style: italic; }
                        </style>
                    </head>
                    <body>
                        <div class="credit-note-header">
                            <div class="credit-note-title">${settings.businessName}</div>
                            <div class="credit-note-subtitle">CREDIT NOTE</div>
                        </div>
                        <div class="credit-note-details">
                            <div><strong>Credit Note ID:</strong> ${creditNote.id}</div>
                            <div><strong>Date:</strong> ${creditNote.date}</div>
                            <div><strong>Original Invoice:</strong> ${creditNote.originalInvoiceId || 'N/A'}</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.isArray(creditNote.items) && creditNote.items.length > 0 ? creditNote.items.map((item, index) => {
                                    const itemName = item && item.name ? item.name : 'Unknown';
                                    const itemQty = item && item.qty ? item.qty : 0;
                                    const itemPrice = item && item.price ? parseFloat(item.price) : 0;
                                    const itemTotal = itemQty * itemPrice;
                                    const reason = creditNote.creditNoteDetails && creditNote.creditNoteDetails.items && creditNote.creditNoteDetails.items[index] ? (creditNote.creditNoteDetails.items[index].reason || '') : '';
                                    return `
                                    <tr>
                                        <td>${itemName}</td>
                                        <td>${itemQty}</td>
                                        <td>${currencySymbol}${itemPrice.toFixed(2)}</td>
                                        <td>${currencySymbol}${itemTotal.toFixed(2)}</td>
                                        <td class="reason">${reason}</td>
                                    </tr>
                                    `;
                                }).join('') : '<tr><td colspan="5" style="text-align: center; padding: 20px;">No items</td></tr>'}
                            </tbody>
                        </table>
                        <div class="totals">
                            <div>Subtotal: ${currencySymbol}${(creditNote.subtotal || 0).toFixed(2)}</div>
                            <div>Tax (${settings.taxRate || 0}%): ${currencySymbol}${(creditNote.tax || 0).toFixed(2)}</div>
                            <div class="grand-total">Credit Amount: ${currencySymbol}${(creditNote.total || 0).toFixed(2)}</div>
                        </div>
                        <div class="thank-you">
                            This credit note can be used for future purchases.
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                const script = printWindow.document.createElement('script');
                script.textContent = 'window.addEventListener("afterprint", function() { setTimeout(function() { window.close(); }, 100); }); window.onfocus = function() { setTimeout(function() { if (document.hasFocus()) { window.close(); } }, 500); };';
                printWindow.document.body.appendChild(script);
                
                printWindow.focus();
                printWindow.print();
                
            } catch (error) {
                console.error('Error printing credit note:', error);
            }
        }

        function printReturn(returnId, callback) {
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const ret = returns.find(r => r.id === returnId);
            if (!ret) {
                if (callback) callback();
                return;
            }
            const currencySymbol = getCurrencySymbol();
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            window.currentPrintWindow = printWindow;
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${ret.type === 'exchange' ? 'Exchange' : 'Return'} ${ret.id}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
                        * { font-family: 'Poppins', sans-serif; }
                        body { padding: 60px; background: white; }
                        .return-header { background: linear-gradient(135deg, ${ret.type === 'exchange' ? '#f59e0b' : '#ef4444'} 0%, ${ret.type === 'exchange' ? '#d97706' : '#dc2626'} 100%); color: white; padding: 40px; border-radius: 12px 12px 0 0; margin-bottom: 40px; }
                        .return-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
                        .return-subtitle { font-size: 1rem; opacity: 0.9; }
                        .return-details { margin-bottom: 40px; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .return-details div { margin: 8px 0; font-size: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
                        th { background: #f3f4f6; padding: 16px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: #374151; }
                        td { padding: 16px; border-bottom: 1px solid #e5e7eb; font-size: 15px; color: #1f2937; }
                        .totals { text-align: right; padding: 24px; background: #f9fafb; border-radius: 8px; }
                        .totals div { margin: 8px 0; font-size: 15px; }
                        .grand-total { font-size: 1.5rem; font-weight: 700; margin-top: 16px; color: #1f2937; }
                        .thank-you { text-align: center; margin-top: 60px; color: #6b7280; font-size: 15px; }
                        .reason { font-size: 13px; color: #6b7280; font-style: italic; }
                    </style>
                </head>
                <body>
                    <div class="return-header">
                        <div class="return-title">${store.getState().settings.businessName}</div>
                        <div class="return-subtitle">${ret.type === 'exchange' ? 'EXCHANGE' : 'RETURN'} RECEIPT</div>
                    </div>
                    <div class="return-details">
                        <div><strong>${ret.type === 'exchange' ? 'Exchange' : 'Return'} ID:</strong> ${ret.id}</div>
                        <div><strong>Original Invoice:</strong> ${ret.invoiceId}</div>
                        <div><strong>Date:</strong> ${ret.date}</div>
                        <div><strong>Customer:</strong> ${ret.customer}</div>
                        ${ret.customerPhone ? `<div><strong>Phone:</strong> ${ret.customerPhone}</div>` : ''}
                        ${ret.customerEmail ? `<div><strong>Email:</strong> ${ret.customerEmail}</div>` : ''}
                        <div><strong>Status:</strong> ${ret.status}</div>
                        ${ret.payment ? `<div><strong>Payment:</strong> ${ret.payment}</div>` : ''}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ret.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.qty}</td>
                                    <td>${currencySymbol}${item.price.toFixed(2)}</td>
                                    <td>${currencySymbol}${(item.qty * item.price).toFixed(2)}</td>
                                    <td class="reason">${item.reason || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="totals">
                        <div class="grand-total">${ret.type === 'exchange' ? 'Exchange Credit' : 'Refund Amount'}: ${currencySymbol}${ret.total.toFixed(2)}</div>
                    </div>
                    <div class="thank-you">
                        ${ret.type === 'exchange' ? 'Exchange credit applied to new purchase.' : 'Thank you for your return.'}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Add script to auto-close after print
            const script = printWindow.document.createElement('script');
            script.textContent = `
                window.addEventListener("afterprint", function() { 
                    setTimeout(function() { window.close(); }, 100); 
                }); 
                window.onfocus = function() { 
                    setTimeout(function() { 
                        if (document.hasFocus()) { window.close(); } 
                    }, 500); 
                };
            `;
            printWindow.document.body.appendChild(script);
            
            // Trigger print
            printWindow.focus();
            printWindow.print();
            
            // Monitor when print window closes
            const checkPrintClosed = setInterval(() => {
                try {
                    if (printWindow.closed) {
                        clearInterval(checkPrintClosed);
                        if (callback) {
                            setTimeout(callback, 100);
                        }
                    }
                } catch (e) {
                    clearInterval(checkPrintClosed);
                    if (callback) callback();
                }
            }, 100);
            
            // Fallback: Close print window after 5 seconds if still open
            setTimeout(() => {
                clearInterval(checkPrintClosed);
                try {
                    if (!printWindow.closed) {
                        printWindow.close();
                    }
                } catch (e) {}
                if (callback) callback();
            }, 5000);
        }

        function scanBarcode() {
            // Focus on the search input to allow barcode scanner input
            const searchInput = document.getElementById('productSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                // Show a message to guide user
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                // Listen for Enter key (barcode scanners typically send Enter after scanning)
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        // Search for product by barcode
                        const barcode = searchInput.value.trim();
                        const products = JSON.parse(localStorage.getItem('products') || '[]');
                        const product = products.find(p => p.barcode === barcode || p.sku === barcode);
                        
                        if (product) {
                            // Add product to cart
                            addToCart(product.id);
                            searchInput.value = '';
                            searchInput.placeholder = originalPlaceholder;
                            searchInput.removeEventListener('keypress', handleKeyPress);
                        } else {
                            alert('Product not found with this barcode/SKU');
                            searchInput.value = '';
                            searchInput.placeholder = originalPlaceholder;
                            searchInput.removeEventListener('keypress', handleKeyPress);
                        }
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                // Also handle blur to reset placeholder
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function scanBarcodeForProducts() {
            // Focus on the search input to allow barcode scanner input
            const searchInput = document.getElementById('searchProducts');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                // Show a message to guide user
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                // Listen for Enter key (barcode scanners typically send Enter after scanning)
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        // Filter products by barcode
                        const barcode = searchInput.value.trim();
                        filterProductsList(barcode);
                        searchInput.placeholder = originalPlaceholder;
                        searchInput.removeEventListener('keypress', handleKeyPress);
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                // Also handle blur to reset placeholder
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function filterProducts(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const grid = document.getElementById('productsGrid');
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.barcode.includes(searchTerm) ||
                p.sku.toLowerCase().includes(searchTerm.toLowerCase())
            );
            grid.innerHTML = filtered.map(p => `
                <div class="bg-white p-4 rounded-lg shadow-sm card-hover cursor-pointer border border-gray-200" onclick="addToCart(${p.id})">
                    <div class="text-4xl mb-2 text-center">${p.image}</div>
                    <div class="font-semibold text-gray-800 text-sm">${p.name}</div>
                    <div class="text-gray-600 text-xs">${p.category}</div>
                    <div class="font-bold text-indigo-600 mt-2">${formatCurrency(p.price)}</div>
                    <div class="text-xs text-gray-600 mt-1">Stock: ${p.stock}</div>
                </div>
            `).join('');
        }

        function filterProductsList(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const table = document.getElementById('productsTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchLower) ||
                p.sku.toLowerCase().includes(searchLower) ||
                p.category.toLowerCase().includes(searchLower) ||
                p.barcode.includes(searchTerm)
            );
            
            tbody.innerHTML = filtered.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${p.image}</span>
                            <span class="font-semibold text-gray-800">${p.name}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${p.sku}</td>
                    <td class="px-4 py-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${p.category}</span></td>
                    <td class="px-4 py-3 font-semibold text-gray-800">${formatCurrency(p.price)}</td>
                    <td class="px-4 py-3">
                        <span class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-800'}">${p.stock}</span>
                        ${p.stock < 10 ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>' : ''}
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-sm">${p.barcode}</td>
                </tr>
            `).join('');
        }

        function filterStockData(searchTerm) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const table = document.getElementById('stockDataTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(searchLower) ||
                p.sku.toLowerCase().includes(searchLower) ||
                p.category.toLowerCase().includes(searchLower) ||
                p.barcode.includes(searchTerm)
            );
            
            tbody.innerHTML = filtered.map(product => {
                const stockValue = product.stock * product.price;
                const stockStatus = product.stock === 0 ? 'out' : product.stock < 10 ? 'low' : 'good';
                return `
                <tr class="hover:bg-gray-50">
                    <td class="table-cell">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${product.image}</span>
                            <span class="font-semibold text-gray-800">${product.name}</span>
                        </div>
                    </td>
                    <td class="table-cell text-gray-600">${product.sku}</td>
                    <td class="table-cell">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${product.category}</span>
                    </td>
                    <td class="table-cell">
                        <span class="font-bold ${stockStatus === 'out' ? 'text-red-600' : stockStatus === 'low' ? 'text-orange-600' : 'text-green-600'}">${product.stock}</span>
                    </td>
                    <td class="table-cell font-semibold text-gray-800">${formatCurrency(product.price)}</td>
                    <td class="table-cell font-bold text-gray-800">${formatCurrency(stockValue)}</td>
                    <td class="table-cell text-gray-600 text-sm">${product.barcode}</td>
                    <td class="table-cell">
                        ${stockStatus === 'out' ? '<span class="badge badge-danger">Out of Stock</span>' : 
                          stockStatus === 'low' ? '<span class="badge badge-warning">Low Stock</span>' : 
                          '<span class="badge badge-success">In Stock</span>'}
                    </td>
                </tr>
                `;
            }).join('');
        }

        function scanBarcodeForStock() {
            const searchInput = document.getElementById('stockSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                
                const originalPlaceholder = searchInput.placeholder;
                searchInput.placeholder = 'Scan barcode now...';
                
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        const barcode = searchInput.value.trim();
                        filterStockData(barcode);
                        searchInput.placeholder = originalPlaceholder;
                        searchInput.removeEventListener('keypress', handleKeyPress);
                    }
                };
                
                searchInput.addEventListener('keypress', handleKeyPress);
                
                const handleBlur = () => {
                    searchInput.placeholder = originalPlaceholder;
                    searchInput.removeEventListener('keypress', handleKeyPress);
                    searchInput.removeEventListener('blur', handleBlur);
                };
                searchInput.addEventListener('blur', handleBlur);
            }
        }

        function filterCustomersList(searchTerm) {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const container = document.getElementById('customersList');
            if (!container) return;
            
            const selectedCustomerId = store.getState().selectedCustomerForView || null;
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            const searchLower = searchTerm.toLowerCase().trim();
            let filtered = customers.filter(c =>
                c.name.toLowerCase().includes(searchLower) ||
                c.email.toLowerCase().includes(searchLower) ||
                c.phone.includes(searchTerm)
            );
            
            // Calculate orders, avg order value, last purchase date for filtered customers
            let customersWithStats = filtered.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            container.innerHTML = customersWithStats.map(c => {
                const status = getCustomerStatus(c.totalPurchases);
                const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase();
                return `
                <tr class="hover:bg-gray-50 transition cursor-pointer ${selectedCustomerId === c.id ? 'bg-indigo-50' : ''}" onclick="selectCustomerForView(${c.id})">
                    <td class="px-4 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-sm">
                                ${initials}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">${c.name}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm text-gray-600">${c.email}</div>
                        <div class="text-sm text-gray-600">${c.phone}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${c.ordersCount}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.totalPurchases)}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-800">${formatCurrency(c.avgOrderValue)}</div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-3 py-1 ${status.color} rounded-full text-xs font-semibold">
                            ${status.label}
                        </span>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function selectCustomerForView(customerId) {
            store.setState({ selectedCustomerForView: customerId });
            render();
        }

        function clearCustomerSelection() {
            store.setState({ selectedCustomerForView: null });
            render();
        }

        function setCustomerFilter(filterName, value) {
            const currentFilters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            currentFilters[filterName] = value;
            store.setState({ customerFilters: currentFilters });
            localStorage.setItem('customerFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearCustomerFilters() {
            const defaultFilters = {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            store.setState({ customerFilters: defaultFilters });
            localStorage.setItem('customerFilters', JSON.stringify(defaultFilters));
            render();
        }

        function setCustomerSort(field, value) {
            const currentSort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            currentSort[field] = value;
            store.setState({ customerSort: currentSort });
            localStorage.setItem('customerSort', JSON.stringify(currentSort));
            render();
        }

        function applyCustomerFilters() {
            // Trigger re-render to apply filters
            render();
        }

        function exportCustomersToCSV() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const filters = store.getState().customerFilters || {
                status: '',
                dateFrom: '',
                dateTo: '',
                purchaseAmountMin: '',
                purchaseAmountMax: ''
            };
            const sort = store.getState().customerSort || {
                field: 'totalSpent',
                order: 'desc'
            };
            
            // Calculate stats and apply filters (same logic as CustomersPage)
            let customersWithStats = customers.map(c => {
                const customerInvs = invoices.filter(inv => 
                    inv.customer === c.name || inv.customerPhone === c.phone
                );
                const ordersCount = customerInvs.length;
                const avgOrderValue = ordersCount > 0 ? c.totalPurchases / ordersCount : 0;
                const sortedInvs = [...customerInvs].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastPurchaseDate = sortedInvs.length > 0 ? sortedInvs[0].date : c.lastPurchase;
                const status = getCustomerStatus(c.totalPurchases);
                return { 
                    ...c, 
                    ordersCount, 
                    avgOrderValue, 
                    lastPurchaseDate,
                    statusLabel: status.label,
                    tags: c.tags || []
                };
            });
            
            // Apply filters
            if (filters.status) {
                customersWithStats = customersWithStats.filter(c => c.statusLabel === filters.status);
            }
            if (filters.dateFrom || filters.dateTo) {
                customersWithStats = customersWithStats.filter(c => {
                    if (!c.lastPurchaseDate) return false;
                    const purchaseDate = new Date(c.lastPurchaseDate);
                    if (filters.dateFrom && purchaseDate < new Date(filters.dateFrom)) return false;
                    if (filters.dateTo && purchaseDate > new Date(filters.dateTo)) return false;
                    return true;
                });
            }
            if (filters.purchaseAmountMin || filters.purchaseAmountMax) {
                customersWithStats = customersWithStats.filter(c => {
                    if (filters.purchaseAmountMin && c.totalPurchases < parseFloat(filters.purchaseAmountMin)) return false;
                    if (filters.purchaseAmountMax && c.totalPurchases > parseFloat(filters.purchaseAmountMax)) return false;
                    return true;
                });
            }
            // Apply sorting
            customersWithStats.sort((a, b) => {
                let aVal, bVal;
                switch(sort.field) {
                    case 'totalSpent':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    case 'lastPurchase':
                        aVal = a.lastPurchaseDate ? new Date(a.lastPurchaseDate).getTime() : 0;
                        bVal = b.lastPurchaseDate ? new Date(b.lastPurchaseDate).getTime() : 0;
                        break;
                    case 'invoiceCount':
                        aVal = a.ordersCount;
                        bVal = b.ordersCount;
                        break;
                    case 'ltv':
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                        break;
                    default:
                        aVal = a.totalPurchases;
                        bVal = b.totalPurchases;
                }
                return sort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            // Create CSV content
            let csv = 'Customer Name,Email,Phone,Invoices,Total Spent,Avg Order Value,Last Purchase,Status,Tags\n';
            customersWithStats.forEach(c => {
                const tags = (c.tags || []).join('; ');
                csv += `"${c.name}","${c.email}","${c.phone}",${c.ordersCount},${c.totalPurchases.toFixed(2)},${c.avgOrderValue.toFixed(2)},${c.lastPurchaseDate || 'N/A'},"${c.statusLabel}","${tags}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`Exported ${customersWithStats.length} customers to CSV!`);
        }

        function getCustomerStatus(totalPurchases) {
            if (totalPurchases >= 5000) {
                return { label: 'VIP Customer', color: 'bg-green-100 text-green-800', icon: 'fa-crown' };
            } else if (totalPurchases >= 1000) {
                return { label: 'Regular Customer', color: 'bg-blue-100 text-blue-800', icon: 'fa-user' };
            } else {
                return { label: 'New Customer', color: 'bg-yellow-100 text-yellow-800', icon: 'fa-user-plus' };
            }
        }

        function showProductModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Product</h2>
                    <form onsubmit="event.preventDefault(); addProduct(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Product Name</label>
                                <input type="text" name="name" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">SKU</label>
                                <input type="text" name="sku" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Category</label>
                                <input type="text" name="category" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Price</label>
                                <input type="number" step="0.01" name="price" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Stock</label>
                                <input type="number" name="stock" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Barcode</label>
                                <input type="text" name="barcode" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Emoji Icon</label>
                                <input type="text" name="image" value="ðŸ“¦" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Add Product</button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addProduct(form) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const newProduct = {
                id: Math.max(0, ...products.map(p => p.id)) + 1,
                name: form.name.value,
                sku: form.sku.value,
                category: form.category.value,
                price: parseFloat(form.price.value),
                stock: parseInt(form.stock.value),
                barcode: form.barcode.value,
                image: form.image.value
            };
            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));
            store.navigate('products');
        }

        function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const filtered = products.filter(p => p.id !== id);
            localStorage.setItem('products', JSON.stringify(filtered));
            store.navigate('products');
        }

        function showCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Customer</h2>
                    <form onsubmit="event.preventDefault(); addCustomer(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <input type="text" name="name" placeholder="Full Name" required class="w-full px-4 py-2 border rounded-lg">
                            <input type="email" name="email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg">
                            <input type="tel" name="phone" placeholder="Phone" required class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Add</button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 py-2 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addCustomer(form) {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            customers.push({
                id: Math.max(0, ...customers.map(c => c.id)) + 1,
                name: form.name.value,
                email: form.email.value,
                phone: form.phone.value,
                totalPurchases: 0,
                lastPurchase: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('customers', JSON.stringify(customers));
            store.navigate('customers');
        }

        function saveSettings() {
            const currentSettings = store.getState().settings;
            const settings = {
                businessName: document.getElementById('businessName').value,
                taxRate: parseFloat(document.getElementById('taxRate').value),
                currency: 'INR',
                taxRates: currentSettings.taxRates || [],
                defaultTaxType: currentSettings.defaultTaxType || 'gst'
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            store.setState({ settings });
            alert('Settings saved successfully!');
        }

        function showAddTaxRateModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Add Tax Rate</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); addTaxRate(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Tax Name</label>
                                <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="e.g., GST, VAT, Service Tax">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Tax Rate (%)</label>
                                <input type="number" name="rate" step="0.01" min="0" max="100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="e.g., 18, 10, 5">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Tax Type</label>
                                <select name="type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                    <option value="gst">GST</option>
                                    <option value="vat">VAT</option>
                                    <option value="service">Service Tax</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1" style="background: var(--gray-200); color: var(--gray-700); padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 btn-primary" style="padding: 12px; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-plus mr-2"></i>Add Tax Rate
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addTaxRate(form) {
            const settings = store.getState().settings;
            const taxRates = settings.taxRates || [];
            
            const newTax = {
                name: form.name.value,
                rate: parseFloat(form.rate.value),
                type: form.type.value
            };
            
            taxRates.push(newTax);
            
            const updatedSettings = {
                ...settings,
                taxRates,
                defaultTaxType: settings.defaultTaxType || newTax.type
            };
            
            localStorage.setItem('settings', JSON.stringify(updatedSettings));
            store.setState({ settings: updatedSettings });
            store.navigate('settings');
        }

        function setDefaultTaxType(type) {
            const settings = store.getState().settings;
            const updatedSettings = {
                ...settings,
                defaultTaxType: type
            };
            localStorage.setItem('settings', JSON.stringify(updatedSettings));
            store.setState({ settings: updatedSettings });
            store.navigate('settings');
        }

        function deleteTaxRate(index) {
            if (!confirm('Delete this tax rate?')) return;
            const settings = store.getState().settings;
            const taxRates = settings.taxRates || [];
            taxRates.splice(index, 1);
            
            const updatedSettings = {
                ...settings,
                taxRates
            };
            
            localStorage.setItem('settings', JSON.stringify(updatedSettings));
            store.setState({ settings: updatedSettings });
            store.navigate('settings');
        }

        function exportData() {
            const data = {
                products: localStorage.getItem('products'),
                customers: localStorage.getItem('customers'),
                invoices: localStorage.getItem('invoices'),
                settings: localStorage.getItem('settings')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quickbill-data.json';
            a.click();
        }

        function resetData() {
            localStorage.clear();
            store.initData();
            store.navigate('dashboard');
        }

        function showNewCampaignModal() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Calculate customer segments
            const allCustomers = customers.map(c => {
                const customerInvoices = invoices.filter(inv => inv.customer === c.name || inv.customerPhone === c.phone);
                const totalSpent = customerInvoices.reduce((sum, inv) => sum + inv.total, 0);
                return { ...c, totalSpent, orderCount: customerInvoices.length };
            });
            
            const vipCustomers = allCustomers.filter(c => c.totalSpent >= 5000).length;
            const regularCustomers = allCustomers.filter(c => c.totalSpent >= 1000 && c.totalSpent < 5000).length;
            const newCustomers = allCustomers.filter(c => c.totalSpent < 1000).length;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Create New Campaign</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); createCampaign(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Campaign Type</label>
                                <select name="type" id="campaignType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" onchange="toggleCampaignFields()">
                                    <option value="email">Email Campaign</option>
                                    <option value="sms">SMS Campaign</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Subject / Title</label>
                                <input type="text" name="subject" id="campaignSubject" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Enter campaign subject">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Message</label>
                                <textarea name="message" id="campaignMessage" rows="5" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600" placeholder="Enter your message here..."></textarea>
                                <p class="text-xs text-gray-500 mt-1" id="smsCharCount">0/160 characters (SMS limit)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Target Segment</label>
                                <select name="segment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                                    <option value="all">All Customers (${customers.length})</option>
                                    <option value="vip">VIP Customers (${vipCustomers})</option>
                                    <option value="regular">Regular Customers (${regularCustomers})</option>
                                    <option value="new">New Customers (${newCustomers})</option>
                                </select>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <strong>Note:</strong> In a production environment, this would integrate with email/SMS services like SendGrid, Twilio, or AWS SES. 
                                    For now, campaigns are saved locally and can be exported for external sending.
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="flex-1" style="background: var(--gray-200); color: var(--gray-700); padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 btn-primary" style="padding: 12px; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-paper-plane mr-2"></i>Send Campaign
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Update SMS character count
            const messageField = modal.querySelector('#campaignMessage');
            const charCount = modal.querySelector('#smsCharCount');
            const typeField = modal.querySelector('#campaignType');
            
            messageField.addEventListener('input', function() {
                if (typeField.value === 'sms') {
                    charCount.textContent = `${this.value.length}/160 characters (SMS limit)`;
                    if (this.value.length > 160) {
                        charCount.classList.add('text-red-600');
                    } else {
                        charCount.classList.remove('text-red-600');
                    }
                }
            });
        }

        function toggleCampaignFields() {
            const type = document.getElementById('campaignType').value;
            const charCount = document.getElementById('smsCharCount');
            if (type === 'sms') {
                charCount.classList.remove('hidden');
            } else {
                charCount.classList.add('hidden');
            }
        }

        function createCampaign(form) {
            const type = form.type.value;
            const subject = form.subject.value;
            const message = form.message.value;
            const segment = form.segment.value;
            
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Filter recipients based on segment
            let recipients = [];
            if (segment === 'all') {
                recipients = customers;
            } else {
                recipients = customers.filter(c => {
                    const customerInvoices = invoices.filter(inv => inv.customer === c.name || inv.customerPhone === c.phone);
                    const totalSpent = customerInvoices.reduce((sum, inv) => sum + inv.total, 0);
                    if (segment === 'vip') return totalSpent >= 5000;
                    if (segment === 'regular') return totalSpent >= 1000 && totalSpent < 5000;
                    if (segment === 'new') return totalSpent < 1000;
                    return true;
                });
            }
            
            const campaign = {
                id: Date.now(),
                type,
                subject,
                message,
                segment,
                recipients: recipients.map(c => ({ name: c.name, email: c.email, phone: c.phone })),
                date: new Date().toISOString().split('T')[0],
                status: 'sent'
            };
            
            const campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
            campaigns.unshift(campaign);
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            
            alert(`Campaign created successfully! ${recipients.length} ${type === 'email' ? 'emails' : 'SMS messages'} would be sent.`);
            store.navigate('campaigns');
        }

        function viewCampaign(index) {
            const campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
            const campaign = campaigns[index];
            if (!campaign) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Campaign Details</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Type</label>
                            <p class="text-lg">${campaign.type === 'email' ? 'Email' : 'SMS'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Subject</label>
                            <p class="text-lg">${campaign.subject}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Message</label>
                            <p class="text-gray-800 bg-gray-50 p-4 rounded-lg">${campaign.message}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Recipients</label>
                            <p class="text-lg">${campaign.recipients?.length || 0} customers</p>
                            <div class="mt-2 max-h-40 overflow-y-auto">
                                ${campaign.recipients?.map(r => `
                                    <div class="text-sm text-gray-600 py-1">${r.name} ${r.email ? `(${r.email})` : ''} ${r.phone ? `- ${r.phone}` : ''}</div>
                                `).join('') || ''}
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Date</label>
                            <p class="text-lg">${campaign.date}</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deleteCampaign(index) {
            if (!confirm('Delete this campaign?')) return;
            const campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
            campaigns.splice(index, 1);
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            store.navigate('campaigns');
        }

        function showPurchaseOrderModal() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">New Purchase Order</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); createPurchaseOrder(this); this.closest('.modal-backdrop').remove();">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Supplier Name</label>
                                <input type="text" name="supplier" required class="input-field" placeholder="Enter supplier name">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Date</label>
                                <input type="date" name="date" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Items</label>
                                <div id="poItems" class="space-y-3 mb-3">
                                    <div class="flex gap-2 items-end">
                                        <div class="flex-1">
                                            <select name="product" class="input-field" required>
                                                <option value="">Select Product</option>
                                                ${products.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div style="width: 120px;">
                                            <input type="number" name="qty" placeholder="Qty" required class="input-field" min="1">
                                        </div>
                                        <div style="width: 120px;">
                                            <input type="number" name="cost" placeholder="Cost" required class="input-field" step="0.01" min="0">
                                        </div>
                                        <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" onclick="addPOItem()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                    <i class="fas fa-plus mr-2"></i>Add Item
                                </button>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Upload Document</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition cursor-pointer" onclick="document.getElementById('poFileUpload').click()">
                                    <input type="file" id="poFileUpload" name="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 text-sm mb-1">Click to upload or drag and drop</p>
                                    <p class="text-gray-400 text-xs">PDF, JPG, PNG, DOC, DOCX (Max 10MB)</p>
                                    <div id="poFileName" class="mt-2 text-sm text-indigo-600 font-semibold hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-save mr-2"></i>Create Purchase Order
                            </button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle file upload display
            const fileInput = document.getElementById('poFileUpload');
            const fileNameDisplay = document.getElementById('poFileName');
            if (fileInput && fileNameDisplay) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        fileNameDisplay.textContent = file.name;
                        fileNameDisplay.classList.remove('hidden');
                    } else {
                        fileNameDisplay.classList.add('hidden');
                    }
                });
            }
        }

        function addPOItem() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const container = document.getElementById('poItems');
            const newItem = document.createElement('div');
            newItem.className = 'flex gap-2 items-end';
            newItem.innerHTML = `
                <div class="flex-1">
                    <select name="product" class="input-field" required>
                        <option value="">Select Product</option>
                        ${products.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('')}
                    </select>
                </div>
                <div style="width: 120px;">
                    <input type="number" name="qty" placeholder="Qty" required class="input-field" min="1">
                </div>
                <div style="width: 120px;">
                    <input type="number" name="cost" placeholder="Cost" required class="input-field" step="0.01" min="0">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background: var(--danger); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newItem);
        }

        function createPurchaseOrder(form) {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const items = [];
            let total = 0;
            
            const itemRows = form.querySelectorAll('#poItems > div');
            itemRows.forEach(row => {
                const productId = parseInt(row.querySelector('[name="product"]').value);
                const qty = parseInt(row.querySelector('[name="qty"]').value);
                const cost = parseFloat(row.querySelector('[name="cost"]').value);
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    items.push({ name: product.name, qty, cost });
                    total += cost * qty;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const newPO = {
                id: `PO-${String(purchaseOrders.length + 1).padStart(3, '0')}`,
                date: form.date.value,
                supplier: form.supplier.value,
                items,
                total,
                status: 'pending'
            };
            
            purchaseOrders.push(newPO);
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            alert(`Purchase Order ${newPO.id} created successfully!`);
            store.navigate('inventory');
        }

        function completePurchaseOrder(poId) {
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const po = purchaseOrders.find(p => p.id === poId);
            
            if (!po) return;
            
            po.items.forEach(poItem => {
                const product = products.find(p => p.name === poItem.name);
                if (product) {
                    product.stock += poItem.qty;
                }
            });
            
            po.status = 'completed';
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            localStorage.setItem('products', JSON.stringify(products));
            alert(`Purchase Order ${poId} completed! Inventory updated.`);
            store.navigate('inventory');
        }

        function deletePurchaseOrder(poId) {
            if (!confirm('Delete this purchase order?')) return;
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const filtered = purchaseOrders.filter(p => p.id !== poId);
            localStorage.setItem('purchaseOrders', JSON.stringify(filtered));
            alert('Purchase order deleted!');
            store.navigate('inventory');
        }

        function showReturnExchangeModal() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const currentPage = store.getState().currentPage;
            const isFromPOS = currentPage === 'pos';
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">Return / Exchange</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="event.preventDefault(); const modal = this.closest('.modal-backdrop'); processReturnExchange(this, ${isFromPOS}, modal);">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Search Invoice</label>
                                <div class="relative">
                                    <input type="text" id="returnInvoiceSearch" placeholder="Search by invoice number or mobile number..." class="input-field w-full" style="padding-right: 40px;" oninput="filterInvoicesForReturn(this.value)">
                                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Select Invoice</label>
                                <select id="returnInvoice" name="invoiceId" class="input-field" required onchange="const form = this.closest('form'); loadInvoiceItems(this.value, form); calculateExchangeCredit();">
                                    <option value="">Select Invoice</option>
                                    ${invoices.map(inv => `<option value="${inv.id}" data-invoice-id="${inv.id}" data-customer="${inv.customer}" data-phone="${inv.customerPhone || ''}" data-date="${inv.date}">${inv.id} - ${inv.customer}${inv.customerPhone ? ' (' + inv.customerPhone + ')' : ''} (${inv.date})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Type</label>
                                <select name="type" class="input-field" required onchange="const form = this.closest('form'); const invoiceId = document.getElementById('returnInvoice').value; if (invoiceId) loadInvoiceItems(invoiceId, form); calculateExchangeCredit();">
                                    <option value="return">Return</option>
                                    <option value="exchange">Exchange</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Items to Return/Exchange</label>
                                <div id="returnItems" class="space-y-3">
                                    <p class="text-muted text-center py-4">Select an invoice first</p>
                                </div>
                            </div>
                            ${isFromPOS ? `
                                <div id="exchangeCreditDisplay" class="hidden p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold text-gray-800" id="creditLabel">Return/Exchange Credit Amount</div>
                                            <div class="text-sm text-gray-600" id="creditMessage">This amount will be deducted from current order</div>
                                        </div>
                                        <div class="text-2xl font-bold text-blue-600" id="exchangeCreditAmount">â‚¹0.00</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="submit" class="btn" style="background: var(--danger); color: white; flex: 1;">
                                <i class="fas fa-undo mr-2"></i>Process Return/Exchange
                            </button>
                            <button type="button" onclick="this.closest('.modal-backdrop').remove()" class="btn" style="background: var(--gray-200); color: var(--gray-800);">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store all invoices for filtering
            window.returnModalInvoices = invoices;
            
            // Add event listener as fallback for the search input
            setTimeout(() => {
                const searchInput = document.getElementById('returnInvoiceSearch');
                if (searchInput) {
                    // Ensure the function is accessible
                    if (typeof filterInvoicesForReturn === 'function') {
                        // Remove any existing listeners and add fresh one
                        searchInput.oninput = function() {
                            filterInvoicesForReturn(this.value);
                        };
                        searchInput.onkeyup = function(e) {
                            filterInvoicesForReturn(this.value);
                        };
                        searchInput.onpaste = function(e) {
                            setTimeout(() => filterInvoicesForReturn(this.value), 10);
                        };
                    }
                }
            }, 100);
        }
        
        function filterInvoicesForReturn(searchTerm) {
            try {
                const select = document.getElementById('returnInvoice');
                if (!select) {
                    return;
                }
                
                const search = (searchTerm || '').trim();
                const searchLower = search.toLowerCase();
                const currentValue = select.value;
                
                // Get all invoices from stored data
                let invoices = window.returnModalInvoices || [];
                
                // Fallback: extract from existing options if stored data is not available
                if (invoices.length === 0) {
                    const options = Array.from(select.querySelectorAll('option')).filter(opt => opt.value !== '');
                    invoices = options.map(opt => ({
                        id: opt.getAttribute('data-invoice-id') || opt.value,
                        customer: opt.getAttribute('data-customer') || '',
                        customerPhone: opt.getAttribute('data-phone') || '',
                        date: opt.getAttribute('data-date') || ''
                    }));
                }
                
                if (invoices.length === 0) {
                    return;
                }
                
                // Normalize phone number for comparison (remove spaces, dashes, etc.)
                const normalizePhone = (phone) => {
                    if (!phone) return '';
                    return phone.toString().replace(/[\s\-\(\)\.]/g, '');
                };
                
                const normalizedSearch = normalizePhone(search);
                
                // Filter invoices based on search
                let filteredInvoices = invoices;
                if (search) {
                    filteredInvoices = invoices.filter(inv => {
                        const invoiceId = String(inv.id || '').toLowerCase();
                        const customer = String(inv.customer || '').toLowerCase();
                        const phone = String(inv.customerPhone || '');
                        const date = String(inv.date || '');
                        
                        // Check if search matches invoice ID, customer name, or phone
                        const matchesId = invoiceId.includes(searchLower);
                        const matchesCustomer = customer.includes(searchLower);
                        const matchesPhone = phone.includes(search) || (normalizedSearch && normalizePhone(phone).includes(normalizedSearch));
                        const matchesDate = date.includes(search);
                        
                        return matchesId || matchesCustomer || matchesPhone || matchesDate;
                    });
                }
                
                // Store current selection state
                const wasSelected = currentValue && filteredInvoices.some(inv => String(inv.id) === String(currentValue));
                
                // Save the placeholder text
                const placeholderText = select.querySelector('option[value=""]')?.textContent || 'Select Invoice';
                
                // Clear and rebuild options
                select.innerHTML = '';
                
                // Add placeholder option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = placeholderText;
                select.appendChild(defaultOption);
                
                // Add filtered options
                if (filteredInvoices.length === 0 && search) {
                    // Show "No results" message
                    const noResultsOption = document.createElement('option');
                    noResultsOption.value = '';
                    noResultsOption.textContent = 'No invoices found';
                    noResultsOption.disabled = true;
                    select.appendChild(noResultsOption);
                } else {
                    filteredInvoices.forEach(inv => {
                        const option = document.createElement('option');
                        option.value = String(inv.id);
                        option.setAttribute('data-invoice-id', String(inv.id));
                        option.setAttribute('data-customer', String(inv.customer || ''));
                        option.setAttribute('data-phone', String(inv.customerPhone || ''));
                        option.setAttribute('data-date', String(inv.date || ''));
                        
                        const displayText = `${inv.id} - ${inv.customer || 'N/A'}${inv.customerPhone ? ' (' + inv.customerPhone + ')' : ''} (${inv.date || ''})`;
                        option.textContent = displayText;
                        select.appendChild(option);
                    });
                }
                
                // Restore selection if it's still in filtered results
                if (wasSelected && currentValue) {
                    select.value = currentValue;
                    // Don't trigger loadInvoiceItems automatically to avoid unnecessary reloads
                    if (typeof calculateExchangeCredit === 'function') {
                        calculateExchangeCredit();
                    }
                } else if (currentValue) {
                    // Clear selection if it's no longer in filtered results
                    select.value = '';
                    const container = document.getElementById('returnItems');
                    if (container) {
                        container.innerHTML = '<p class="text-muted text-center py-4">Select an invoice first</p>';
                    }
                    const creditDisplay = document.getElementById('exchangeCreditDisplay');
                    if (creditDisplay) creditDisplay.classList.add('hidden');
                    if (typeof calculateExchangeCredit === 'function') {
                        calculateExchangeCredit();
                    }
                }
            } catch (error) {
                // Silently handle errors
            }
        }

        function loadInvoiceItems(invoiceId, form) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const container = document.getElementById('returnItems');
            const currentPage = store.getState().currentPage;
            const isFromPOS = currentPage === 'pos';
            
            if (!invoice) {
                container.innerHTML = '<p class="text-muted text-center py-4">Invoice not found</p>';
                if (isFromPOS) {
                    const creditDisplay = document.getElementById('exchangeCreditDisplay');
                    if (creditDisplay) creditDisplay.classList.add('hidden');
                }
                return;
            }
            
            const type = form ? form.type.value : 'return';
            const isExchange = type === 'exchange';
            const typeLabel = isExchange ? 'Exchange' : 'Return';
            const typeLabelLower = isExchange ? 'exchange' : 'return';
            
            container.innerHTML = invoice.items.map((item, index) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div style="font-weight: 600; font-size: 16px;">${item.name}</div>
                            <div class="text-small">Qty: ${item.qty} | Price: ${formatCurrency(item.price)}</div>
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="returnItem" value="${index}" class="mr-2" onchange="calculateExchangeCredit()" style="width: 24px; height: 24px; cursor: pointer; accent-color: var(--primary); transform: scale(1.2);">
                            <span class="text-sm font-semibold ml-1">Select for ${typeLabel}</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">${typeLabel} Quantity</label>
                        <input type="number" name="returnQty_${index}" placeholder="Qty to ${typeLabelLower}" class="input-field" min="1" max="${item.qty}" value="${item.qty}" onchange="calculateExchangeCredit()" oninput="calculateExchangeCredit()">
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Reason</label>
                        <select name="reason_${index}" class="input-field">
                            <option value="Defective">Defective</option>
                            <option value="Wrong Item">Wrong Item</option>
                            <option value="Customer Request">Customer Request</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            `).join('');
            
            // Calculate and show credit if from POS (for both return and exchange)
            if (isFromPOS) {
                calculateExchangeCredit();
            }
        }
        
        function calculateExchangeCredit() {
            const currentPage = store.getState().currentPage;
            const isFromPOS = currentPage === 'pos';
            if (!isFromPOS) return;
            
            const form = document.querySelector('.modal-backdrop form');
            if (!form) return;
            
            const type = form.type.value;
            const creditDisplay = document.getElementById('exchangeCreditDisplay');
            const creditLabel = document.getElementById('creditLabel');
            const creditMessage = document.getElementById('creditMessage');
            
            // Update label based on type
            if (creditLabel) {
                creditLabel.textContent = type === 'exchange' ? 'Exchange Credit Amount' : 'Return Credit Amount';
            }
            
            // Update message based on type
            if (creditMessage) {
                if (type === 'return') {
                    creditMessage.textContent = 'Credit note will be generated for this amount';
                } else {
                    creditMessage.textContent = 'This amount will be deducted from current order';
                }
            }
            
            // Show credit for both return and exchange when from POS
            if (!creditDisplay) return;
            
            const invoiceId = form.invoiceId.value;
            if (!invoiceId) {
                creditDisplay.classList.add('hidden');
                return;
            }
            
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                creditDisplay.classList.add('hidden');
                return;
            }
            
            let totalCredit = 0;
            const checkedItems = form.querySelectorAll('input[name="returnItem"]:checked');
            
            checkedItems.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const item = invoice.items[index];
                const qtyInput = form.querySelector(`[name="returnQty_${index}"]`);
                const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
                
                if (qty > 0 && qty <= item.qty) {
                    totalCredit += item.price * qty;
                }
            });
            
            const creditAmountEl = document.getElementById('exchangeCreditAmount');
            if (creditAmountEl) {
                creditAmountEl.textContent = formatCurrency(totalCredit);
            }
            
            if (totalCredit > 0) {
                creditDisplay.classList.remove('hidden');
            } else {
                creditDisplay.classList.add('hidden');
            }
        }

        function processReturnExchange(form, isFromPOS = false, modalElement = null) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            const invoiceId = form.invoiceId.value;
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const type = form.type.value;
            
            if (!invoice) {
                alert('Invoice not found!');
                return;
            }
            
            const returnItems = [];
            let total = 0;
            const checkedItems = form.querySelectorAll('input[name="returnItem"]:checked');
            
            if (checkedItems.length === 0) {
                alert('Please select at least one item to return');
                return;
            }
            
            checkedItems.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const item = invoice.items[index];
                const qty = parseInt(form.querySelector(`[name="returnQty_${index}"]`).value) || item.qty;
                const reason = form.querySelector(`[name="reason_${index}"]`).value;
                
                if (qty > 0 && qty <= item.qty) {
                    returnItems.push({
                        name: item.name,
                        qty: qty,
                        price: item.price,
                        reason: reason
                    });
                    total += item.price * qty;
                }
            });
            
            if (returnItems.length === 0) {
                alert('Please select valid items to return');
                return;
            }
            
            const newReturn = {
                id: `RET-${String(returns.length + 1).padStart(3, '0')}`,
                invoiceId: invoiceId,
                date: new Date().toISOString().split('T')[0],
                customer: invoice.customer,
                customerPhone: invoice.customerPhone || '',
                customerEmail: invoice.customerEmail || '',
                items: returnItems,
                total: total,
                status: isFromPOS ? 'completed' : 'pending', // Mark as completed if from POS
                type: type,
                payment: isFromPOS ? 'Credit Applied' : 'N/A'
            };
            
            returns.push(newReturn);
            localStorage.setItem('returns', JSON.stringify(returns));
            
            // If from POS, handle return and exchange differently
            if (isFromPOS) {
                // Update inventory - add items back to stock
                returnItems.forEach(retItem => {
                    const product = products.find(p => p.name === retItem.name);
                    if (product) {
                        product.stock += retItem.qty;
                    }
                });
                localStorage.setItem('products', JSON.stringify(products));
                
                if (type === 'return') {
                    // For RETURN: Generate credit note invoice and print it
                    generateAndPrintCreditNote(newReturn, invoice);
                    
                    // Don't apply credit to new order for returns - credit note is separate
                    // Clear any existing exchange credit
                    store.setState({ 
                        exchangeCredit: 0,
                        currentReturnId: null
                    });
                } else {
                    // For EXCHANGE: Apply credit to current order (existing behavior)
                    store.setState({ 
                        exchangeCredit: total,
                        currentReturnId: newReturn.id
                    });
                }
                
                // Close modal immediately before rendering
                if (modalElement) {
                    modalElement.remove();
                } else {
                    // Fallback: try to find and close modal
                    const modal = document.querySelector('.modal-backdrop');
                    if (modal) modal.remove();
                }
                
                // Stay on POS page and render to show updated amount
                store.render();
            } else {
                // Close modal for non-POS flows
                if (modalElement) {
                    modalElement.remove();
                } else {
                    const modal = document.querySelector('.modal-backdrop');
                    if (modal) modal.remove();
                }
                alert(`${type === 'return' ? 'Return' : 'Exchange'} ${newReturn.id} created successfully!`);
                store.navigate('inventory');
            }
        }

        function completeReturn(retId) {
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const ret = returns.find(r => r.id === retId);
            
            if (!ret) return;
            
            // Update inventory - add items back to stock
            ret.items.forEach(retItem => {
                const product = products.find(p => p.name === retItem.name);
                if (product) {
                    product.stock += retItem.qty;
                }
            });
            
            ret.status = 'completed';
            localStorage.setItem('returns', JSON.stringify(returns));
            localStorage.setItem('products', JSON.stringify(products));
            alert(`Return ${retId} completed! Inventory updated.`);
            store.navigate('inventory');
        }

        function setReportFilter(filterName, value) {
            const currentFilters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // If quick filter is set, clear date range
            if (filterName === 'quickFilter' && value !== 'all') {
                currentFilters.dateFrom = '';
                currentFilters.dateTo = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
            }
            
            // If date range is set, clear quick filter
            if ((filterName === 'dateFrom' || filterName === 'dateTo') && value) {
                currentFilters.quickFilter = 'all';
                document.getElementById('quickFilter').value = 'all';
            }
            
            currentFilters[filterName] = value;
            store.setState({ reportFilters: currentFilters });
            localStorage.setItem('reportFilters', JSON.stringify(currentFilters));
            store.navigate('reports');
        }

        function clearReportFilters() {
            const defaultFilters = {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            store.setState({ reportFilters: defaultFilters });
            localStorage.setItem('reportFilters', JSON.stringify(defaultFilters));
            store.navigate('reports');
        }

        function setInvoiceFilter(filterName, value) {
            const currentFilters = store.getState().invoiceFilters || {
                search: '',
                dateFrom: '',
                dateTo: '',
                customer: '',
                paymentMethod: '',
                amountMin: '',
                amountMax: '',
                quickFilter: 'all'
            };
            
            // If quick filter is set, clear date range
            if (filterName === 'quickFilter' && value !== 'all') {
                currentFilters.dateFrom = '';
                currentFilters.dateTo = '';
                document.getElementById('invoiceDateFrom').value = '';
                document.getElementById('invoiceDateTo').value = '';
            }
            
            // If date range is set, clear quick filter
            if ((filterName === 'dateFrom' || filterName === 'dateTo') && value) {
                currentFilters.quickFilter = 'all';
                document.getElementById('invoiceQuickFilter').value = 'all';
            }
            
            currentFilters[filterName] = value;
            store.setState({ invoiceFilters: currentFilters });
            localStorage.setItem('invoiceFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearInvoiceFilters() {
            const defaultFilters = {
                search: '',
                dateFrom: '',
                dateTo: '',
                customer: '',
                paymentMethod: '',
                amountMin: '',
                amountMax: '',
                quickFilter: 'all'
            };
            store.setState({ invoiceFilters: defaultFilters });
            localStorage.setItem('invoiceFilters', JSON.stringify(defaultFilters));
            render();
        }

        function exportInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const filters = store.getState().invoiceFilters || {
                search: '',
                dateFrom: '',
                dateTo: '',
                customer: '',
                paymentMethod: '',
                amountMin: '',
                amountMax: '',
                quickFilter: 'all'
            };
            
            // Apply same filters as in InvoicesPage
            let filteredInvoices = [...invoices];
            
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                if (filters.quickFilter === 'today') {
                    filteredInvoices = filteredInvoices.filter(inv => inv.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= weekAgo && invDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= monthAgo && invDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredInvoices = filteredInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= yearAgo && invDate <= today;
                    });
                }
            }
            
            if (filters.dateFrom) filteredInvoices = filteredInvoices.filter(inv => inv.date >= filters.dateFrom);
            if (filters.dateTo) filteredInvoices = filteredInvoices.filter(inv => inv.date <= filters.dateTo);
            if (filters.customer) filteredInvoices = filteredInvoices.filter(inv => inv.customer === filters.customer);
            if (filters.paymentMethod) filteredInvoices = filteredInvoices.filter(inv => inv.payment === filters.paymentMethod);
            if (filters.amountMin) filteredInvoices = filteredInvoices.filter(inv => inv.total >= parseFloat(filters.amountMin));
            if (filters.amountMax) filteredInvoices = filteredInvoices.filter(inv => inv.total <= parseFloat(filters.amountMax));
            
            if (filters.search && filters.search.trim()) {
                const searchTerm = filters.search.toLowerCase().trim();
                filteredInvoices = filteredInvoices.filter(inv => {
                    return inv.id.toLowerCase().includes(searchTerm) ||
                           inv.customer.toLowerCase().includes(searchTerm) ||
                           inv.date.includes(searchTerm) ||
                           (inv.customerPhone && inv.customerPhone.includes(searchTerm)) ||
                           (inv.customerEmail && inv.customerEmail.toLowerCase().includes(searchTerm)) ||
                           inv.items.some(item => item.name.toLowerCase().includes(searchTerm));
                });
            }
            
            // Create CSV content
            let csv = 'Invoice ID,Date,Customer,Customer Phone,Customer Email,Items,Subtotal,Discount,Tax,Total,Payment Method\n';
            filteredInvoices.forEach(inv => {
                const items = inv.items.map(item => `${item.name} (${item.qty}x)`).join('; ');
                csv += `${inv.id},${inv.date},"${inv.customer}","${inv.customerPhone || ''}","${inv.customerEmail || ''}","${items}",${inv.subtotal || inv.total},${inv.discount || 0},${inv.tax || 0},${inv.total},${inv.payment}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoices-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`Exported ${filteredInvoices.length} invoices to CSV!`);
        }

        function setInventoryFilter(filterName, value) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: ''
            };
            currentFilters[filterName] = value;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearPOFilters() {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.poStatus = '';
            currentFilters.poDateFrom = '';
            currentFilters.poDateTo = '';
            currentFilters.poSupplier = '';
            currentFilters.poSearch = '';
            // Clear search input
            const searchInput = document.getElementById('poSearch');
            if (searchInput) searchInput.value = '';
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function clearReturnFilters() {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.returnStatus = '';
            currentFilters.returnType = '';
            currentFilters.returnDateFrom = '';
            currentFilters.returnDateTo = '';
            currentFilters.returnSearch = '';
            // Clear search input
            const searchInput = document.getElementById('returnSearch');
            if (searchInput) searchInput.value = '';
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function filterPurchaseOrders(searchTerm) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.poSearch = searchTerm;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function filterReturnsExchanges(searchTerm) {
            const currentFilters = store.getState().inventoryFilters || {
                poStatus: '',
                poDateFrom: '',
                poDateTo: '',
                poSupplier: '',
                poAmountMin: '',
                poAmountMax: '',
                poSearch: '',
                returnStatus: '',
                returnType: '',
                returnDateFrom: '',
                returnDateTo: '',
                returnCustomer: '',
                returnAmountMin: '',
                returnAmountMax: '',
                returnSearch: ''
            };
            currentFilters.returnSearch = searchTerm;
            store.setState({ inventoryFilters: currentFilters });
            localStorage.setItem('inventoryFilters', JSON.stringify(currentFilters));
            render();
        }

        function exportSlowMovingStock() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            // Calculate slow-moving products (same logic as InventoryPage)
            const today = new Date();
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setDate(today.getDate() - 90);
            
            const recentSales = {};
            invoices.forEach(inv => {
                const invDate = new Date(inv.date);
                if (invDate >= ninetyDaysAgo) {
                    inv.items.forEach(item => {
                        if (!recentSales[item.name]) {
                            recentSales[item.name] = 0;
                        }
                        recentSales[item.name] += item.qty;
                    });
                }
            });
            
            const slowMovingProducts = products.filter(product => {
                const hasRecentSales = recentSales[product.name] > 0;
                return !hasRecentSales && product.stock > 0;
            }).map(product => ({
                ...product,
                stockValue: product.stock * product.price
            }));
            
            // Create CSV content
            let csv = 'Product Name,SKU,Category,Current Stock,Unit Price,Stock Value,Status\n';
            slowMovingProducts.forEach(product => {
                csv += `"${product.name}","${product.sku}","${product.category}",${product.stock},${product.price.toFixed(2)},${product.stockValue.toFixed(2)},"Not Moving"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `slow-moving-stock-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`Exported ${slowMovingProducts.length} slow-moving products to CSV!`);
        }

        function exportAllStockData() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const searchInput = document.getElementById('stockSearch');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            // Filter products if search term exists
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.sku.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm) ||
                    p.barcode.includes(searchTerm)
                );
            }
            
            // Create CSV content
            let csv = 'Product Name,SKU,Category,Current Stock,Unit Price,Stock Value,Barcode,Status\n';
            filteredProducts.forEach(product => {
                const stockValue = product.stock * product.price;
                const stockStatus = product.stock === 0 ? 'Out of Stock' : product.stock < 10 ? 'Low Stock' : 'In Stock';
                csv += `"${product.name}","${product.sku}","${product.category}",${product.stock},${product.price.toFixed(2)},${stockValue.toFixed(2)},"${product.barcode}","${stockStatus}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = searchTerm ? `all-stock-data-filtered-${new Date().toISOString().split('T')[0]}.csv` : `all-stock-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.download = fileName;
            a.click();
            alert(`Exported ${filteredProducts.length} products to CSV!`);
        }

        function startPhysicalInventoryScan() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const physicalCounts = JSON.parse(localStorage.getItem('physicalInventoryCounts') || '{}');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Physical Inventory Count</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" style="background: var(--gray-200); padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; color: var(--gray-700);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2 font-semibold">Search/Scan Product</label>
                        <input type="text" id="physicalScanInput" placeholder="Enter product name, SKU, or scan barcode..." 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600"
                            onkeypress="if(event.key === 'Enter') { addPhysicalCount(); }"
                            autocomplete="off">
                    </div>
                    <div class="mb-6 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold mb-4 text-gray-800">Scanned Items</h3>
                        <div id="physicalCountList" class="space-y-2">
                            ${Object.entries(physicalCounts).map(([productId, count]) => {
                                const product = products.find(p => p.id == productId);
                                if (!product) return '';
                                const discrepancy = count - product.stock;
                                return `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${product.name}</div>
                                            <div class="text-sm text-gray-600">SKU: ${product.sku}</div>
                                        </div>
                                        <div class="text-right mr-4">
                                            <div class="text-sm text-gray-600">System: ${product.stock}</div>
                                            <div class="text-sm text-gray-600">Physical: <strong>${count}</strong></div>
                                            ${discrepancy !== 0 ? `
                                                <div class="text-sm font-bold ${discrepancy > 0 ? 'text-green-600' : 'text-red-600'}">
                                                    ${discrepancy > 0 ? '+' : ''}${discrepancy}
                                                </div>
                                            ` : '<div class="text-sm text-green-600">âœ“ Match</div>'}
                                        </div>
                                        <button onclick="removePhysicalCount('${productId}')" class="btn" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 14px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                            }).join('') || '<p class="text-gray-500 text-center py-4">No items scanned yet. Start scanning products above.</p>'}
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="completePhysicalInventory()" class="flex-1 btn-primary" style="padding: 12px; border-radius: 10px; font-weight: 600;">
                            <i class="fas fa-check mr-2"></i>Complete Audit
                        </button>
                        <button onclick="clearPhysicalInventory()" class="btn" style="background: var(--gray-200); color: var(--gray-700); padding: 12px; border-radius: 10px; font-weight: 600;">
                            <i class="fas fa-redo mr-2"></i>Clear All
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('physicalScanInput')?.focus();
            }, 100);
        }

        function addPhysicalCount() {
            const input = document.getElementById('physicalScanInput');
            const searchTerm = input.value.trim();
            if (!searchTerm) return;
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const product = products.find(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (p.barcode && p.barcode.includes(searchTerm))
            );
            
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            const physicalCounts = JSON.parse(localStorage.getItem('physicalInventoryCounts') || '{}');
            const currentCount = physicalCounts[product.id] || 0;
            physicalCounts[product.id] = currentCount + 1;
            localStorage.setItem('physicalInventoryCounts', JSON.stringify(physicalCounts));
            
            input.value = '';
            input.focus();
            
            document.querySelector('.modal-backdrop')?.remove();
            startPhysicalInventoryScan();
        }

        function removePhysicalCount(productId) {
            const physicalCounts = JSON.parse(localStorage.getItem('physicalInventoryCounts') || '{}');
            delete physicalCounts[productId];
            localStorage.setItem('physicalInventoryCounts', JSON.stringify(physicalCounts));
            
            document.querySelector('.modal-backdrop')?.remove();
            startPhysicalInventoryScan();
        }

        function clearPhysicalInventory() {
            if (!confirm('Clear all physical counts?')) return;
            localStorage.removeItem('physicalInventoryCounts');
            document.querySelector('.modal-backdrop')?.remove();
            startPhysicalInventoryScan();
        }

        function completePhysicalInventory() {
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const physicalCounts = JSON.parse(localStorage.getItem('physicalInventoryCounts') || '{}');
            
            const discrepancies = [];
            Object.entries(physicalCounts).forEach(([productId, physicalCount]) => {
                const product = products.find(p => p.id == productId);
                if (product) {
                    const systemCount = product.stock;
                    const difference = physicalCount - systemCount;
                    if (difference !== 0) {
                        discrepancies.push({
                            product,
                            systemCount,
                            physicalCount,
                            difference
                        });
                    }
                }
            });
            
            const resultsDiv = document.getElementById('physicalInventoryResults');
            const listDiv = document.getElementById('discrepancyList');
            
            if (resultsDiv && listDiv) {
                resultsDiv.classList.remove('hidden');
                if (discrepancies.length === 0) {
                    listDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
                            <p class="text-green-800 font-semibold">All items match! No discrepancies found.</p>
                        </div>
                    `;
                } else {
                    listDiv.innerHTML = discrepancies.map(d => `
                        <div class="border ${d.difference > 0 ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'} rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-semibold text-gray-800">${d.product.name}</div>
                                    <div class="text-sm text-gray-600">SKU: ${d.product.sku}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">System: <strong>${d.systemCount}</strong></div>
                                    <div class="text-sm text-gray-600">Physical: <strong>${d.physicalCount}</strong></div>
                                    <div class="text-lg font-bold ${d.difference > 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${d.difference > 0 ? '+' : ''}${d.difference}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${d.difference > 0 ? 'Extra items found' : 'Missing items - Possible theft!'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            document.querySelector('.modal-backdrop')?.remove();
            store.navigate('inventory');
        }

        function exportReport() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const returns = JSON.parse(localStorage.getItem('returns') || '[]');
            const filters = store.getState().reportFilters || {
                dateFrom: '',
                dateTo: '',
                paymentMethod: '',
                customer: '',
                orderType: 'all',
                quickFilter: 'all'
            };
            
            // Combine all transactions with type labels (same as ReportsPage)
            let allTransactions = [
                ...invoices.map(inv => ({ ...inv, transactionType: 'sale', typeLabel: 'Sale' })),
                ...purchaseOrders.map(po => ({ ...po, transactionType: 'purchase', typeLabel: 'Purchase', customer: po.supplier || 'N/A', payment: 'N/A', discount: 0, tax: 0 })),
                ...returns.map(ret => ({ ...ret, transactionType: 'return', typeLabel: ret.type === 'return' ? 'Return' : 'Exchange', payment: 'N/A', discount: 0, tax: 0 }))
            ];
            
            // Apply same filters as in ReportsPage
            let filteredTransactions = [...allTransactions];
            
            // Order type filter
            if (filters.orderType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.transactionType === filters.orderType);
            }
            
            if (filters.quickFilter !== 'all') {
                const today = new Date();
                if (filters.quickFilter === 'today') {
                    const todayStr = today.toISOString().split('T')[0];
                    filteredTransactions = filteredTransactions.filter(t => t.date === todayStr);
                } else if (filters.quickFilter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= weekAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= monthAgo && tDate <= today;
                    });
                } else if (filters.quickFilter === 'year') {
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredTransactions = filteredTransactions.filter(t => {
                        const tDate = new Date(t.date);
                        return tDate >= yearAgo && tDate <= today;
                    });
                }
            }
            
            if (filters.dateFrom) filteredTransactions = filteredTransactions.filter(t => t.date >= filters.dateFrom);
            if (filters.dateTo) filteredTransactions = filteredTransactions.filter(t => t.date <= filters.dateTo);
            if (filters.paymentMethod) filteredTransactions = filteredTransactions.filter(t => t.payment === filters.paymentMethod);
            
            // Create CSV content
            let csv = 'Type,ID,Customer/Supplier,Date,Items,Subtotal,Discount,Tax,Total,Payment\n';
            filteredTransactions.forEach(t => {
                const items = t.items.map(item => `${item.name} (${item.qty}x)`).join('; ');
                const customerSupplier = t.customer || t.supplier || 'N/A';
                const payment = t.payment && t.payment !== 'N/A' ? t.payment : '-';
                csv += `${t.typeLabel},${t.id},"${customerSupplier}",${t.date},"${items}",${t.subtotal || t.total},${t.discount || 0},${t.tax || 0},${t.total},${payment}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert('Report exported successfully!');
        }

        function exportTaxReport() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const settings = store.getState().settings;
            const taxRates = settings.taxRates || [];
            
            // Filter sales transactions
            const salesTransactions = invoices;
            
            // Calculate tax breakdown
            const taxByType = {};
            salesTransactions.forEach(t => {
                const taxAmount = t.tax || 0;
                const taxType = t.taxType || settings.defaultTaxType || 'gst';
                
                if (!taxByType[taxType]) {
                    taxByType[taxType] = { total: 0, count: 0, transactions: [] };
                }
                taxByType[taxType].total += taxAmount;
                taxByType[taxType].count += 1;
                taxByType[taxType].transactions.push({
                    id: t.id,
                    date: t.date,
                    customer: t.customer,
                    taxable: t.subtotal || t.total - taxAmount,
                    tax: taxAmount,
                    total: t.total
                });
            });
            
            // Create CSV content
            let csv = 'Tax Report\n';
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            csv += 'Tax Summary by Type\n';
            csv += 'Tax Type,Rate,Transactions,Total Tax Collected,Taxable Amount\n';
            
            taxRates.forEach(tax => {
                const data = taxByType[tax.type] || { total: 0, count: 0, transactions: [] };
                const taxable = data.transactions.reduce((sum, t) => sum + t.taxable, 0);
                csv += `${tax.name},${tax.rate}%,${data.count},${data.total.toFixed(2)},${taxable.toFixed(2)}\n`;
            });
            
            csv += '\nDetailed Transaction List\n';
            csv += 'Invoice ID,Date,Customer,Taxable Amount,Tax Amount,Total,Tax Type\n';
            
            salesTransactions.forEach(t => {
                const taxType = t.taxType || settings.defaultTaxType || 'gst';
                const taxName = taxRates.find(tr => tr.type === taxType)?.name || 'Tax';
                const taxable = t.subtotal || t.total - (t.tax || 0);
                csv += `${t.id},${t.date},"${t.customer}",${taxable.toFixed(2)},${(t.tax || 0).toFixed(2)},${t.total.toFixed(2)},${taxName}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert('Tax report exported successfully!');
        }

        let dateTimeInterval = null;

        function handleDashboardSearch(event) {
            if (event.key === 'Enter') {
                const searchInput = document.getElementById('dashboardProductSearch');
                const searchTerm = searchInput.value.trim();
                
                if (searchTerm) {
                    // Store search term to use in POS page
                    sessionStorage.setItem('posSearchTerm', searchTerm);
                    // Navigate to POS checkout page
                    store.navigate('pos');
                }
            }
        }

        function handleDashboardSearchClick() {
            const searchInput = document.getElementById('dashboardProductSearch');
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm) {
                // Store search term to use in POS page
                sessionStorage.setItem('posSearchTerm', searchTerm);
                // Navigate to POS checkout page
                store.navigate('pos');
            } else {
                // If empty, just navigate to POS page
                store.navigate('pos');
            }
        }

        function updateDashboardDateTime() {
            const dateElement = document.getElementById('dashboardDate');
            const timeElement = document.getElementById('dashboardTime');
            
            if (dateElement && timeElement) {
                const now = new Date();
                
                // Format date: Monday, December 16, 2024
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
                
                // Format time: HH:MM:SS AM/PM
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                timeElement.textContent = now.toLocaleTimeString('en-US', timeOptions);
            }
        }

        function render() {
            try {
                const state = store.getState();
                let html = '';
                if (!state.isLoggedIn) {
                    switch (state.currentPage) {
                        case 'features': html = FeaturesPage(); break;
                        case 'pricing': html = PricingPage(); break;
                        case 'about': html = AboutPage(); break;
                        case 'contact': html = ContactPage(); break;
                        default: html = HomePage();
                    }
                } else {
                    switch (state.currentPage) {
                        case 'dashboard': html = Dashboard(); break;
                        case 'pos': html = POSPage(); break;
                        case 'products': html = ProductsPage(); break;
                        case 'inventory': html = InventoryPage(); break;
                        case 'customers': html = CustomersPage(); break;
                        case 'invoices': html = InvoicesPage(); break;
                        case 'reports': html = ReportsPage(); break;
                        case 'campaigns': html = CampaignsPage(); break;
                        case 'settings': html = SettingsPage(); break;
                        default: html = Dashboard();
                    }
                }
                const appElement = document.getElementById('app');
                if (appElement) {
                    appElement.innerHTML = html;
                } else {
                    console.error('App element not found');
                }
            
            // Update date and time if on dashboard
            if (state.isLoggedIn && state.currentPage === 'dashboard') {
                // Clear existing interval if any
                if (dateTimeInterval) {
                    clearInterval(dateTimeInterval);
                }
                updateDashboardDateTime();
                // Update time every second
                dateTimeInterval = setInterval(updateDashboardDateTime, 1000);
            } else {
                // Clear interval when not on dashboard
                if (dateTimeInterval) {
                    clearInterval(dateTimeInterval);
                    dateTimeInterval = null;
                }
            }
            
            // Handle search term from dashboard to POS
            if (state.isLoggedIn && state.currentPage === 'pos') {
                const searchTerm = sessionStorage.getItem('posSearchTerm');
                if (searchTerm) {
                    const posSearchInput = document.getElementById('productSearch');
                    if (posSearchInput) {
                        posSearchInput.value = searchTerm;
                        // Trigger search filter
                        try {
                            filterProducts(searchTerm);
                        } catch (filterError) {
                            console.warn('Error filtering products:', filterError);
                        }
                        // Clear the stored search term
                        sessionStorage.removeItem('posSearchTerm');
                    }
                }
            }
            } catch (error) {
                console.error('Error in render function:', error);
                // Try to at least show an error message
                const appElement = document.getElementById('app');
                if (appElement) {
                    appElement.innerHTML = '<div style="padding: 20px; text-align: center;"><h2>Error loading page</h2><p>Please refresh the page.</p></div>';
                }
            }
        }

        store.subscribe(render);
        render();

        // Offline Mode Support
        let isOnline = navigator.onLine;
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

        // Update online status indicator
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('offlineStatusIndicator');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2';
                    statusIndicator.innerHTML = '<i class="fas fa-wifi"></i> Online';
                    setTimeout(() => statusIndicator.remove(), 3000);
                } else {
                    statusIndicator.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2';
                    statusIndicator.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline Mode';
                }
            }
        }

        // Create status indicator
        function createStatusIndicator() {
            if (!document.getElementById('offlineStatusIndicator')) {
                const indicator = document.createElement('div');
                indicator.id = 'offlineStatusIndicator';
                document.body.appendChild(indicator);
                updateOnlineStatus();
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            isOnline = true;
            createStatusIndicator();
            updateOnlineStatus();
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            createStatusIndicator();
            updateOnlineStatus();
        });

        // Sync offline data when back online
        function syncOfflineData() {
            if (offlineQueue.length > 0 && isOnline) {
                // In a real application, this would sync with a server
                // For now, we'll just clear the queue and show a message
                const count = offlineQueue.length;
                offlineQueue = [];
                localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                if (count > 0) {
                    alert(`${count} offline transaction(s) have been processed. All data is saved locally.`);
                }
            }
        }

        // Initialize offline status
        createStatusIndicator();
        updateOnlineStatus();

        // Service Worker Registration for Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker registration failed (expected in local file system)
                    // This is normal when running from file:// protocol
                    console.log('Service Worker not available (running locally)');
                });
            });
        }

        // Enhanced localStorage with offline queue
        const originalSetItem = Storage.prototype.setItem;
        Storage.prototype.setItem = function(key, value) {
            originalSetItem.call(this, key, value);
            if (!isOnline && (key === 'invoices' || key === 'products' || key === 'customers')) {
                offlineQueue.push({
                    key,
                    value,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            }
        };
    </script>
</body>
</html>
